---
title: å…¨å±€ç¼“å­˜å¯¼è‡´çš„ Node.js çº¿ä¸Šå†…å­˜æ³„æ¼
date: 2023/6/8
description: è¿™ä¸¤ä¸ªé—®é¢˜æ²¡æœ‰ä»»ä½•ç›¸å…³æ€§, ç¢äºç¯‡å¹…åŸå› å°±è®°å½•åœ¨ä¸€ç¯‡æ–‡ç« ä¸­äº†
tag: Node.js
author: å¤šå°å‡¯
---

![image](https://github.com/xiaoxiaojx/blog/assets/23253540/07760205-1a2f-4861-bbc8-85185c10f6d7)

## èƒŒæ™¯
M åŒå­¦åæ˜ è‡ªå·±è´Ÿè´£çš„ [Next.js](https://github.com/vercel/next.js) é¡¹ç›®ç–‘ä¼¼å†…å­˜æ³„æ¼, ä¸´è¿‘ 618 éœ€è¦å°½å¿«è§£å†³! é€šè¿‡æŸ¥çœ‹ [Easy-Monitor](https://github.com/hyj1991/easy-monitor) ä¸Šçš„ã€Œå †å†…å­˜è¶‹åŠ¿ã€æ›²çº¿ğŸ“ˆåœ¨ä¸€ç›´ä¸Šæ¶¨ä¸”ä¸ä¼šä¸‹é™å°±åŸºæœ¬ç¡®å®šäº†æ˜¯å†…å­˜æ³„æ¼

## é—®é¢˜æ’æŸ¥
M åŒå­¦ä¹Ÿè¿…é€Ÿå®šä½åˆ°äº†é€ æˆå†…å­˜æ³„æ¼çš„ commit, æˆ‘ä»”ç»† review äº†ä¸€ä¸‹å¹¶æ²¡æœ‰å‘ç°å…¨å±€å˜é‡ç¼“å­˜ã€é—­åŒ…å¼•ç”¨ç­‰é«˜å±æ“ä½œ

### Easy-Monitor ä¸‹è½½å¿«ç…§

æ¥ç€å°±åªèƒ½ä» Easy-Monitor ä¸Šé—´éš”ä¸€æ®µæ—¶é—´å‰åä¸‹è½½äº†ä¸¤ä¸ªå †å¿«ç…§ï¼Œæœ€åé€šè¿‡ Chrome Devtool Memory é¢æ¿çš„ Comparison åŠŸèƒ½è¿›è¡Œå¯¹æ¯”, å‘ç° `StyleRule` å¯¹è±¡å‡€æ–°å¢äº† 57042 ä¸ª!

![image](https://github.com/xiaoxiaojx/blog/assets/23253540/8bfc218b-1fe5-4194-aad7-4da94cb3724b)

>è¿™é‡Œçš„ä¸€ä¸ªå°æŠ€å·§æ˜¯ä¸è¦æ€»ç›¯ç€ç¢ç‰‡åŒ–çš„`(array)`ã€`Object`ã€`(string)`ä»¥åŠç³»ç»Ÿçš„`(system)`ã€`system / Context` ç­‰å¯¹è±¡çš„å†…å­˜å˜åŒ–, è¿™äº›å¯¹è±¡æ—¢ä¸å¥½å®šä½åˆä¸å®¹æ˜“çœ‹æ‡‚, å®ƒä»¬é€šå¸¸åªæ˜¯æŸä¸ªå¯¹è±¡çš„å±æ€§å€¼, å—å…¶ä»–å¯¹è±¡çš„æ³„æ¼è€Œå¢é•¿å¯èƒ½æ€§å¤§

> æ‰€æœ‰æˆ‘ä»¬éœ€è¦***ä¼˜å…ˆå…³æ³¨ App åº”ç”¨ä¸­ä½¿ç”¨åˆ°çš„å¯¹è±¡***, æ¯”å¦‚ä¸Šå›¾ä¸­åªåœ¨è¯¥é¡¹ç›®ä¸­å‡ºç°çš„ `StyleRule` å¯¹è±¡

### ä½¿ç”¨ devtoolx åˆ†æ
Chrome Devtool Memory é¢æ¿ä¸èƒ½å¤Ÿæ¸…æ™°çš„çœ‹å‡º `StyleRule` å¯¹è±¡çš„å¼•ç”¨å…³ç³», æ¨èå¤§å®¶ä½¿ç”¨å¼€æºçš„ [devtoolx](https://github.com/noslate-project/devtoolx) è¿›è¡Œä¸‹ä¸€æ­¥çš„åˆ†æ
```bash
npm install devtoolx -g

devtoolx -s <heapsnapshot file> [-p <port>]
```
å°´å°¬çš„æ˜¯å¼€å§‹è·‘ devtoolx å‘½ä»¤æ—¶é‡è§äº†ä¸‹é¢çš„æŠ¥é”™
![image](https://github.com/xiaoxiaojx/blog/assets/23253540/0cad0bb8-72ae-4a68-bafd-ceba43802108)
å¥½å§, æˆ‘è¿˜æ˜¯ä½¿ç”¨ [lldb](https://lldb.llvm.org/) å…ˆå®šä½ devtoolx å¯åŠ¨å¤±è´¥çš„é—®é¢˜, ç»“æœå‘ç°é€šè¿‡ lldb å¯åŠ¨ devtoolx åˆèƒ½å¤Ÿæ­£å¸¸è·‘èµ·æ¥

æ­¤æ—¶æˆ‘æ’é™¤äº† devtoolx ä¸èƒ½è¯†åˆ«è¯¥ v8 ç‰ˆæœ¬çš„ .heapsnapshot æ–‡ä»¶ä»¥åŠç³»ç»Ÿè°ƒç”¨ api å…¼å®¹æ€§é—®é¢˜ï¼ˆæ¾äº†å£æ°”, è¿˜æ˜¯èƒ½ç”¨ devtoolx ğŸ˜„ï¼‰
```bash
lldb -- /usr/local/bin/node /usr/local/bin/devtoolx -s /Users/duoxiaokai/Downloads/u-b259269e-6bd4-4336-8fc6-f04478496a47-u-x-heapdump-27-20230606-738634.heapsnapshot
```
çœ‹äº†ä¸€ä¸‹ devtoolx çš„ä»£ç , çŒœæƒ³å¯èƒ½æ˜¯æ‰“å¼€ .heapsnapshot æ–‡ä»¶å¤±è´¥äº†, äºæ˜¯å¢åŠ äº†å¦‚ä¸‹ä»£ç å†ç¼–è¯‘è¿è¡Œæ—¥å¿—æ˜¾ç¤º `ParseError: Operation not permitted`
```diff
    std::ifstream jsonfile(parser->filename_);
+    if (!jsonfile.is_open()) {
+      std::cout << "\nfailed to open " << parser->filename_ << '\n';
+      std::cerr << "ParseError: " << strerror(errno);
+      std::exit(1);
+      return;
+    }
    json profile;
    jsonfile >> profile;
```
æ‰€ä»¥æŠŠ .heapsnapshot æ–‡ä»¶ä» Downloads ç›®å½•ç§»äº†å‡ºæ¥å°±æ„‰å¿«çš„è·‘äº†èµ·æ¥, ä¸Šé¢çš„ä»£ç ä¹Ÿæäº¤äº†ä¸€ä¸ª [devtoolx/pull/18/](https://github.com/noslate-project/devtoolx/pull/18/files), æœ€åä½œè€…å‘å¸ƒäº† `devtoolx@1.0.2` ç‰ˆæœ¬ â¤ï¸
![image](https://github.com/xiaoxiaojx/blog/assets/23253540/2eeaf875-140c-43c2-a6a8-40b9be09738c)
![image](https://github.com/xiaoxiaojx/blog/assets/23253540/80588606-0969-45d8-a3ca-9bef35b60b2c)
å›å½’æ­£é¢˜, é€šè¿‡ devtoolx åˆ†åˆ«å¯¹ä¸¤ä¸ªå¿«ç…§åˆ†æå‘ç°äº†
1. ç”±äº `StyleRule` å¯¹è±¡ä¸æ–­çš„æ–°å¢, å…¶æœ€ä¸Šå±‚çš„çˆ¶å¯¹è±¡ `Object(674385)` ç”± 1.34MB æ¶¨åˆ°äº† 34.95 MB
2. `StyleRule` å¯¹è±¡çš„å¼•ç”¨å…³ç³»æ˜¯ `StyleSheet.RuleList.xxx.StyleRule`

### å®šä½æ³„æ¼ç‚¹
æ ¹æ®å¼•ç”¨å…³ç³»å®šä½åˆ°äº† npm åŒ… [jss](https://cssinjs.org/?v=v10.10.0) çš„ä»£ç , æ³¨æ„ä¸€ä¸‹ä¹‹å‰é€šè¿‡ Chrome Devtool Memory é¢æ¿å‘ç°å…¶çˆ¶å¯¹è±¡ `StyleSheet` ä¸ `RuleList` å¯¹è±¡çš„æ•°é‡æ˜¯æ²¡æœ‰æ–°å¢

æ‰€ä»¥æˆ‘ä»¬ç¼©å°èŒƒå›´ç›´å‡» `RuleList` å¯¹è±¡åœ¨ä½•ç§æƒ…å†µä¼šæ–°å¢å­å¯¹è±¡ `StyleRule` å³å¯

äºæ˜¯ä¹å‘ç° `RuleList` å¯¹è±¡çš„ register å‡½æ•°æ¯è°ƒç”¨ä¸€æ¬¡ä¼šåœ¨ `this.map` å¯¹è±¡ä¸ŠæŒ‚è½½ä¸€ä¸ª `StyleRule` å¯¹è±¡, è¿™å¦¥å¦¥çš„æ˜¯ç¼“å­˜æ³„æ¼å•Š ? 
![image](https://github.com/xiaoxiaojx/blog/assets/23253540/73f127ec-b372-4a40-8d48-cf6f4473167e)

å½“æˆ‘æœ¬åœ°è¿è¡Œè¯¥é¡¹ç›®ä¹Ÿæ˜¯å°è¯äº† `Object.keys(this.map).length` ä¸€ç›´åœ¨å¢é•¿

## é—®é¢˜åˆ†æ
ä½ å’Œæˆ‘è¯´ä¸€ä¸ªè¾ƒä¸ºæµè¡Œçš„ä»“åº“ [cssinjs/jss](https://github.com/cssinjs/jss) ä¼šå†…å­˜æ³„æ¼æˆ‘æ˜¯ä¸å¤ªä¼šç›¸ä¿¡, è‡³å°‘å¯èƒ½æ€§å¾ˆå°, å¤§æ¦‚ç‡è¿˜æ˜¯ä¸šåŠ¡é¡¹ç›®çš„ä½¿ç”¨å§¿åŠ¿æœ‰é—®é¢˜

è®©æˆ‘ä»¬çœ‹çœ‹å®˜æ–¹ç»™çš„ Server-Side Rendering ä½¿ç”¨çš„ demo, demo ä»£ç å¾ˆå®¹æ˜“çŒœæƒ³åˆ°è¯¥ä»£ç çš„ç›®çš„, å³æ¯ä¸€æ¬¡è°ƒç”¨ render å‡½æ•°éœ€è¦å…ˆ `new SheetsRegistry()`, ç„¶åé€šè¿‡ `JssProvider` ä¼ é€’ç»™å­å­™ç»„ä»¶è¿›è¡Œä¾èµ–æ”¶é›†ã€‚renderToString å‡½æ•°è¿è¡Œç»“æŸå³æ”¶é›†åˆ°äº†è¿è¡Œåˆ°çš„ç»„ä»¶éœ€è¦çš„æ ·å¼, æœ€åé€šè¿‡ `sheets.toString()` ç»™åå‡ºæ¥
> è¿™ä¸ªè¡Œä¸ºå’Œ [react-loadable](https://github.com/jamiebuilds/react-loadable#picking-up-a-server-side-rendered-app-on-the-client) æ”¶é›†åŠ¨æ€æ¨¡å—ä¸€æ¯›ä¸€æ · ~
```js
import React from 'react'
import {renderToString} from 'react-dom/server'
import {JssProvider, SheetsRegistry} from 'react-jss'
import Button from './Button'

export default function render() {
  const sheets = new SheetsRegistry()

  const app = renderToString(
    <JssProvider registry={sheets}>
      <Button />
    </JssProvider>
  )

  return '' +
`<!DOCTYPE html>
  <html>
  <head>
    <meta charset="utf-8">
    <title>Server-side rendering with rehydration</title>
    <link rel="stylesheet" href="../../example.css" />
    <style type="text/css" id="server-side-styles">
      ${sheets.toString()}
    </style>
  </head>
  <body>
    <a href="https://github.com/cssinjs/examples/tree/gh-pages/react-ssr" title="View on Github" class="github-fork-ribbon" target="_blank">View on Github</a>
    <div id="app">${app}</div>
    <script src="./app.js"></script>
  </body>
</html>`
}
```
è€Œ M åŒå­¦æœ¬æ¬¡åˆšå¥½ç”¨åˆ°äº†å†…éƒ¨ç»„ä»¶åº“äºŒæ¬¡å°è£…çš„ jss ç»„ä»¶, ç›¸å…³çš„ä»£ç æ˜¯è¿™æ ·
```js
exports.sheetsRegistry = new jss_1.SheetsRegistry();
```
è¿™æ ·ä¸²è”èµ·æ¥å°±èƒ½ç ´æ¡ˆäº†ã€‚å®˜æ–¹æ˜¯å¸Œæœ›æ¯æ¬¡è¯·æ±‚éƒ½æ–° new ä¸€ä¸ª `SheetsRegistry` è¿›è¡Œä¾èµ–æ”¶é›†, åœ¨ render å‡½æ•°ç»“æŸ `SheetsRegistry` å¯¹è±¡å‡ºäº†ä½œç”¨åŸŸå°±è¢« GC äº†ã€‚è€ŒäºŒæ¬¡å°è£…çš„ jss ç»„ä»¶å´å•ä¾‹åŒ–ç¼“å­˜äº†ä¸€ä¸ª `SheetsRegistry` å¯¹è±¡, å¯¼è‡´æ¯ä¸ªè¯·æ±‚éƒ½æ˜¯åŒä¸€ä¸ª SheetsRegistry å¯¹è±¡åœ¨æ”¶é›†ä¾èµ–ä¸”ç”±äºå…¨å±€å¼•ç”¨ä¸ä¼šè¢«é‡Šæ”¾é€ æˆäº†æœ¬æ¬¡çš„å†…å­˜æ³„æ¼