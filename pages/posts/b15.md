---
title: æœåŠ¡ç«¯æµå¼æ¸²æŸ“ iOS ä¸­è¸©å‘è®°
date: 2022/7/19
description: è¿‘æœŸ iOS å®¢æˆ·ç«¯åæ˜  WebView ä¸­æ‰“å¼€ h5 é¡µé¢å­˜åœ¨æ˜Žæ˜¾çš„ç™½å±æ—¶é—´
tag: SSR
author: You
---

è¿‘æœŸ iOS å®¢æˆ·ç«¯åæ˜  WebView ä¸­æ‰“å¼€ h5 é¡µé¢å­˜åœ¨æ˜Žæ˜¾çš„ç™½å±æ—¶é—´, äºŽæ˜¯æ‰“ç®—æŠŠåŽç«¯æŽ¥å£å»¶æ—¶é«˜ï¼ˆ> 150msï¼‰çš„ h5 é¡¹ç›®ç”±çŽ°åœ¨çš„ SSR æ”¹æˆ html è¯·æ±‚è¾¾åˆ° Node æ—¶çŽ‡å…ˆè¿”å›žæž„å»ºæ—¶ç”Ÿæˆçš„éª¨æž¶å± html ä¸»ä½“, ç„¶åŽå†å¼‚æ­¥è¯·æ±‚åŽç«¯æŽ¥å£æ•°æ®, èŽ·å–åˆ°æŽ¥å£æ•°æ®åŽå†è¿½åŠ åˆ° html å“åº”æµä¸­ã€‚è¿™æ · Node èƒ½å¤Ÿ 1ms å†…å“åº”å®žé™…å†…å®¹è®©ç”¨æˆ·å…ˆçœ‹åˆ°é¡µé¢æ¡†æž¶, é€šè¿‡å†…ç½‘å¹¶å‘èšåˆçš„æŽ¥å£æ•°æ®ä¹Ÿèƒ½è®©å®¢æˆ·ç«¯ç›´æŽ¥å¤ç”¨è¿™éƒ¨åˆ†æ•°æ®æ›´å¿«å±•ç¤ºå‡ºæœ€ç»ˆå±ã€‚

æŒ‰ç†æ¥è¯´ h5 ä¸å†å—é™äºŽåŽç«¯æŽ¥å£çš„å“åº”æ—¶é•¿, èƒ½å¤Ÿç¬¬ä¸€æ—¶é—´æ¸²æŸ“å‡ºéª¨æž¶å±é¡µé¢, ä½†æ˜¯ä½“éªŒåŽç™½å±æ—¶é—´å¥½åƒæ²¡æ€Žä¹ˆç¼©çŸ­? æœ€åŽåå¤åˆ å‡ä»£ç æµ‹è¯•å‘çŽ°äº†ä¸€ä¸ªæ®‹é…·çš„çŽ°å®ž ðŸ‘‡

~~iOS WKWebView ä¸æ”¯æŒæµå¼æ¸²æŸ“ï¼ˆåˆ†å—æ¸²æŸ“ï¼‰, å®‰å“ WebView ä¸Ž PC Chrome æ˜¯æ”¯æŒçš„ã€‚~~

~~å³è¡¨ç¤º IOS ä¸­ä¼šç­‰å¾… html è¯·æ±‚å½»åº•ç»“æŸåŽæ‰å¼€å§‹æ¸²æŸ“, å¦‚ä¸‹æ˜¯å®‰å“ä¸Ž IOS ä¸­çš„æ•ˆæžœæ¼”ç¤ºè§†é¢‘ï¼Œå¸Œæœ›å…¶ä»–åŒå­¦ä¸è¦å†è¸©å‘~~ ðŸ¤¯

https://user-images.githubusercontent.com/23253540/174447134-25daa11b-0be8-4330-85b7-e464c14f6047.mp4

https://user-images.githubusercontent.com/23253540/174447157-8ccc2be4-52fe-4d67-a11d-d4701677aa5d.mp4

---
2022-06-20 æ›´æ–°ï¼Œç»è¿‡å¤§ä½¬æé†’ï¼ŒIOS ä¸­å¦‚æžœè¿”å›žçš„ data æ˜¯æ™®é€šæ–‡æœ¬æ–‡å­—ï¼Œæˆ–è¿”å›žçš„æ•°æ®ä¸­åŒ…å«æ™®é€šæ–‡æœ¬æ–‡å­—ï¼Œé‚£åªéœ€è¦è¾¾åˆ°éžç©º 200 å­—èŠ‚å³å¯ä»¥è§¦å‘æ¸²æŸ“ï¼Œè¯¦ç»†è§ [iOSä¹‹æ·±å…¥è§£æžWKWebViewåŠ è½½çš„ç”Ÿå‘½å‘¨æœŸä¸Žä»£ç†æ–¹æ³•](https://bbs.huaweicloud.com/blogs/331397)

https://user-images.githubusercontent.com/23253540/174550696-cb3b54df-6db1-4aff-8adb-b60258461b20.mp4

***æ‰€ä»¥ IOS chrome ä¸Ž safari ä¹Ÿæ˜¯æ”¯æŒæµå¼æ¸²æŸ“ï¼ˆåˆ†å—æ¸²æŸ“ï¼‰ï¼ŒApp ä¸­æ²¡æœ‰æ•ˆæžœæ˜¯æœ‰æ•ˆå†…å®¹æ²¡æœ‰è¾¾åˆ° 200 å­—èŠ‚ (innerText)***

h5 é¡µé¢é¦–å±æ–‡å­—ç­‰å†…å®¹è¾¾åˆ° 200+ å­—èŠ‚è¿˜æ˜¯è¾ƒå°‘çš„ï¼Œè®¾ç½®ä¸º display: none æ¥å‡‘æ•°çš„ div ä¸ä¼šè¢«è®¡æ•°è¿›åŽ»ï¼Œç›¸å…³ä»£ç å®žçŽ°è§
```c
// https://github.com/WebKit/webkit/blob/main/Source/WebCore/page/FrameView.h#L975

static const unsigned visualCharacterThreshold = 200;
```
```c
// https://github.com/WebKit/WebKit/blob/ed7fed17c5ac886890859f1fc8682dba06424616/Source/WebCore/page/FrameView.cpp#L4685

void FrameView::checkAndDispatchDidReachVisuallyNonEmptyState()
{
// ...
// The first few hundred characters rarely contain the interesting content of the page.
        if (m_visuallyNonEmptyCharacterCount > visualCharacterThreshold)
            return true;
}

void FrameView::incrementVisuallyNonEmptyCharacterCount(const String& inlineText)
{
    if (m_visuallyNonEmptyCharacterCount > visualCharacterThreshold && m_hasReachedSignificantRenderedTextThreshold)
        return;

    auto nonWhitespaceLength = [](auto& inlineText) {
        auto length = inlineText.length();
        for (unsigned i = 0; i < inlineText.length(); ++i) {
            if (isNotHTMLSpace(inlineText[i]))
                continue;
            --length;
        }
        return length;
    };
    m_visuallyNonEmptyCharacterCount += nonWhitespaceLength(inlineText);
    ++m_textRendererCountForVisuallyNonEmptyCharacters;
}
```
---
2022-06-26 æ›´æ–°ï¼Œæœ€åŽç»™ body æ ‡ç­¾æ’å…¥äº†ä¸€ä¸ªå¡žäº† 200 ä¸ªç©ºæ ¼å­—ç¬¦çš„ div æ¥å¼ºåˆ¶ WKWebView è¿›è¡Œåˆ·æ–°ç¼“å­˜å®žæ—¶æ¸²æŸ“ï¼Œç»è¿‡ä¸€å‘¨å¤šçš„æµ‹è¯•ï¼Œç™½å±æ—¶é—´æ˜Žæ˜¾å‡å°‘ç”šè‡³ä¸è§ ðŸŽ‰
```js
const IOS_200 = `<div style="height:0;width:0;">\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b\u200b</div>`
```