---
title: webpack5 innerGraph ç®—æ³• bug å¯¼è‡´çš„é¡µé¢ç™½å±
date: 2023/2/7
description: âš ï¸ æˆªæ­¢ç›®å‰ webpack æœ€æ–°ç‰ˆæœ¬ 5.75.0 å­˜åœ¨çš„ bug
tag: webpack
author: å¤šå°å‡¯
---

<!-- vscode-markdown-toc -->

## ç›®å½•
* 1. [é—®é¢˜èƒŒæ™¯](#1)
* 2. [é—®é¢˜æ’æŸ¥](#2)
	* 2.1. [å¯èƒ½æ€§1: './reducer' æ–‡ä»¶æ²¡æœ‰ export default reducer?](#2.1)
	* 2.2. [å¯èƒ½æ€§2: å‡ºç°äº†å¾ªç¯å¼•ç”¨](#2.2)
	* 2.3. [å…¶ä»–å¯èƒ½æ€§](#2.3)
* 3. [é—®é¢˜è§£å†³](#3)
* 4. [æ·±å…¥é—®é¢˜](#4)

<!-- vscode-markdown-toc-config
	numbering=true
	autoSave=true
	/vscode-markdown-toc-config -->
<!-- /vscode-markdown-toc -->


![image](https://user-images.githubusercontent.com/23253540/217225679-ac08d20e-bf36-4d79-81bf-4f34bb907a7f.png)

> âš ï¸ æˆªæ­¢ç›®å‰ webpack æœ€æ–°ç‰ˆæœ¬ 5.75.0 å­˜åœ¨çš„ bug
##  1. <a name='1'></a>é—®é¢˜èƒŒæ™¯
M é¡¹ç›®æŠ€æœ¯æ”¹é€ æŠŠ webpack4 å‡çº§åˆ° webpack5, é¢„å‘ç¯å¢ƒéªŒæ”¶æ—¶å‘ç°ä¸€ä¸ªé¡µé¢ç™½å±äº†ï¼Œå¯ä»¥è¯´ç¦»ä¸Šçº¿åˆ°èƒŒäº‹æ•…å•ä»…å·®ä¸€æ­¥ âš ï¸

##  2. <a name='2'></a>é—®é¢˜æ’æŸ¥
ç»è¿‡ SourceMap åè§£å, æ‰¾åˆ°äº†æŠ¥é”™ä¿¡æ¯ `TypeError: (0 , i.ZP) is not a function` å¯¹åº”åˆ°çš„ npm åŒ…ä»£ç å¤„ã€‚å³å¦‚ä¸‹å›¾ reducer å‡½æ•°å°±æ˜¯ i.ZP ä»£ç ä¸‘åŒ–å‰çš„åå­—
```js
// index.js

import reducer, { getInitState, DEFAULT_PAGE_NUMBER, getDefaultLoading } from './reducer';

let usePagination = function (request, config) {
  // ..

  let _a = __read(useReducer(function (state, action) { return reducer(state, action, config); }, getDefaultState(configRef.current, cacheKey)), 2), rootState = _a[0], rootDispatch = _a[1];

  // ...
};
```
###  2.1. <a name='2.1'></a>å¯èƒ½æ€§1: './reducer' æ–‡ä»¶æ²¡æœ‰ export default reducer?
ç­”æ¡ˆæ˜¯å¦å®šçš„, å¦‚ä¸‹ä»£ç ç¡®å®æ˜¯å¯¼å‡ºäº† reducer å‡½æ•°
```js
// reducer.js

function reducer(state, action, config) {
    var _a;
    var cacheKey = action.payload.cacheKey;
    return __assign(__assign({}, state), (_a = {}, _a[cacheKey] = baseReducer(state[cacheKey], action, config), _a));
}

export default reducer;
```
###  2.2. <a name='2.2'></a>å¯èƒ½æ€§2: å‡ºç°äº†å¾ªç¯å¼•ç”¨
ç”±äºæœ¬æ¬¡ä»£ç çš„ diff æ¶‰åŠçš„ä¸šåŠ¡æ”¹åŠ¨åˆ°çš„æ–‡ä»¶æ•°é‡ä¸ package.json å‡çº§çš„ npm åŒ…æ•°é‡éƒ½è¿‡å¤š, é€šè¿‡äºŒåˆ†æ³•ä¹Ÿä¼šæ¶ˆè€—ä¸å°‘æ—¶é—´, äºæ˜¯å…ˆæç½®è¯¥æƒ…å†µçš„å¯èƒ½

###  2.3. <a name='2.3'></a>å…¶ä»–å¯èƒ½æ€§
æ¥ä¸‹æ¥å…ˆæŸ¥çœ‹ä¸€ä¸‹æ‰“åŒ…åçš„ reducer.js å¯¹åº”çš„ä»£ç æ¥æ‰¾åˆ°çªç ´å£, å…¶ä¸­æœ‰ç”¨çš„ä¿¡æ¯æ˜¯
1. e.ZP å³æ˜¯å‘å¯¼å‡ºå¯¹è±¡è¿›è¡Œèµ‹å€¼
2. å¦‚æœ`5224 == r.j`ä¸º false, é‚£ä¹ˆ e.ZP ä¸º null å°±ä¼šå¯¼è‡´æœ¬æ¬¡é—®é¢˜

***ç»“è®º: webpack ç¯¡æ”¹äº†ä»£ç , æ·»åŠ äº†ä¸€ä¸ªä¸‰å…ƒè¡¨è¾¾å¼å¯¼è‡´æ¡ä»¶ä¸æ»¡è¶³æ—¶å¯¼å‡ºä¸º null***
```js
{
  29971: function (t, e, r) {
    
    e.ZP =
      5224 == r.j
        ? function (t, e, r) {
            var i,
              o = e.payload.cacheKey;
            return n(n({}, t), (((i = {})[o] = m(t[o], e, r)), i));
          }
        : null;
  }
}
```
é‚£ä¹ˆå…³é”®çº¿ç´¢ä¸­ webpack æ·»åŠ çš„ r.j ç©¶ç«Ÿä»£è¡¨çš„æ˜¯ä»€ä¹ˆ ?

äºæ˜¯åœ¨æœ¬åœ°åˆ é™¤ TerserPlugin ç­‰ä»£ç ä¸‘åŒ–æ’ä»¶åè¿›è¡Œç”Ÿäº§æ‰“åŒ…, æ¥æŸ¥çœ‹ r.j ç›¸å…³çš„æ›´å¤šä¿¡æ¯ã€‚ä»æ‰“åŒ…åçš„ä»£ç çœ‹åˆ°çš„æœ‰ç”¨ä¿¡æ¯æ˜¯

1. r.j ä¸‘åŒ–å‰çš„åå­—æ˜¯ `__webpack_require__.j`
2. `__webpack_require__.j` æ—å¤šäº†æ³¨é‡Š `/* runtime-dependent pure expression or super */`
```js
{
  29971: (function(__unused_webpack_module, __webpack_exports__, __webpack_require__) {
    
    function reducer(state, action, config) {
      var _a;
      var cacheKey = action.payload.cacheKey;
      return __assign(__assign({}, state), (_a = {}, _a[cacheKey] = baseReducer(state[cacheKey], action, config), _a));
  }

  /* harmony default export */ __webpack_exports__["ZP"] = ((/* runtime-dependent pure expression or super */ 5224 == __webpack_require__.j ? (reducer) : null));
  )
}
```
æˆ‘ä»¬å…ˆæç½® r.j, ä»å¯ä»¥å…¨å±€æœç´¢åˆ°çš„æ³¨é‡Šå¼€å§‹æ’æŸ¥ã€‚å‘ç°æ˜¯ webpack çš„ PureExpressionDependency å¾€ä¸šåŠ¡ä»£ç ä¸­æ·»åŠ çš„æ³¨é‡Š, è€Œ PureXxx å°±å®¹æ˜“è”æƒ³åˆ°å¶å°”ä¼šçœ‹åˆ°çš„ `__PURE__` ç›¸å…³ API äº†

åœ¨ [webpack.js.org](https://webpack.js.org/) ä¸Šæœç´¢å…³é”®è¯`__PURE__`, å°±å®šä½åˆ°äº† webpack5 é»˜è®¤å¼€å¯çš„ä¸€é¡¹ä¼˜åŒ– [Inner-module tree-shaking](https://webpack.js.org/blog/2020-10-10-webpack-5-release/#inner-module-tree-shaking)

InnerGraph ç®—æ³•çš„æ ¸å¿ƒæ˜¯æ›´åŠ æ™ºèƒ½åŒ–çš„é…åˆ Tree Shaking, å®ƒè¯•å›¾åˆ†æä»£ç é—´çš„å¼•ç”¨å…³ç³»ã€‚æ¯”å¦‚ä½ åªæœ‰ä½¿ç”¨åˆ°äº†å¯¼å‡ºçš„ test å‡½æ•°, é‚£ä¹ˆ usingSomething å‡½æ•°å°†è¦è¢«ä¿ç•™, å³ something ä¹Ÿéœ€è¦ä¿ç•™ä¸‹æ¥
```js
import { something } from './something';

function usingSomething() {
  return something;
}

export function test() {
  return usingSomething();
}
```
##  3. <a name='3'></a>é—®é¢˜è§£å†³
è®¾ç½® [optimization.innerGraph](https://webpack.js.org/configuration/optimization/#optimizationinnergraph) ä¸º false æ¥éªŒè¯ä¸€ä¸‹æ˜¯å¦å› ä¸ºç®—æ³•åˆ†æå‡ºé”™å¯¼è‡´çš„æœ¬æ¬¡ç™½å±, å‘ç°è¯¥é¡µé¢æ¢å¤äº†æ­£å¸¸ âœ…
```diff
// webpack.config.js

module.exports = {
  //...
  optimization: {
+   innerGraph: false,
  },
};
```
> å…¶å®ä¹Ÿæ˜¯å› ä¸ºå®˜æ–¹æ–‡æ¡£æœ€åçš„è¿™å¥è­¦å‘Šè®©æˆ‘è§‰å¾—è¯¥ç®—æ³•æ¼æ´å¯èƒ½æ€§å¤§ ğŸ˜“

![image](https://user-images.githubusercontent.com/23253540/217280361-1eb12302-4c73-441c-8c1f-b29deeb47e20.png)
##  4. <a name='4'></a>æ·±å…¥é—®é¢˜
å³ç„¶ç¡®è®¤äº†æ˜¯ webpack5 é»˜è®¤å¼€å¯çš„ InnerGraph ç®—æ³•çš„ bug, é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç»§ç»­æ’æŸ¥å°è¯•ä¿®å¤ä¸€ä¸‹ç®—æ³•çš„é€»è¾‘æ¼æ´

é¦–å…ˆæ’æŸ¥ InnerGraph ç®—æ³•æ·»åŠ çš„ä¸‰å…ƒè¡¨è¾¾å¼ä¸ºä»€ä¹ˆä¸º false, å³ r.j å¯¹åº”çš„ `__webpack_require__.j` æ˜¯è¡¨ç¤ºä»€ä¹ˆ
```js
{
  29971: function (t, e, r) {
    
    e.ZP =
      5224 == r.j
        ? function (t, e, r) {
            var i,
              o = e.payload.cacheKey;
            return n(n({}, t), (((i = {})[o] = m(t[o], e, r)), i));
          }
        : null;
  }
}
```
å¦‚ä¸‹å›¾`__webpack_require__.j`çš„èµ‹å€¼å¯ä»¥å¾—å‡º, æ¯”å¦‚ M é¡¹ç›®æ˜¯ 10 ä¸ªé¡µé¢çš„å¤šé¡µé¡¹ç›® [Multi-Page Application](https://webpack.js.org/concepts/entry-points/#multi-page-application), æ‰“åŒ…åè‡³å°‘ä¼šäº§ç”Ÿ 10 ç»„ js é›†åˆ, ä¸€ä¸ªé›†åˆå¯¹åº”ä¸€ä¸ªé¡µé¢è¿è¡Œæ‰€éœ€è¦çš„ jsã€‚

runtime~xxx.js å³æ˜¯æŸä¸ªé¡µé¢åŠ è½½çš„ç¬¬ä¸€ä¸ª js, å®ƒä¼šç»™`__webpack_require__.j`èµ‹å€¼, å…¶åŠŸèƒ½æ˜¯è®¾ç½®å½“å‰è¿è¡Œçš„ js é›†åˆ id, ç±»ä¼¼äºä½œç”¨åŸŸçš„æ¦‚å¿µ
![image](https://user-images.githubusercontent.com/23253540/217249116-87bb19e1-e1e5-492c-a383-cff431450d10.png)

ç°åœ¨æˆ‘ä»¬çŒœæµ‹ç®—æ³•çš„é—®é¢˜å¯èƒ½å°±æ˜¯é—æ¼äº†ä¾èµ–çš„ js é›†åˆ, æ¯”å¦‚æŠŠ `5224 == r.j` ä¿®æ”¹ä¸º `[7327, 7069, 3233].includes(r.j)`, é‚£ä¹ˆ 7327, 7069, 3233 å¯¹åº”çš„3ä¸ªé¡µé¢åŠ è½½ reducer.js æ‰€å±çš„æ‰“åŒ…åçš„ js æ—¶å¯¼å‡ºå€¼å°±æ­£å¸¸, å…¶ä»–é¡µé¢å°±ä¼šä¸º null

åˆ°è¿™é‡Œæˆ‘ä»¬å¤§è‡´æ¸…æ¥šäº†é—®é¢˜çš„æ¥é¾™å»è„‰, äºæ˜¯ç»™ webpack æäº¤ä¸€ä¸ª [webpack/pull/16701](https://github.com/webpack/webpack/pull/16701) æ¥å°½å¿«ä¿®å¤ InnerGraph ç®—æ³•çš„é—®é¢˜