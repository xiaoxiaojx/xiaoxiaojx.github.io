---
title: Pod ä¸­è·å–åˆ°é”™è¯¯çš„ CPUS
date: 2022/1/6
description: åŒå­¦ a åœ¨ gitlab CI ä¸Šçš„å•æµ‹è¿è¡Œå¤±è´¥äº†, é”™è¯¯ä¿¡æ¯å¦‚ä¸‹
tag: webpack
author: You
---

![image](https://user-images.githubusercontent.com/23253540/148252866-56a65610-1587-4760-9922-0cfad8ec9994.png)

## èƒŒæ™¯
åŒå­¦ a åœ¨ gitlab CI ä¸Šçš„å•æµ‹è¿è¡Œå¤±è´¥äº†, é”™è¯¯ä¿¡æ¯å¦‚ä¸‹ã€‚äºæ˜¯ä»–æŒ‰ç…§ [jest/issues/8769](https://github.com/facebook/jest/issues/8769) çš„å»ºè®®ï¼Œåœ¨è¿è¡Œå•æµ‹çš„å‘½ä»¤ä¸ŠåŠ ä¸Šäº† --maxWorkers=2 çš„å‚æ•°ï¼Œå‘ç°ä¸æ­¢æ²¡æœ‰æŠ¥é”™äº†ï¼Œå•æµ‹è¿è¡Œçš„æ—¶é—´è¿˜å¿«äº† 5 å€ ?! æ‰€ä»¥è¯¢é—®æˆ‘è¿™æ˜¯å‘ç”Ÿäº†ä»€ä¹ˆåŒ–å­¦ååº”ğŸ¤”
```bash
  â— Test suite failed to run

    Call retries were exceeded

      at ChildProcessWorker.initialize (../node_modules/jest-worker/build/workers/ChildProcessWorker.js:193:21)
```

## jest --maxWorkers
![image](https://user-images.githubusercontent.com/23253540/148089622-90833963-d8f0-4bfe-ad60-b1f732a85e69.png)

--maxWorkers å‚æ•°è¡¨ç¤ºçš„æ˜¯ jest ä¼šå¼€å¯å¤šå°‘ä¸ªçº¿ç¨‹å»å®Œæˆæ‰€æœ‰çš„æµ‹è¯•ä»»åŠ¡ï¼Œé»˜è®¤å€¼æ˜¯ 50% * os.cpus().lengthï¼Œç›¸å…³çš„æ–‡æ¡£å¯è§ [Jest docs/cli#--maxworker](https://jestjs.io/docs/cli#--maxworkersnumstring)ã€‚

å…¶å®æ—©åœ¨ä¹‹å‰, åŒå­¦ b å°±å‘Šè¯‰äº†æˆ‘ï¼Œå’±ä»¬çš„æœºå™¨è§„æ ¼å¾ˆé«˜ï¼Œæ¯”å¦‚ xxx æœåŠ¡å°±æœ‰ 96 æ ¸ã€‚æ‰€ä»¥æˆ‘é¦–å…ˆæ‰“å°äº†ä¸€ä¸‹å•æµ‹èŠ‚ç‚¹çš„æœºå™¨çš„é…ç½®ï¼Œå‘ç°æœ‰ 64 æ ¸ã€‚é‚£ä¹ˆæœ¬æ¬¡å•æµ‹çº¿ç¨‹æ•°å°±æœ‰äº† 32 ä¸ªã€‚

## åˆ†æ

æˆ‘çš„çŒœæƒ³æ˜¯ Jest æ¯”å¦‚å¹¶è¡Œè·‘ä¸¤ä¸ªç”¨ä¾‹æ—¶ï¼Œç”±äº Node çº¿ç¨‹é—´å†…å­˜ä¸å…±äº«ï¼Œæ¯ä¸ªçº¿ç¨‹ä¸­çš„ç”¨ä¾‹å¦‚æœ import äº†åŒæ ·çš„æ–‡ä»¶éƒ½ä¼šé€šè¿‡ tsTransformã€babelTransform å»è½¬è¯‘ä¸€æ¬¡ï¼Œåšäº†å¤§é‡çš„é‡å¤å·¥ä½œè€Œå¯¼è‡´çš„è€—æ—¶ä¸¥é‡ã€‚

> Node çº¿ç¨‹çš„å®ç°å¯è§ä¹‹å‰å†™çš„ä¸€ç¯‡æ–‡ç«  [ã€node æºç å­¦ä¹ ç¬”è®°ã€‘worker_threads å·¥ä½œçº¿ç¨‹](https://github.com/xiaoxiaojx/blog/issues/16) ï¼Œå¦å¤–å…³äºå¦‚ä½•æå‡ Node çº¿ç¨‹ä¹‹é—´å¤§é‡æ•°æ®äº¤æ¢çš„æ•ˆç‡ä¹Ÿæ˜¯æˆ‘è¿‘æœŸä¸€ç›´å…³æ³¨å­¦ä¹ çš„ç‚¹ï¼Œåé¢æœ‰æœºä¼šæ•´ç†åˆ†äº«ä¸€æ¬¡ã€‚

æ¥ç€æˆ‘åˆå»å’¨è¯¢è¿ç»´çš„å¤§ä½¬ï¼Œå¤§ä½¬è¯´è¿™é‡Œçš„ 64 æ ¸æ˜¯å®¿ä¸»æœºçš„ï¼Œåˆ†é…ç»™å•æµ‹èŠ‚ç‚¹çš„å¯èƒ½åªæœ‰ 5æ ¸ã€‚

é‚£ä¹ˆè¿™æ ·çœ‹æ¥, å¤šçº¿ç¨‹åœ¨éœ€è¦å¤§é‡å…±äº«æ•°æ®çš„æƒ…å†µä¸‹ä¼šå˜æ…¢ï¼Œè€Œç°åœ¨æ›´æ˜¯è¿è¶…äº†åˆ†åˆ°çš„ CPU èµ„æºçš„ 6 å€ä¹‹å¤šï¼Œé€ æˆé€Ÿåº¦å¦‚æ­¤ä¹‹ç¼“æ…¢å°±æ˜¯æƒ…ç†ä¹‹ä¸­çš„ã€‚

## å¯è¡Œçš„æ–¹æ¡ˆ
æ¥ç€æˆ‘å°è¯•æœç´¢äº†ä¸€ä¸‹ Node å¦‚ä½•èƒ½è·å–åˆ° k8s åˆ†é…åˆ°çš„ç»™å®¹å™¨çš„èµ„æºæ•°é‡ï¼Œæ²¡æœ‰æœç´¢åˆ°å¯ç›´æ¥ä½¿ç”¨çš„æ–¹æ¡ˆ, ä»…ä¸‹é¢çš„æ–¹æ¡ˆçœ‹ä¸Šå»æ¯”è¾ƒæ¥è¿‘ä¸€ç‚¹ã€‚

è¯¥æ–¹æ¡ˆæ˜¯æŠŠè®¾ç½®çš„ resources å‚æ•°é€šè¿‡ç¯å¢ƒå˜é‡ MY_CPU_LIMIT çš„å½¢å¼ä¼ é€’ç»™å®¹å™¨ï¼Œè¯¦ç»†å¯è§ [Kubernetes ç”¨ Container å­—æ®µä½œä¸ºç¯å¢ƒå˜é‡çš„å€¼](https://kubernetes.io/zh/docs/tasks/inject-data-application/environment-variable-expose-pod-information/#%E7%94%A8-container-%E5%AD%97%E6%AE%B5%E4%BD%9C%E4%B8%BA%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E7%9A%84%E5%80%BC)

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: dapi-envars-resourcefieldref
spec:
  containers:
    - name: test-container
      image: k8s.gcr.io/busybox:1.24
      command: [ "sh", "-c"]
      args:
      - while true; do
          echo -en '\n';
          printenv MY_CPU_REQUEST MY_CPU_LIMIT;
          printenv MY_MEM_REQUEST MY_MEM_LIMIT;
          sleep 10;
        done;
      resources:
        requests:
          memory: "32Mi"
          cpu: "125m"
        limits:
          memory: "64Mi"
          cpu: "250m"
      env:
        - name: MY_CPU_REQUEST
          valueFrom:
            resourceFieldRef:
              containerName: test-container
              resource: requests.cpu
        - name: MY_CPU_LIMIT
          valueFrom:
            resourceFieldRef:
              containerName: test-container
              resource: limits.cpu
        - name: MY_MEM_REQUEST
          valueFrom:
            resourceFieldRef:
              containerName: test-container
              resource: requests.memory
        - name: MY_MEM_LIMIT
          valueFrom:
            resourceFieldRef:
              containerName: test-container
              resource: limits.memory
  restartPolicy: Never
```

æœ‰è¶£çš„æ˜¯æœ¬åœ° Docker å®¹å™¨ä¸­ os.cpus().length ä¸æ˜¯å®¿ä¸»æœºä¸­çš„æ ¸æ•°ï¼Œè€Œæ˜¯ Docker Desktop ä¸­ Resources è®¾ç½®çš„ CPUSã€‚

![image](https://user-images.githubusercontent.com/23253540/148246463-29371200-4a4f-481d-a596-822c8d49ba43.png)

## å°ç»“
åŒç†ç°åœ¨çš„ Node æœåŠ¡é€šè¿‡é›†ç¾¤æ¨¡å¼å¯åŠ¨ç›´æ¥ä½¿ç”¨ os.cpus().length ä¹Ÿæ˜¯æœ‰é—®é¢˜çš„ï¼Œæš‚æ—¶å†™æ­»å¹¶å‘çš„æ•°é‡å»è§£å†³ã€‚ä¹Ÿåœ¨ CNode ç¤¾åŒºæäº†ä¸€ä¸ªé—®ç­” [å¦‚ä½•åœ¨å®¹å™¨å†…è·å–åˆ†é…åˆ°çš„ cpu èµ„æºæ•°é‡](https://cnodejs.org/topic/61d5345a9945821342f7caa7), çœ‹çœ‹æœ‰æ²¡æœ‰è¸©è¿‡å‘çš„å¤§ä½¬æœ‰æ›´å¥½çš„åŠæ³• ~

## 2022-01-29 è¡¥å……
ç»è¿‡è¯„è®ºåŒº @Kaijun å¤§ä½¬æŒ‡ç‚¹, å€Ÿé‰´ Go çš„è§£å†³æ–¹æ¡ˆ https://github.com/uber-go/automaxprocs , å®ç°äº†ä¸€ç‰ˆ Node.js æ–¹æ¡ˆ https://github.com/xiaoxiaojx/get_cpus_length ï¼Œå¤šæ–¹æµ‹è¯•åæ˜¯å¯è¡Œçš„ âœ… 