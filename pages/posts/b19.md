---
title: React SSR å­ç»„ä»¶è·å–ä¸åˆ° Context é—®é¢˜è®°å½•
date: 2022/3/12
description: æœåŠ¡ç«¯æ¸²æŸ“çš„é¡¹ç›®æœ¬åœ°æ¨¡æ‹Ÿçº¿ä¸Šç¯å¢ƒè¿è¡ŒæŠ¥äº†å¦‚ä¸‹çš„ä¸€ä¸ªé”™è¯¯
tag: SSR
author: You
---

![image](https://user-images.githubusercontent.com/23253540/158014929-cefd5457-8452-4064-8d8b-f3486f1baedc.png)

## èƒŒæ™¯
æœåŠ¡ç«¯æ¸²æŸ“çš„é¡¹ç›®æœ¬åœ°æ¨¡æ‹Ÿçº¿ä¸Šç¯å¢ƒè¿è¡ŒæŠ¥äº†å¦‚ä¸‹çš„ä¸€ä¸ªé”™è¯¯ï¼Œç„¶è€Œæœ¬åœ°å¼€å‘æ¨¡å¼è¿è¡Œå’ŒçœŸå®çš„çº¿ä¸Šç”Ÿäº§æ¨¡å¼è¿è¡Œå‡æ²¡æœ‰é—®é¢˜ã€‚å½“å¬åˆ°è¿™ä¸ªé—®é¢˜æè¿°æ—¶ï¼Œæˆ‘åªè§‰å¾—è¿™ä¸ªä¸´åºŠè¡¨ç°é€éœ²ç€è¯¡å¼‚çš„æ°›å›´ ğŸ˜¢

> æœ¬åœ°æ¨¡æ‹Ÿçº¿ä¸Šç¯å¢ƒæ˜¯å…ˆæ„å»ºå‡ºç”Ÿäº§æ¨¡å¼çš„ä»£ç ï¼Œç„¶åè¿è¡Œ SSR Server ã€‚å…¶ç›®çš„æ˜¯æ›´æ¥è¿‘çœŸå®çš„çº¿ä¸Šç”Ÿäº§ç¯å¢ƒçš„æ•ˆæœ, é€šå¸¸ç”¨äºå¤ç°ä¸ debug çº¿ä¸Šç¯å¢ƒå‡ºç°çš„é—®é¢˜ã€‚
```html
// é”™è¯¯ä¿¡æ¯

Invariant Violation: You should not use <Switch> outside a <Router>
```

## é—®é¢˜ç®€è¿°
ä¸Šé¢çš„é”™è¯¯ä¿¡æ¯é€ æˆåŸå› é€šå¸¸æœ‰ä¸¤ä¸ª
1. Switch ç»„ä»¶çš„ä¸Šå±‚æ²¡æœ‰ Router ç»„ä»¶ï¼Œè§£å†³åŠæ³•æ˜¯ä½¿ç”¨åŸºäº Router ç»„ä»¶çš„ BrowserRouter ç»„ä»¶æˆ– HashRouter ç»„ä»¶ä½œä¸º Switch çš„çˆ¶ç»„ä»¶
> æœåŠ¡ç«¯è¿è¡Œä½¿ç”¨çš„å…¶å®æ˜¯ StaticRouter, æœåŠ¡ç«¯æ¸²æŸ“çš„æ˜¯ä¸€ä¸ªè¯·æ±‚ path çš„é¡µé¢å¿«ç…§, ä¸å­˜åœ¨å®¢æˆ·ç«¯è·¯ç”±ä¼šåˆ‡æ¢çš„æƒ…å†µ
2. node_modules ä¸­ react-router æœ‰å¤šä¸ªç‰ˆæœ¬ï¼Œè§£å†³åŠæ³•æ˜¯æ”¶æ‹¢ä¾èµ–ï¼Œåªèƒ½å…è®¸ä¸€ä¸ªç‰ˆæœ¬

> å¦‚æœ react-router æœ‰å¤šä¸ªç‰ˆæœ¬, ä½¿ç”¨ Router ç»„ä»¶çš„ RouterContext ä¸ä½¿ç”¨ Switch ç»„ä»¶çš„ RouterContext å°†ä¼šæ˜¯åœ¨ä¸¤ä¸ªç‰ˆæœ¬çš„æ–‡ä»¶ä¸­ï¼Œé€ æˆ RouterContext ä¸æ˜¯åŒä¸€ä¸ªå¼•ç”¨ï¼Œå¹³æ—¶è¿™ä¸€ç‚¹è¾ƒéš¾å‘ç°

ç†Ÿæ‚‰ React çš„åŒå­¦åº”è¯¥çŸ¥é“, å­ç»„ä»¶è¦èƒ½ä» RouterContext.Consumer ä¸­è·å–åˆ°çˆ¶ç»„ä»¶ RouterContext.Provider æ³¨å…¥çš„æ•°æ®ï¼Œ å…¶ RouterContext å¿…é¡»æ˜¯åŒä¸€ä¸ªå¯¹è±¡æ‰è¡Œ

å¦‚ä¸‹ react-router çš„ä»£ç , è¯´æ˜äº† Switch ç»„ä»¶æ˜¯éœ€è¦ä» Router ç»„ä»¶è·å–å¿…è¦çš„ context ä¿¡æ¯, context ä¸å­˜åœ¨åˆ™æŠ›é”™
```js
// react-router

class Router extends React.Component {

  render() {
    return (
      <RouterContext.Provider
        value={{
          history: this.props.history,
          location: this.state.location,
          match: Router.computeRootMatch(this.state.location.pathname),
          staticContext: this.props.staticContext
        }}
      >
        <HistoryContext.Provider
          children={this.props.children || null}
          value={this.props.history}
        />
      </RouterContext.Provider>
    );
  }
}

class Switch extends React.Component {
  render() {
    return (
      <RouterContext.Consumer>
        {context => {
          // æŠ›é”™å¤„ ğŸ‘‡
          invariant(context, "You should not use <Switch> outside a <Router>");

          const location = this.props.location || context.location;

          let element, match;

          // We use React.Children.forEach instead of React.Children.toArray().find()
          // here because toArray adds keys to all child elements and we do not want
          // to trigger an unmount/remount for two <Route>s that render the same
          // component at different URLs.
          React.Children.forEach(this.props.children, child => {
            if (match == null && React.isValidElement(child)) {
              element = child;

              const path = child.props.path || child.props.from;

              match = path
                ? matchPath(location.pathname, { ...child.props, path })
                : context.match;
            }
          });

          return match
            ? React.cloneElement(element, { location, computedMatch: match })
            : null;
        }}
      </RouterContext.Consumer>
    );
  }
}
```

## é—®é¢˜æ’æŸ¥
### 1. ç¡®è®¤ RouterContext æ˜¯åŒä¸€ä¸ªå¼•ç”¨
ä» yarn.lock æ–‡ä»¶çœ‹å‡º react-router ç¡®å®åªæœ‰ä¸€ä¸ªç‰ˆæœ¬ï¼Œä¸è¿‡ä»ç„¶å­˜åœ¨ node_modules æ–‡ä»¶ç¼“å­˜æ²¡æœ‰åˆ é™¤æˆåŠŸï¼Œå¯¼è‡´æ®‹ç•™äº†æ—§ç‰ˆæœ¬çš„å¯èƒ½æ€§ã€‚æ­¤æ—¶æˆ‘ä»¬éœ€è¦åˆ†åˆ«åœ¨ Router å’Œ Switch render æ—¶åŠ ä¸Š debugger, ç¡®è®¤ä»£ç è¿è¡Œæ—¶ RouterContext.Provider ä¸ RouterContext.Consumer æ˜¯åŒä¸€ä¸ª RouterContext å¼•ç”¨

é€šè¿‡ debugger æ–­ç‚¹ä¹Ÿç¡®è®¤äº† RouterContext æ˜¯åŒä¸€ä¸ªå¼•ç”¨, é‚£ä¹ˆå­ç»„ä»¶é€šè¿‡ Consumer ä»ç„¶æ‹¿ä¸åˆ° context å²‚ä¸æ˜¯ React çš„ bug ?
```js
// react-router

class Switch extends React.Component {
  render() {
    return (
      <RouterContext.Consumer>
        {context => {
          // æŠ›é”™å¤„ ğŸ‘‡
          invariant(context, "You should not use <Switch> outside a <Router>");

		  // ...
      </RouterContext.Consumer>
    );
  }
}
```
### 2. React çš„ bug ?
æ­¤æ—¶æˆ‘ä»¬è¿˜ä¸èƒ½ç¡®è®¤æ˜¯ React çš„ bug, è¦å…ˆæ‘†è„± react-router çš„å«Œç–‘ã€‚å†™äº†å¦‚ä¸‹çš„ demo, å‘ç° console.log ä¾ç„¶æ²¡æœ‰å€¼ï¼Œä¸è¿‡æŠŠ demo å¤åˆ¶åˆ°ç›¸åŒ react ç‰ˆæœ¬çš„å¦ä¸€ä¸ª SSR é¡¹ç›®ä¸­ console.log æ˜¯æœ‰å€¼çš„ï¼Œå¾—å‡ºä¸æ˜¯ React çš„ bug
```js
import React from 'react'

const MyRouterContext = React.createContext({})

function App() {
  return (
    <MyRouterContext.Provider value={{ test: 1 }}>
      <MyRouterContext.Consumer>
        {(ctx) => {
          console.log(ctx)
          return 11111
        }}
      </MyRouterContext.Consumer>
    </MyRouterContext.Provider>
  )
}
```
æ’æŸ¥äº†ä¸€åœˆä¸‹æ¥å‘ç°å¤§å®¶éƒ½æ˜¯è¢«å†¤æ‰çš„ ğŸ˜¢
* react å’Œ react-router æ²¡æœ‰é—®é¢˜
* æœ¬åœ°å¼€å‘æ¨¡å¼è¿è¡Œå’ŒçœŸå®çš„çº¿ä¸Šç”Ÿäº§æ¨¡å¼è¿è¡Œä¹Ÿæ²¡æœ‰é—®é¢˜
### 3. å¯¹æ¯”å…³é”®ä¿¡æ¯çš„å¼‚åŒ

æœ€ååªèƒ½å’Œæ­£å¸¸èƒ½è¿è¡Œçš„ SSR é¡¹ç›®æ¥è¿›è¡Œä¸åŒäº†ï¼Œæ’æŸ¥é‡ç‚¹åœ¨äº
1. package.json ä¸­çš„ä¾èµ–
2. è„šæ‰‹æ¶é…ç½®æ–‡ä»¶çš„é…ç½®ä¿¡æ¯

åœ¨ä¸€é˜µå¯¹æ¯”å, è¿˜æ˜¯å‘ç°äº†å…³é”®çš„ä¿¡æ¯ã€‚æœ¬åœ°æ¨¡æ‹Ÿçº¿ä¸Šç¯å¢ƒè¿è¡Œçš„æ˜¯ä¸‹é¢çš„å‘½ä»¤
> æ¨¡æ‹Ÿçº¿ä¸Š NODE_ENV æœ€å¥½æ˜¯åº”è¯¥è®¾ç½®æˆ production, è¿™é‡Œå´è®¾ç½®æˆäº† development
```json
    "co-start": "yarn build && NODE_ENV=development DOCKER=true yarn start"
```
ç”Ÿäº§ç¯å¢ƒ yarn build æ‰“åŒ…åï¼Œä»£ç å¼€å§‹æŒ‰å¦‚ä¸‹é¡ºåºè¿è¡Œ
1. è¯»å–è„šæ‰‹æ¶é…ç½®æ–‡ä»¶çš„é…ç½®ä¿¡æ¯
2. åˆ›å»º SSR Server å®ä¾‹
	* ä¸€äº›åˆå§‹åŒ–æ“ä½œ, ç”Ÿäº§æ¨¡å¼è¿è¡Œä¼šå¼ºåˆ¶åˆå§‹åŒ– NODE_ENV ä¸º production
	* åˆ›å»ºå®ä¾‹, å¼€å§‹ç›‘å¬ç«¯å£

åœ¨æ­¥éª¤1ä¸­, NODE_ENV æ˜¯ co-start å‘½ä»¤è®¾ç½®çš„ development, è¯¥é…ç½®æ–‡ä»¶ import äº†ä¸€ä¸ªåŒ… packageA, packageA ä¸‹æŸä¸ªåŒ…åˆ import äº† react , æ‰€ä»¥æ­¤æ—¶ Node.js ç¼“å­˜ä½äº† react  æ¨¡å—, å…¶å€¼ä¸º development ç¯å¢ƒçš„ ./cjs/react.development.js çš„æ¨¡å—å¯¼å‡º

```
// react/index.js

'use strict';

if (process.env.NODE_ENV === 'production') {
  module.exports = require('./cjs/react.production.min.js');
} else {
  module.exports = require('./cjs/react.development.js');
}
```
åœ¨æ­¥éª¤ 2 ä¸­, åˆ¤æ–­æ­¤æ—¶æ˜¯ç”Ÿäº§æ¨¡å¼è¿è¡Œå°±å¼ºåˆ¶åˆå§‹åŒ– NODE_ENV ä¸º production, ä½¿å¾—åé¢è¿è¡Œçš„ import { renderToString } from 'react-dom/server' éƒ¨åˆ†çš„ä»£ç , react-dom çš„å€¼ä¸º production ç¯å¢ƒä¸‹ ./cjs/react-dom-server.node.production.min.js çš„æ¨¡å—å¯¼å‡º

***react å’Œ react-dom ä¸€ä¸ªä½¿ç”¨çš„æ˜¯å¼€å‘ç‰ˆæœ¬, ä¸€ä¸ªä½¿ç”¨çš„æ˜¯ç”Ÿäº§ç‰ˆæœ¬***

æ­¤æ—¶æˆ‘ä»¬ç¯¡æ”¹ node_modules ä¸­ react-dom ä¸ react çš„ä»£ç , ç»Ÿä¸€æ›¿æ¢ process.env.NODE_ENV === 'production' ä¸º true æˆ–è€… false, ä½¿å¾— react-dom ä¸ react å¼•ç”¨ç¯å¢ƒä¿æŒä¸€è‡´, å‘ç°ä¸€åˆ‡å°±èƒ½æ­£å¸¸è¿è¡Œäº† âœ…
```
// react-dom/server.node.js

'use strict';

if (process.env.NODE_ENV === 'production') {
  module.exports = require('./cjs/react-dom-server.node.production.min.js');
} else {
  module.exports = require('./cjs/react-dom-server.node.development.js');
}
```

## å°ç»“
> ç‰ˆæœ¬ä¿¡æ¯: react@16.14.0 react-dom@16.14.0 node@12.20.1

è¿è¡Œ react ä¸ react-dom æ—¶çš„ process.env.NODE_ENV çš„å€¼ä¸ä¸€è‡´å°†ä¼šå¯¼è‡´æœåŠ¡ç«¯æ¸²æŸ“æ—¶ Consumer ç»„ä»¶æ‹¿ä¸åˆ° Provider ç»„ä»¶é€ä¼ ä¸‹æ¥çš„ Context