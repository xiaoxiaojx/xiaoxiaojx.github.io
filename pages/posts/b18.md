---
title: Next.js æœªèƒ½å®æ—¶æ¸²æŸ“é—®é¢˜æ’æŸ¥
date: 2022/4/9
description: æœ€è¿‘æ›´æ–‡è¾ƒå°‘, ä¸»è¦å¿™äºå„å¤§å›¢è´­ç¾¤ä¹°èœ + åšé¥­ + åšæ ¸é…¸ + è¿œç¨‹åŠå…¬
tag: SSR
author: You
---

![image](https://user-images.githubusercontent.com/23253540/162456565-86fe05ac-757d-46fd-aad3-e344811c62cb.png)
> æœ€è¿‘æ›´æ–‡è¾ƒå°‘, ä¸»è¦å¿™äºå„å¤§å›¢è´­ç¾¤ä¹°èœ + åšé¥­ + åšæ ¸é…¸ + è¿œç¨‹åŠå…¬ã€‚ä» 3æœˆ30å· åˆ°ä»Šå¤©å°åŒºå·²ç»å°äº† 11 å¤©, ä¸Šæµ·ç–«æƒ…åˆåˆ›äº†æ–°é«˜ 1015 + 22609 ä¾‹ã€‚åªå¸Œæœ›è¿™æ³¢ç–«æƒ…èµ¶ç´§ç»“æŸ, ä¸è¦å†å‡ºè´Ÿé¢æ–°é—»äº† ğŸ˜“ ã€‚å›¾ç‰‡æ¥è‡ªå°æ§å‰çš„ä¸€æ¬¡å›¤è´§å¤–å‡ºã€‚

## èƒŒæ™¯
è¿‘æœŸåœ¨å¯¹ SSR é¡¹ç›®è¿›è¡Œ ***CDNå’ŒåŸŸåç¾å¤‡*** çš„æ”¹é€ , åŒå­¦ a è´Ÿè´£çš„ Next.js é¡¹ç›®æ”¹é€ æµ‹è¯•æ—¶å‘ç° CDN æ²¡æœ‰é¢„æœŸå†…çš„åŠ¨æ€åˆ‡æ¢ã€‚è¿™ä¸ªé¡¹ç›®ä¸€ç›´æœ‰å†å²åŒ…è¢±, æˆ‘æƒ³ç€ä¸ä¼šçº¿ä¸Š Node ä¸€ç›´æ˜¯æŒ‚çš„å§,  éš¾é“é•¿ä¹…ä»¥æ¥éƒ½æ˜¯ Nginx è¿”å›çš„é™æ€å…œåº•é¡µé¢?

## é—®é¢˜æ’æŸ¥
æœ¬åœ°å¯åŠ¨äº†è¯¥é¡¹ç›®, å‘ç°æ— è®ºæ˜¯æœåŠ¡ç«¯æ¸²æŸ“è¯·æ±‚è¿˜æ˜¯å¥åº·æ£€æŸ¥ Node æœåŠ¡éƒ½æ²¡æœ‰å¼‚å¸¸ã€‚å¾—å‡º Node å¤§æ¦‚ç‡æ˜¯ä¸€ç›´æ­£å¸¸è¿è¡Œçš„, é‚£ä¹ˆä¼šæ˜¯å…¶ä»–ä»€ä¹ˆåŸå› å¯¼è‡´çš„ä¸€ç›´è¿”å›çš„æ˜¯é™æ€èµ„æºè€Œéå®æ—¶çš„ SSR ç›´å‡ºäº†?

çœŸæ­£çš„åŸå› æ˜¯å½“ä½ çš„ src/pages/_app.tsx æ–‡ä»¶ä¸­å¯¼å‡ºçš„ App ç»„ä»¶æˆ–è€…æŸä¸ª Page ç»„ä»¶æ²¡æœ‰å®šä¹‰ getInitialProps æˆ–è€… getServerSideProps è¿™ä¸ªé™æ€æ–¹æ³•, æ„å‘³ç€ä½ å…¶å®æ˜¯ä¸éœ€è¦åœ¨æœåŠ¡ç«¯è¿›è¡Œæ³¨æ°´(æ¯”å¦‚æ‹‰å–ç”¨æˆ·çš„æŸä¸ªçœŸå®æ•°æ®æ¥å£, ç„¶åå®æ—¶æ¸²æŸ“ç›´å‡º)ã€‚

```js
// demo

function Page({ stars }) {
  return <div>Next stars: {stars}</div>
}

Page.getInitialProps = async (ctx) => {
  const res = await fetch('https://api.github.com/repos/vercel/next.js')
  const json = await res.json()
  return { stars: json.stargazers_count }
}

export default Page
```

æ­¤æ—¶ Next.js ä¼šåœ¨æ‰“åŒ…æ„å»ºé˜¶æ®µé¢„æ¸²æŸ“ä¸€ä¸ªé™æ€ html, åˆ°é¡¹ç›®å‘å¸ƒæˆåŠŸ Node æœåŠ¡å¼€å§‹è¿è¡Œçš„æ—¶å€™ç›´æ¥è¿”å›è¯¥é™æ€ html å³å¯ã€‚å› ä¸ºä¸éœ€è¦æ³¨æ°´, html çš„æœ€ç»ˆå½¢æ€æ„å»ºæ—¶å°±èƒ½å†³å®šä¸‹æ¥äº†, æ²¡å¿…è¦æœåŠ¡ç«¯å†å®æ—¶æ¸²æŸ“, æ—¢èƒ½å‡å°‘ CPU æ¶ˆè€—åˆèƒ½éš¾ç¼©çŸ­ rtã€‚

åé¢æŸ¥é˜…äº†ä¸€ä¸‹æ–‡æ¡£, Next.js ç§°è¿™ä¸ªä¼˜åŒ–ç‚¹ä¸º [Automatic Static Optimization](https://nextjs.org/docs/advanced-features/automatic-static-optimization)ã€‚


## ä»£ç å®ç°

### æ„å»ºæ—¶
å¯ä»¥çœ‹åˆ° isStatic çš„å€¼ä¸º true çš„æ¡ä»¶, å³å¯¼å‡ºçš„ App ç»„ä»¶æ²¡æœ‰å®šä¹‰ getStaticPropsã€ getInitialPropsã€getServerSideProps ä»»æ„ä¸€ä¸ªé™æ€æ–¹æ³•
```typescript
// packages/next/build/utils.ts

export async function isPageStatic(
  // ...
}> {
  return isPageStaticSpan.traceAsyncFn(async () => {
    try {

      const mod = await loadComponents(distDir, page, serverless)
      const Comp = mod.Component

      const hasFlightData = !!(mod as any).__next_rsc__
      const hasGetInitialProps = !!(Comp as any).getInitialProps
      const hasStaticProps = !!mod.getStaticProps
      const hasStaticPaths = !!mod.getStaticPaths
      const hasServerProps = !!mod.getServerSideProps
    
      // ...
        
      return {
        isStatic:
          !hasStaticProps &&
          !hasGetInitialProps &&
          !hasServerProps &&
          !hasFlightData,
        isHybridAmp: config.amp === 'hybrid',
        // ...
      }
    } catch (err) {
      if (isError(err) && err.code === 'MODULE_NOT_FOUND') return {}
      throw err
    }
  })
}
```
å¯¹äº isStatic çš„å€¼ä¸º true çš„é¡µé¢ (staticPages) å’Œå®šä¹‰äº† getStaticProps(ssgPages) é™æ€æ–¹æ³•çš„é¡µé¢å°±ä¼šé€šè¿‡ exportApp æ–¹æ³•è¿›è¡Œé¢„æ¸²æŸ“ç”Ÿæˆé™æ€ htmlã€‚
* exportApp çš„é¢„æ¸²æŸ“æ˜¯è°ƒç”¨çš„ ReactDOMServer.renderToString, å¹¶éæ˜¯å€ŸåŠ©çš„ puppeteer
* next export å‘½ä»¤ä¹Ÿæ˜¯è°ƒç”¨çš„ exportApp æ–¹æ³•
```typescript
// packages/next/build/index.ts

export default async function build(
  dir: string,
  conf = null,
  reactProductionProfiling = false,
  debugOutput = false,
  runLint = true
): Promise<void> {
	// ...

    const combinedPages = [...staticPages, ...ssgPages]

    if (combinedPages.length > 0 || useStatic404 || useDefaultStatic500) {
      // ...
        const exportApp: typeof import('../export').default =
          require('../export').default
        const exportOptions = {
          // ...
        }
        const exportConfig: any = {
         // ...
        }

        await exportApp(dir, exportOptions, nextBuildSpan, exportConfig)

        // ...
}
```
æ„å»ºé˜¶æ®µç”Ÿæˆå¥½é™æ€çš„ html æ–‡ä»¶, æœåŠ¡è¿è¡Œæ—¶ç›´æ¥è¿”å›å³å¯

![image](https://user-images.githubusercontent.com/23253540/162478644-c40212d6-be39-4e67-9775-035d5d685985.png)

å¯¹äºå®šä¹‰äº† getInitialProps æˆ–è€… getServerSideProps é™æ€æ–¹æ³•çš„ç»„ä»¶æ„å»ºé˜¶æ®µåˆ™åªä¼šç”ŸæˆæœåŠ¡ç«¯è¿è¡Œæ—¶éœ€è¦çš„ js æ–‡ä»¶

![image](https://user-images.githubusercontent.com/23253540/162479210-273c9fa2-6930-4810-bfee-85c93547c3ce.png)

### è¿è¡Œæ—¶
å¦‚æœå‘ç°æ‰€éœ€ç»„ä»¶æ˜¯ä¸€ä¸ª html æ–‡ä»¶, requirePage æ–¹æ³•å°±ä¼šè¿”å›è¯¥ html çš„å­—ç¬¦ä¸²ã€‚å¦‚æœæ˜¯ä¸€ä¸ª js æ–‡ä»¶åˆ™æ­£å¸¸è¿”å›è¯¥æ¨¡å—çš„ module.exports, ç„¶åæœåŠ¡ç«¯æ¸²æŸ“è¯¥ç»„ä»¶ç”Ÿæˆ html å­—ç¬¦ä¸²

```typescript
// packages/next/server/load-components.ts

export async function loadComponents(
  distDir: string,
  pathname: string,
  serverless: boolean,
  serverComponents?: boolean
): Promise<LoadComponentsReturnType> {
  if (serverless) {
    const ComponentMod = await requirePage(pathname, distDir, serverless)
    if (typeof ComponentMod === 'string') {
      return {
        Component: ComponentMod as any,
        pageConfig: {},
        ComponentMod,
      } as LoadComponentsReturnType
    }

    let {
      default: Component,
      getStaticProps,
      getStaticPaths,
      getServerSideProps,
    } = ComponentMod

    Component = await Component
    getStaticProps = await getStaticProps
    getStaticPaths = await getStaticPaths
    getServerSideProps = await getServerSideProps
    const pageConfig = (await ComponentMod.config) || {}

    return {
      Component,
      pageConfig,
      getStaticProps,
      getStaticPaths,
      getServerSideProps,
      ComponentMod,
    } as LoadComponentsReturnType
  }

  // ...
}
```
ä»£ç çœ‹åˆ°è¿™é‡Œæˆ‘ä»¬çŸ¥é“äº†
* getInitialProps å’Œ getServerSideProps æ˜¯æœåŠ¡ç«¯æ¸²æŸ“æ—¶æ‰ä¼šè¿è¡Œçš„ç”¨äºæ³¨æ°´çš„é’©å­å‡½æ•°, Next.js æ¨èä½¿ç”¨ getServerSideProps å‡½æ•°
* getStaticProps æ˜¯æ„å»ºæ—¶æ‰ä¼šè¿è¡Œçš„ç”¨äºæ³¨æ°´çš„é’©å­å‡½æ•°

### å¦‚ä½•åŒºåˆ†
é€šè¿‡ä¸‹é¢çš„ä»£ç å¯ä»¥çœ‹è§å¯ä»¥é€šè¿‡ Next.js æ³¨å…¥çš„ __NEXT_DATA__ çš„ gsp, gssp, gip ç­‰å€¼å³å¯ä»¥å¿«é€Ÿåˆ¤æ–­å½“å‰é¡µé¢æ˜¯ä½•ç§æ–¹å¼è¿›è¡Œçš„æ¸²æŸ“æ–¹å¼
```typescript
// packages/next/server/render.tsx

export async function renderToHTML(
  req: IncomingMessage,
  res: ServerResponse,
  pathname: string,
  query: NextParsedUrlQuery,
  renderOpts: RenderOpts
): Promise<RenderResult | null> {
  // ...
  
  const htmlProps: HtmlProps = {
    __NEXT_DATA__: {
      props, // The result of getInitialProps
      nextExport: nextExport === true ? true : undefined, // If this is a page exported by `next export`
      autoExport: isAutoExport === true ? true : undefined, // If this is an auto exported page
      gsp: !!getStaticProps ? true : undefined, // whether the page is getStaticProps
      gssp: !!getServerSideProps ? true : undefined, // whether the page is getServerSideProps
      rsc: isServerComponent ? true : undefined, // whether the page is a server components page
      customServer, // whether the user is using a custom server
      gip: hasPageGetInitialProps ? true : undefined, // whether the page has getInitialProps
      appGip: !defaultAppGetInitialProps ? true : undefined, // whether the _app has getInitialProps
      // ...
    },
  }

  // ...

  return new RenderResult(chainStreams(streams))
}
```
çŸ¥é“å¦‚ä½•åŒºåˆ†åå›å¤´çœ‹çœ‹è¯¥é¡¹ç›®è¿”å›çš„ html å°±å¯ä»¥å¿«é€ŸçŸ¥é“è¯¥é¡µé¢æ˜¯æ²¡æœ‰å®šä¹‰ getStaticPropsã€getInitialPropsã€getServerSideProps ä»»æ„ä¸€ä¸ªé™æ€æ–¹æ³•çš„å³ isStatic ä¸º true çš„é™æ€é¡µé¢
![image](https://user-images.githubusercontent.com/23253540/162563683-6ff27dde-b153-480a-87fe-6ebd21ae9469.png)

## å°ç»“
ç”±äºæ²¡æœ‰å®šä¹‰ getInitialPropsã€getServerSideProps ä»»æ„ä¸€ä¸ªé™æ€æ–¹æ³•æ•… Node å®æ—¶çš„è·å– CDN é…ç½®ä¿¡æ¯ä»¥åŠæ¸²æŸ“çš„é€»è¾‘æ²¡æœ‰è¿è¡Œ, è¯¥é¡µé¢çš„è¯·æ±‚éƒ½æ˜¯ Node ç›´æ¥è¿”å›çš„é™æ€ htmlã€‚