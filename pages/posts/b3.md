---
title: webpack Tree Shaking çš„å®ç°åŸç†
date: 2022/12/29
description: a åŒå­¦è¿è¡Œä¸€ä¸ªæœåŠ¡ç«¯æ¸²æŸ“ï¼ˆServer-side renderingï¼Œç®€ç§° SSRï¼‰
tag: webpack
author: You
---

![image](https://user-images.githubusercontent.com/23253540/209829567-046514c2-8061-4fbb-be96-5a02276ddaca.png)

## é—®é¢˜èƒŒæ™¯
```bash
ReferenceError: XMLHttpRequest is not defined
```
a åŒå­¦è¿è¡Œä¸€ä¸ªæœåŠ¡ç«¯æ¸²æŸ“ï¼ˆServer-side renderingï¼Œç®€ç§° SSRï¼‰ é¡¹ç›®æ—¶æŠ›å‡ºäº†å¦‚ä¸Šçš„é”™è¯¯ï¼Œç†Ÿæ‚‰ SSR åŸç†çš„åŒå­¦åº”è¯¥æ¯”è¾ƒäº†è§£è¿™ç±»é—®é¢˜çš„åŸå› ï¼Œé€šå¸¸æ˜¯ä»£ç ä¸­æœªåŒºåˆ† Node ç¯å¢ƒè¿˜æ˜¯æµè§ˆå™¨ç¯å¢ƒå°±ç›´æ¥ä½¿ç”¨äº† windowã€documentã€XMLHttpRequest ç­‰æµè§ˆå™¨ç¯å¢ƒæ‰æœ‰çš„å˜é‡

ç”±äºé”™è¯¯å †æ ˆè¾ƒå°‘ï¼Œç°åœ¨éœ€è¦å¸®å¿™å®šä½åˆ°æœ‰é—®é¢˜çš„ä»£ç ï¼Œé¦–å…ˆå°±å¯¹ä»–çš„ä»£ç è¿›è¡Œäº†åˆ å‡, æŠŠ App ç»„ä»¶å‡å°‘åˆ°äº†å¦‚ä¸‹æç®€çš„ä»£ç å‘ç°å°±ä¸å†æŠ¥é”™äº†
```js
import * as React from 'react'
import { isCompanyDomain } from '@util/router'

class App extends React.Component {
  render() {
    return <div>hello</div>
  }
}
```
æ¥ç€é€šè¿‡***äºŒåˆ†æ³•***é€æ­¥æ¢å¤ App ç»„ä»¶çš„ä»£ç ï¼Œæœ€ç»ˆå‘ç°å¦‚ä¸‹ changeResult å‡½æ•°ä»£ç è¡¥å……ä¸Šåå°±ä¼šæŠ¥é”™
```js
import * as React from 'react'
import { isCompanyDomain } from '@util/router'

class App extends React.Component {
  changeResult() {
    if (isCompanyDomain()) {
      // xxx
    }
  }
  render() {
    return <div>hello</div>
  }
}
```
è¿™é‡Œçš„ä¸€ä¸ª âš ï¸ å¯ç–‘ç‚¹æ˜¯ changeResult å‡½æ•°å¹¶æ²¡æœ‰ä»»ä½•åœ°æ–¹æœ‰è°ƒç”¨ï¼Œä¸ºä½•å®ƒæˆäº†æŠ¥é”™çš„å…³é”®? å¦‚æœæŠŠ changeResult å‡½æ•°é‡Œé¢çš„ isCompanyDomain ä»£ç åˆ é™¤å‘ç°ä¹Ÿä¸ä¼šå†æŠ¥é”™

é—®é¢˜çš„åŸå› å…¶å®å°±å·²ç»æµ®å‡ºæ°´é¢ï¼Œåˆ é™¤ isCompanyDomain å‡½æ•°è°ƒç”¨çš„ä»£ç ï¼Œé‚£ä¹ˆ `import { isCompanyDomain } from '@util/router'` è¿™è¡Œä»£ç ææœ‰å¯èƒ½ç”±äº `isCompanyDomain is declared but its value is never read.` åœ¨æ‰“åŒ…åå°±è¢«åˆ é™¤äº†ä¹Ÿå°±ä¸å†æœ‰æŠ¥é”™ï¼Œæ‰€ä»¥é—®é¢˜æ˜¯ `@util/router` æ–‡ä»¶å¼•ç”¨äº†æœªåŒºåˆ†ç¯å¢ƒå°±ç›´æ¥ä½¿ç”¨ XMLHttpRequest å˜é‡çš„ä»£ç 

## è°è¿›è¡Œäº† Tree Shaking
å¯¹äº [Tree Shaking | webpack](https://webpack.js.org/guides/tree-shaking/) æœ‰äº†è§£çš„åŒå­¦åº”è¯¥çŸ¥é“ webpack é»˜è®¤åªä¼šåœ¨ `mode: 'production'` æ—¶å¼€å¯ Tree Shaking åŠŸèƒ½ã€‚é‚£ä¹ˆæˆ‘ä»¬ä¸Šé¢åˆ†æçš„ `import { isCompanyDomain } from '@util/router'` ä»£ç åˆæ˜¯è°åœ¨ `mode: 'development'`æ—¶å°±ç»™åˆ é™¤äº†ï¼Ÿ
```js
const path = require('path');

module.exports = {
  entry: './src/index.js',
  output: {
    filename: 'bundle.js',
    path: path.resolve(__dirname, 'dist'),
  },
 mode: 'production',
};
```
æ­¤æ—¶ ğŸ› debug çš„æ–¹å‘å°±æ˜¯è¿½è¸ª `import { isCompanyDomain } from '@util/router'` ä»£ç åœ¨ webpack é‡Œé¢è¢«åˆ†æçš„ç”Ÿå‘½å‘¨æœŸï¼Œæ’æŸ¥æ˜¯å“ªä¸€æ­¥è¢«å‰”é™¤äº†ï¼Ÿ

åœ¨ webpack çš„åˆ†ææµç¨‹ä¸­ä¸€ä¸ª import è¯­å¥é¦–å½“å…¶å†²æ˜¯è¢« webpack å†…ç½®çš„ Parser ç”Ÿæˆ Dependency Graph æ—¶ç»™éå†ä¸è®°å½•ã€‚å³å¦‚ä¸‹çš„ prewalkImportDeclaration å‡½æ•°ä¼šæŠŠ AST éå†åˆ°çš„ import è¯­å¥é€šè¿‡ hooks æœºåˆ¶ç»™æŠ›å‡ºï¼Œè®¢é˜…äº†è¯¥ hooks äº‹ä»¶çš„æ’ä»¶å†è¿›è¡Œåç»­çš„å¤„ç†
```js
// webpack/lib/Parser.js

class Parser extends Tapable {
	prewalkImportDeclaration(statement) {
		const source = statement.source.value;
		this.hooks.import.call(statement, source);
		for (const specifier of statement.specifiers) {
			const name = specifier.local.name;
			this.scope.renames.set(name, null);
			this.scope.definitions.add(name);
			switch (specifier.type) {
				case "ImportDefaultSpecifier":
					this.hooks.importSpecifier.call(statement, source, "default", name);
					break;
				case "ImportSpecifier":
					this.hooks.importSpecifier.call(
						statement,
						source,
						specifier.imported.name,
						name
					);
					break;
				case "ImportNamespaceSpecifier":
					this.hooks.importSpecifier.call(statement, source, null, name);
					break;
			}
		}
	}
}
```
å¥‡æ€ªçš„æ˜¯åœ¨æ­¤å¤„è¿›è¡Œ debug å‘ç° `import { isCompanyDomain } from '@util/router'` è¯­å¥æ²¡æœ‰è¢« prewalkImportDeclaration å‡½æ•°æ•è·? é‚£ä¹ˆè¯´æ˜ webpack Parser æ‹¿åˆ°çš„ä»£ç å°±å·²ç»æ²¡æœ‰äº† `import { isCompanyDomain } from '@util/router'` è¿™è¡Œä»£ç 

åœ¨ webpack Parser ä¹‹å‰å·¥ä½œçš„å°±åªèƒ½æ˜¯ loader äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬ debug ä¸€ä¸‹ ts-loader ç¼–è¯‘å®Œä¸šåŠ¡ä»£ç åçš„äº§ç‰©ï¼Œå‘ç°äº§ç‰©ä¸­è¿™è¡Œ `import { isCompanyDomain } from '@util/router'` ä»£ç å°±è¢«åˆ é™¤äº†

æ­¤æ—¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ tsc å‘½ä»¤æ¥éªŒè¯ä¸€ä¸‹ TypeScript ç¼–è¯‘å™¨çš„è¡Œä¸º, å‘ç°ç¼–è¯‘åçš„ output.js ç¡®å®æŠŠæœªä½¿ç”¨åˆ°çš„ `import { testtest1 } from './test'` ä»£ç ç»™åˆ é™¤äº†
```js
// input.js

import { testtest1 } from './test'

console.log(123)
```

```js
// output.js

console.log(123);
export {};
```

## webpack Tree Shaking
ä¸Šé¢è¯´äº†åŠå¤©è¿˜åªæ˜¯ç¼–è¯‘å™¨ tsc çš„å‰”é™¤æœªä½¿ç”¨ä»£ç çš„è¡Œä¸ºï¼Œé‚£ä¹ˆ webpack è‡ªå·±çš„ Tree Shaking æ˜¯å¦‚ä½•å®ç°çš„äº†ï¼Ÿ

æ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡å¦‚ä¸‹ demo ä»£ç å¯¹ Tree Shaking çš„å®ç°åŸç†è¿›è¡Œæ¢ç´¢ï¼Œé¢„æœŸæ˜¯ webpack æ‰“åŒ…åçš„ä»£ç ä¼šåˆ é™¤ `src/test.js` ä¸­æ²¡æœ‰ä½¿ç”¨åˆ°çš„ testtest1 çš„ä»£ç ï¼Œè€Œ testtest2 å› ä¸ºæœ‰å®é™…è¢«ä½¿ç”¨åˆ°ä¼šä¿ç•™
```js
// src/index.js

import { testtest1, testtest2 } from './test'

console.log(testtest2, 123)
```
```js
// src/test.js

export const testtest1 = '1oooooooooooooooooo';

export const testtest2 = '2oooooooooooooooooo';
```
> ä¸ºäº†é˜²æ­¢ ts-loader ç¼–è¯‘ src/index.js æ—¶ç›´æ¥æŠŠ`import { testtest1, testtest2 } from './test'` ç¼–è¯‘æˆäº† `import { testtest2 } from './test'`ï¼Œè¿™æ ·ä¼šè®© webpack è¿‡äºè½»æ¾çš„åˆ†æåˆ°æœªä½¿ç”¨çš„ä»£ç , æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç¯¡æ”¹ä¸‹ ts-loader çš„äº§ç‰©ï¼Œä½¿å¾—äº§ç‰©ä¾ç„¶æ˜¯`import { testtest1, testtest2 } from './test'`
### ç¬¬ä¸€æ­¥é™æ€åˆ†æ
webpack ç¬¬ä¸€æ­¥å…ˆå¯¹å…¥å£æ–‡ä»¶ `src/index.js` è¿›è¡Œé™æ€åˆ†æï¼Œé€šè¿‡ AST éå†æ‹¿åˆ°æ‰€æœ‰çš„ import è¯­å¥ï¼Œç„¶åé€šè¿‡ `hooks.importSpecifier, hooks.importSpecifier, hooks.importSpecifier` å‹¾å­æŠ›å‡ºæ¯ä¸€ä¸ª import è¯­å¥çš„ä¿¡æ¯ï¼Œæœ€åçœŸæ­£è®¢é˜…äº†è¿™äº›å‹¾å­çš„æ’ä»¶å†å¼€å§‹å·¥ä½œ
```js
// webpack/lib/Parser.js

class Parser extends Tapable {
	prewalkImportDeclaration(statement) {
		const source = statement.source.value;
		this.hooks.import.call(statement, source);
		for (const specifier of statement.specifiers) {
			const name = specifier.local.name;
			this.scope.renames.set(name, null);
			this.scope.definitions.add(name);
			switch (specifier.type) {
				case "ImportDefaultSpecifier":
					this.hooks.importSpecifier.call(statement, source, "default", name);
					break;
				case "ImportSpecifier":
					this.hooks.importSpecifier.call(
						statement,
						source,
						specifier.imported.name,
						name
					);
					break;
				case "ImportNamespaceSpecifier":
					this.hooks.importSpecifier.call(statement, source, null, name);
					break;
			}
		}
	}
}
```
### ç¬¬äºŒæ­¥è®°å½•ä¿¡æ¯
å¦‚ä¸‹ HarmonyImportDependencyParserPlugin æ’ä»¶å°±è®¢é˜…äº†`hooks.importSpecifier`äº‹ä»¶ï¼Œå®ƒä¼šæŠŠ import ä¿¡æ¯éƒ½é€šè¿‡ parser.state.harmonySpecifier è¿™ä¸ª Map ç»™è®°å½•äº†ä¸‹æ¥
```js
// webpack/lib/dependencies/HarmonyImportDependencyParserPlugin.js

module.exports = class HarmonyImportDependencyParserPlugin {
	apply(parser) {
		parser.hooks.importSpecifier.tap(
			"HarmonyImportDependencyParserPlugin",
			(statement, source, id, name) => {
				parser.scope.definitions.delete(name);
				parser.scope.renames.set(name, "imported var");
				if (!parser.state.harmonySpecifier) {
					parser.state.harmonySpecifier = new Map();
				}
				parser.state.harmonySpecifier.set(name, {
					source,
					id,
					sourceOrder: parser.state.lastHarmonyImportOrder
				});
				return true;
			}
		);
```
### ç¬¬ä¸‰æ­¥é™æ€åˆ†æ
æ­¤æ—¶ webpack çš„é™æ€åˆ†æåˆ°äº†`console.log(testtest2, 123)`è¯­å¥ï¼Œå‘ç°æœ‰ä»£ç å¼•ç”¨åˆ°äº† testtest2 å˜é‡ï¼Œäºæ˜¯ç»§ç»­é€šè¿‡`hooks.expression`å‹¾å­æŠ›å‡ºå½“å‰å˜é‡çš„ä¿¡æ¯
```js
// webpack/lib/Parser.js

class Parser extends Tapable {
	walkIdentifier(expression) {
		if (!this.scope.definitions.has(expression.name)) {
			const hook = this.hooks.expression.get(
				this.scope.renames.get(expression.name) || expression.name
			);
			if (hook !== undefined) {
				const result = hook.call(expression);
				if (result === true) return;
			}
		}
	}
}
```
### ç¬¬å››æ­¥æ–°å¢ä¸€ä¸ª Dependency
è®¢é˜…äº†` hooks.expression `äº‹ä»¶çš„ HarmonyImportDependencyParserPlugin æ’ä»¶æ¥æ”¶åˆ°äº† testtest2 å˜é‡çš„ä¿¡æ¯ï¼Œå¹¶ä¸”å‘ç°ç¬¬äºŒæ­¥è®°å½•ä¿¡æ¯çš„ parser.state.harmonySpecifier Map ä¸­åˆšå¥½è®°å½•äº† testtest2 çš„ä¿¡æ¯, äºæ˜¯ç¡®å®šäº†è¿™æ˜¯ä¸€ä¸ªåˆæ³•çš„ import å¼•ç”¨, æœ€åä¸º `src/index.js` æ¨¡å—æ–°å¢äº†ä¸€ä¸ªç±»å‹ä¸º ***HarmonyImportSpecifierDependency*** çš„ Dependency
```js
// webpack/lib/dependencies/HarmonyImportDependencyParserPlugin.js

module.exports = class HarmonyImportDependencyParserPlugin {
	apply(parser) {
		parser.hooks.expression
			.for("imported var")
			.tap("HarmonyImportDependencyParserPlugin", expr => {
				const name = expr.name;
				const settings = parser.state.harmonySpecifier.get(name);
				const dep = new HarmonyImportSpecifierDependency(
					settings.source,
					parser.state.module,
					settings.sourceOrder,
					parser.state.harmonyParserScope,
					settings.id,
					name,
					expr.range,
					this.strictExportPresence
				);
				dep.shorthand = parser.scope.inShorthand;
				dep.directImport = true;
				dep.loc = expr.loc;
				parser.state.module.addDependency(dep);
				return true;
			});
```
### ç¬¬äº”æ­¥å¼€å§‹ Tree Shaking
åˆ°ç¬¬å››æ­¥æˆ‘ä»¬å·²ç»çŸ¥é“ webpack é™æ€åˆ†æ `src/index.js` æ¨¡å—æ—¶ä¼šç»™è¢« import äº†ä¸”è¢«ä½¿ç”¨åˆ°çš„ testtest2 å˜é‡åˆ†é…ä¸€ä¸ª ***HarmonyImportSpecifierDependency***ã€‚è€Œå½“ webpack å¼€å§‹é™æ€åˆ†æ `src/test.js` æ¨¡å—æ—¶åˆä¼šç»™ testtest1, testtest2 éƒ½åˆ†é…ä¸€ä¸ª ***HarmonyExportSpecifierDependency***
- å¯¹äº `src/index.js` æ¨¡å—, å› ä¸º import å¼•ç”¨ä¸”ä½¿ç”¨åˆ°äº† testtest2ï¼Œæ‰€ä»¥ä¸ºå…¶åˆ†é…äº†ä¸€ä¸ªæŒ‡å‘ testtest2 å˜é‡çš„ ***HarmonyImportSpecifierDependency***
- å¯¹äº `src/test.js` æ¨¡å—, å› ä¸ºæºç åŒ…å«äº†ä¸¤ä¸ª export å¯¼å‡ºè¯­å¥ï¼Œæ‰€ä»¥ä¸ºå¯¼å‡ºè¯­å¥ testtest1, testtest2 å˜é‡å„åˆ†é…äº†ä¸€ä¸ª ***HarmonyExportSpecifierDependency***

`src/test.js` æ¨¡å—æœ€åç”Ÿæˆçš„ä»£ç æ˜¯æŒ‰ç…§å®ƒåŒ…å«çš„ä¸¤ä¸ª ***HarmonyExportSpecifierDependency*** çš„æ¨¡ç‰ˆå‡½æ•°çš„è§„åˆ™å†³å®š
```js
// webpack/lib/dependencies/HarmonyExportSpecifierDependency.js

HarmonyExportSpecifierDependency.Template = class HarmonyExportSpecifierDependencyTemplate {
	getContent(dep) {
		const used = dep.originModule.isUsed(dep.name);
		if (!used) {
			return `/* unused harmony export ${dep.name || "namespace"} */\n`;
		}
		const exportsName = dep.originModule.exportsArgument;

		return `/* harmony export (binding) */ __webpack_require__.d(${exportsName}, ${JSON.stringify(
			used
		)}, function() { return ${dep.id}; });\n`;
	}
};
```
å› ä¸º `src/test.js` æ¨¡å—çš„ä»£ç æ˜¯å¯¼å‡ºçš„ testtest2 æœ‰è¢«ä½¿ç”¨ï¼ˆused çš„å€¼ä¸º trueï¼‰ï¼Œå¯¼å‡ºçš„ testtest1 æœªè¢«ä½¿ç”¨ï¼ˆused çš„å€¼ä¸º falseï¼‰ï¼Œé‚£ä¹ˆæŒ‰ç…§  getContent å‡½æ•°ç”Ÿæˆçš„ä»£ç å°±æ˜¯ç±»ä¼¼å¦‚ä¸‹
```js
// src/test.js

const testtest1 = '1oooooooooooooooooo';

const testtest2 = '2oooooooooooooooooo';

/* unused harmony export testtest1 */

/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, "testtest2", function() { return testtest2; });
```
é‚£ä¹ˆä¸ºä»€ä¹ˆ testtest2 å˜é‡ used çš„å€¼ä¸º trueï¼Œä¸‹é¢è¿½æº¯ä¸€ä¸‹ä¸º true çš„åŸå› 
1. å› ä¸º `src/test.js` æ¨¡å—çš„ usedExports çš„å€¼ä¸º `["testtest2"]`, æ‰€ä»¥`isUsed("testtest2")` å‡½æ•°è¿”å›ä¸º trueï¼Œå³ used çš„å€¼ä¸º true
2. æ¨¡å—çš„ usedExports çš„å€¼æ˜¯ processDependency å‡½æ•°è¿è¡Œæ—¶è¿›è¡Œçš„èµ‹å€¼ï¼ŒprocessDependency å‡½æ•°ä¼šå¯¹ webpack åˆ†æåˆ°çš„æ‰€æœ‰æ–‡ä»¶æ¨¡å— module è¿›è¡Œéå†ã€‚å½“ processDependency å‡½æ•°éå†åˆ°çš„ module æ˜¯ `src/index.js`ï¼Œä¸”è¯¥ module æœ‰ä¸€ä¸ª Dependency å³ç¬¬äºŒä¸ªå‚æ•° dep æ˜¯æŒ‡å‘ testtest2 å˜é‡çš„ ***HarmonyImportSpecifierDependency*** æ—¶ï¼Œè€Œ testtest2 å˜é‡æ˜¯ `src/test.js` æ¨¡å—ï¼ˆreferenceModuleï¼‰çš„å¯¼å‡º, æ•…åç»­ç»§ç»­è°ƒç”¨ processModule å‡½æ•°ç»™ `src/test.js` æ¨¡å—ï¼ˆreferenceModuleï¼‰çš„ usedExports èµ‹å€¼ä¸ºäº† `["testtest2"]`ï¼ˆimportedNames ï¼‰
```js
// 1
// webpack/lib/Module.js
isUsed(exportName) {
    // ...
    let idx = this.usedExports.indexOf(exportName);
    if (idx < 0) return false;
    // ...
    return exportName;
}

// 2
// webpack/lib/FlagDependencyUsagePlugin.js
// å½“éå†åˆ° module ä¸º src/index.js, dep ä¸ºæŒ‡å‘ testtest2 å˜é‡çš„ HarmonyImportSpecifierDependency æ—¶
const processDependency = (module, dep) => {
  const reference = compilation.getDependencyReference(module, dep)
  if (!reference) return
  // æ­¤æ—¶çš„ referenceModule ä¸º src/test.js æ¨¡å—, å³å¯¼å‡º testtest2 å˜é‡çš„æ¨¡å—
  const referenceModule = reference.module
  // importedNames ä¸ºç¬¬å››æ­¥æ–°å¢çš„ HarmonyImportSpecifierDependency çš„ name å€¼ä¸º testtest2
  const importedNames = reference.importedNames
  const oldUsed = referenceModule.used
  const oldUsedExports = referenceModule.usedExports
  if (
    !oldUsed ||
    (importedNames &&
      (!oldUsedExports || !isSubset(oldUsedExports, importedNames)))
  ) {
    // è°ƒç”¨ processModule å‡½æ•°
    processModule(referenceModule, importedNames)
  }
}
// ç»™ src/test.js æ¨¡å—çš„ usedExports æ•°ç»„æ–°å¢ "testtest2" å…ƒç´ , å³ usedExports çš„å€¼ä¸º ["testtest2"]
const processModule = (module, usedExports) => {
	module.used = true;
	if (module.usedExports === true) return;
	if (usedExports === true) {
		module.usedExports = true;
	} else if (Array.isArray(usedExports)) {
		const old = module.usedExports ? module.usedExports.length : -1;
		module.usedExports = addToSet(
			module.usedExports || [],
			usedExports
		);
		if (module.usedExports.length === old) {
			return;
		}
	}
    // ...
};
```
### ç¬¬å…­æ­¥åˆ é™¤æœªä½¿ç”¨ä»£ç 
åˆ°äº†ç¬¬äº”æ­¥æˆ‘ä»¬å‘ç° webpack å·²ç»ç¡®å®šäº†å“ªäº›å¯¼å‡ºæœ‰è¢«ä½¿ç”¨åˆ°ï¼Œå“ªäº›å¯¼å‡ºæ²¡æœ‰è¢«ä½¿ç”¨ï¼Œä¸”ä¸ºç”Ÿæˆçš„ä»£ç ä½œäº†æ ‡è®°ã€‚é‚£ä¹ˆæœªä½¿ç”¨åˆ°çš„`const testtest1 = '1oooooooooooooooooo';`è¿™è¡Œä»£ç æ˜¯è¢«è°ç»™åˆ é™¤çš„äº†ï¼Ÿ

å…¶å®è¿™é‡Œæ˜¯ [TerserPlugin](https://webpack.js.org/plugins/terser-webpack-plugin/) è¿›è¡Œçš„åˆ é™¤, å› ä¸º Terser çš„åŠŸèƒ½æœ¬èº«ä¹Ÿæ˜¯å‹ç¼©ä»£ç ï¼Œåˆ é™¤å†—ä½™ä»£ç ï¼Œè¿™ä¹Ÿä½“ç°äº†å•ä¸€èŒè´£åŸåˆ™
```js
// webpack/lib/WebpackOptionsDefaulter.js

this.set("optimization.minimizer", "make", options => [
	{
		apply: compiler => {
			// Lazy load the Terser plugin
			// const TerserPlugin = require("terser-webpack-plugin");
			// const SourceMapDevToolPlugin = require("./SourceMapDevToolPlugin");
			new TerserPlugin({
				cache: true,
				parallel: true,
				sourceMap:
					(options.devtool && /source-?map/.test(options.devtool)) ||
					(options.plugins &&
						options.plugins.some(p => p instanceof SourceMapDevToolPlugin))
			}).apply(compiler);
		}
	}
]);
```
è®©æˆ‘ä»¬æ‰‹å†™ä¸€ä¸ªç®€ç‰ˆçš„æ‰“åŒ…åçš„ä»£ç æ¥çœ‹æ¸…æ¥š webpack ä¸ Terser çš„è¡Œä¸º
```js
// input.js

const exports = {
  './src/test.js': (m) => {
    const testtest1 = '1oooooooooooooooooo'
    const testtest2 = '2oooooooooooooooooo'

    // å¦‚ä¸‹æ¨¡æ‹Ÿ webpack çš„æ ‡è®°ä»£ç 
    Object.defineProperty(m, 'testtest2', {
      value: testtest2
    })
  }
}

console.log(exports)
```
æ¥ç€æˆ‘ä»¬è¿è¡Œå¦‚ä¸‹ Terser å‘½ä»¤æ¥å‹ç¼©ä¸€ä¸‹ input.js
```bash
terser input.js --compress ecma=2015,computed_props=false -o output.js
```
æœ€åæˆ‘ä»¬å‘ç°`const testtest1 = '1oooooooooooooooooo';`è¿™è¡Œä»£ç å·²ç»ä¸è§äº†ï¼Œè€Œæœ‰ Object.defineProperty å¼•ç”¨çš„ testtest2 å˜é‡çš„ä»£ç å°±è¢«ä¿ç•™äº†ä¸‹æ¥
```js
// output.js

const exports = {
  './src/test.js': (m) => {
    Object.defineProperty(m, 'testtest2', { value: '2oooooooooooooooooo' })
  }
}
console.log(exports)
```

## å°ç»“
- tsc, esbuild, babel ç­‰ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨åˆ é™¤æœªä½¿ç”¨åˆ°çš„ä»£ç 
- webpack Tree Shaking çš„å®ç°åŸç†æ˜¯ webpack ä¾èµ–åˆ†ææ—¶è®°å½•æ¨¡å—çš„å¯¼å‡ºæ˜¯å¦æœ‰è¢«ä½¿ç”¨ï¼Œç„¶ååœ¨ç”Ÿæˆåçš„ä»£ç ä¸­è¿›è¡Œäº†æ ‡è®°ï¼Œæœ€å Terser æŠŠæœªè¢«æ ‡è®°çš„å¯¼å‡ºå³æœªä½¿ç”¨åˆ°çš„ä»£ç ç»™åˆ é™¤