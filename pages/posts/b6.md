---
title: JavaScript String length è½¬æ¢ä¸º byteLength
date: 2022/11/10
description: çœ‹ Node.js ä¸­è¿™æ®µä»£ç è¾ƒä¸ºç–‘æƒ‘, 
tag: Node.js
author: You
---

çœ‹ Node.js ä¸­è¿™æ®µä»£ç è¾ƒä¸ºç–‘æƒ‘, å¦‚ä¸‹ StorageSize å‡½æ•°é€šè¿‡ JavaScript å­—ç¬¦ä¸²çš„é•¿åº¦ï¼ˆstr->Lengthï¼‰ä¼°ç®—å‡ºè½¬æ¢ä¸º UTF-8 ç¼–ç ä¼šå ç”¨çš„æœ€å¤§å­—èŠ‚æ•°ä¸º 3 * str->Length(), è¯´æ˜é•¿åº¦ä¸º 1 çš„ JavaScript å­—ç¬¦ä¸²è½¬æ¢ä¸º UTF-8 ç¼–ç æœ€å¤šéœ€è¦ 3 ä¸ªå­—èŠ‚æ¥å­˜å‚¨, é‚£ä¹ˆè¿™ä¸ªç»“è®ºæ˜¯å¦‚ä½•å¾—å‡ºæ¥çš„?
```c++
Maybe<size_t> StringBytes::StorageSize(Isolate* isolate,
                                       Local<Value> val,
                                       enum encoding encoding) {
  HandleScope scope(isolate);
  size_t data_size = 0;

  Local<String> str;
  if (!val->ToString(isolate->GetCurrentContext()).ToLocal(&str))
    return Nothing<size_t>();

  switch (encoding) {
    // çœç•¥ ...
    
    case UTF8:
      data_size = 3 * str->Length();
      break

    default:
      CHECK(0 && "unknown encoding");
      break;
  }

  return Just(data_size);
}

```
> [MDN String length](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/length): The length read-only property of a string contains the length of the string in UTF-16 code units.

é€šè¿‡æŸ¥é˜… MDN å‘ç° JavaScript å­—ç¬¦ä¸²æ˜¯ UTF-16 ç¼–ç , é‚£ä¹ˆ UTF-16 çš„ç¼–ç è§„åˆ™æ˜¯æ€æ ·çš„äº†?

![image](https://user-images.githubusercontent.com/23253540/200615590-5c2c9939-455b-4b4b-b39c-c5f0bd8124dd.png)

é€šè¿‡æŸ¥é˜… [UTF-16 ç»´åŸºç™¾ç§‘](https://zh.wikipedia.org/wiki/UTF-16) å‘ç° UTF-16 å…±2ç§æƒ…å†µçš„ç¼–ç , ç ç‚¹èŒƒå›´ 0-65535 çš„å­—ç¬¦åœ¨ UTF-16 æ˜¯ 2 ä¸ªå­—èŠ‚, 65536 ä»¥ä¸Šä¸º 4 ä¸ªå­—èŠ‚

æœ€åæˆ‘ä»¬å†æŸ¥é˜… [ç»Ÿä¸€ç  ç™¾åº¦ç™¾ç§‘](https://baike.baidu.com/item/%E7%BB%9F%E4%B8%80%E7%A0%81/2985798) å‘ç° UTF-8 å…±4ç§æƒ…å†µçš„ç¼–ç 

![image](https://user-images.githubusercontent.com/23253540/200625168-a83b48b6-e0be-4728-b3f0-6686a5a8a58b.png)

äºæ˜¯æˆ‘ä»¬å¯ä»¥ä»ç ç‚¹èŒƒå›´ 0-127, 128-2047, 2048-65535 ä¸­ä»»æ„å–ä¸€ä¸ªæ•°æ¥éªŒè¯ JavaScript å­—ç¬¦ä¸²çš„é•¿åº¦ä¸è½¬æ¢ä¸º UTF-8 ç¼–ç çš„å­—èŠ‚æ•°çš„å…³ç³»

```js
// ç ç‚¹èŒƒå›´ 0ï½127, "1".codePointAt(): 49
"1".length
// length: 1, Buffer.byteLength("1", "utf16le"): 2, Buffer.byteLength("1", "utf8"): 1

// ç ç‚¹èŒƒå›´ 128~2047, "Â®".codePointAt(): 174
"Â®".length
// length: 1, Buffer.byteLength("Â®", "utf16le"): 2, Buffer.byteLength("Â®", "utf8"): 2

// ç ç‚¹èŒƒå›´ 2048~65535, "å¤š".codePointAt(): 22810
"å¤š".length
// length: 1, Buffer.byteLength("å¤š", "utf16le"): 2, Buffer.byteLength("å¤š", "utf8"): 3

// ç ç‚¹èŒƒå›´ 65536~2097151, "ğ€€".codePointAt(): 65536
"ğ€€".length
// length: 2, Buffer.byteLength("ğ€€", "utf16le"): 4, Buffer.byteLength("ğ€€", "utf8"): 4
```
ä¸Šé¢çš„éªŒè¯ç»“æœæ¥çœ‹, å½“ JavaScript å­—ç¬¦ä¸²çš„é•¿åº¦ä¸º 1 æ—¶ UTF-8 ç¼–ç çš„å­—èŠ‚æ•°å¯èƒ½ä¸º1ä¸ªæˆ–è€…2ä¸ªæˆ–è€…3ä¸ª, âœ… ä»è€ŒéªŒè¯äº† JavaScript å­—ç¬¦ä¸²è½¬æ¢ä¸º UTF-8 ç¼–ç æœ€å¤šéœ€è¦ 3 * str->Length() ä¸ªå­—èŠ‚æ¥å­˜å‚¨ã€‚


- Unicode å­—ç¬¦å¯¹ç…§è¡¨è§: [Unicode/Character reference](https://en.wikibooks.org/wiki/Unicode/Character_reference/10000-10FFF)
