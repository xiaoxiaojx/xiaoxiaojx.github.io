---
title: webpack Tree Shaking ä¹‹ sideEffects
date: 2023/1/16
description: ä¸‹é¢ä»¥ä¸€ä¸ªä¸šåŠ¡é¡¹ç›®ä¸ºä¾‹, æˆ‘ä»¬æ·»åŠ äº†è‹¥å¹²æ–‡ä»¶æ¥éªŒè¯æµ‹è¯•
tag: webpack
author: å¤šå°å‡¯
---

![image](https://user-images.githubusercontent.com/23253540/212721530-f6fa4aaf-1b02-49b0-aff9-c497c2881ccd.png)

## ä¾‹å­ ğŸŒ°
ä¸‹é¢ä»¥ä¸€ä¸ªä¸šåŠ¡é¡¹ç›®ä¸ºä¾‹, æˆ‘ä»¬æ·»åŠ äº†è‹¥å¹²æ–‡ä»¶æ¥éªŒè¯æµ‹è¯•
- å…¥å£æ–‡ä»¶: `src/views/act-choose-goods/index.ts`
- æœŸæœ›ç»“æœ: ç»è¿‡ webpack Tree Shaking åæ²¡æœ‰ä½¿ç”¨åˆ°çš„ `aaa.ts` ä¸ `ddd.ts` éƒ½ä¼šè¢«åˆ é™¤

```js
// src/views/act-choose-goods/index.ts

import { ccccccccc } from "./bbb"
console.log(ccccccccc)
```

```js
// src/views/act-choose-goods/bbb.ts

export { aaaaaaaaa } from "./aaa"
export { ccccccccc } from "./ccc"
```

```js
// src/views/act-choose-goods/aaa.ts

import { ddddddddd } from "./ddd"
export const aaaaaaaaa = 'aaaaaaaaa'
```

```js
// src/views/act-choose-goods/ccc.ts

export const ccccccccc = 'ccccccccc'
```


```js
// src/views/act-choose-goods/ddd.ts

export const ddddddddd = 'ddddddddd'
```
- å®é™…ç»“æœ: `aaa.ts` è¿˜å­˜åœ¨ï¼Œåªæœ‰ `ddd.ts` è¢«åˆ é™¤äº†ï¼Œé‚£ä¹ˆ webpack ä¸ºä»€ä¹ˆæ²¡æœ‰åˆ é™¤ `aaa.ts` ?

![image](https://user-images.githubusercontent.com/23253540/212681528-afaabc9b-6cfb-4581-8261-3c6c9ff7eb2c.png)

åŸå› æ˜¯ [webpack Tree Shaking çš„å®ç°åŸç†](https://github.com/xiaoxiaojx/blog/issues/51) ä¸­æåˆ°çš„, ç”±äº`ddddddddd is declared but its value is never read.`è¢« ts-loader ç»™åˆ é™¤äº†ï¼Œæˆ‘ä»¬ç¯¡æ”¹ä¸‹ ts-loader çš„ä»£ç ï¼Œä½¿å¾—å®ƒä¿ç•™ `import { ddddddddd } from "./ddd"` è¿™è¡Œä»£ç 
![image](https://user-images.githubusercontent.com/23253540/212682592-ffcad6ed-1c7b-467e-99dd-9e7788cb717a.png)


ç°åœ¨æˆ‘ä»¬å‘ç°æ‰“åŒ…å `ddd.ts` ä¹Ÿè¢«ä¿ç•™äº†ä¸‹æ¥...
![image](https://user-images.githubusercontent.com/23253540/212682842-8e248065-cc29-49d1-b985-5a2caf725146.png)

## åŸå› åˆ†æ
ä¸ºä»€ä¹ˆ webpack æ²¡æœ‰åˆ é™¤æœªä½¿ç”¨åˆ°çš„ `aaa.ts` ä¸ `ddd.ts` æ¨¡å—? 

åŸå› æ˜¯ webpack æ— æ³•ç¡®è®¤ `aaa.ts` ä¸ `ddd.ts` æ˜¯å¦æœ‰å‰¯ä½œç”¨ã€‚æ¯”å¦‚æˆ‘ä»¬å¸¸åœ¨ä»£ç ä¸­è¿™æ ·å» import ä¸€ä¸ª polyfill æ¥å…¼å®¹ä½ç‰ˆæœ¬æµè§ˆå™¨, åœ¨è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬è™½ç„¶æ²¡æœ‰ä½¿ç”¨ [react-app-polyfill](https://github.com/facebook/create-react-app/tree/bb64e31a81eb12d688c14713dce812143688750a/packages/react-app-polyfill) çš„å¯¼å‡º, ä½†æ˜¯ä¸èƒ½åˆ é™¤ `import 'react-app-polyfill/ie11'` è¿™è¡Œä»£ç 
```js
import 'react-app-polyfill/ie11';

// ...
```
å› ä¸º`react-app-polyfill/ie11`ç›´æ¥ä¿®æ”¹äº† windowã€Object ç­‰å…¨å±€å¯¹è±¡, è¿™æ®µä»£ç æœ‰å‰¯ä½œç”¨, å³ä½¿æ²¡æœ‰ç”¨åˆ°å…¶å¯¼å‡ºä¹Ÿåº”è¯¥è¢«ä¿ç•™ä¸‹æ¥
```js
// react-app-polyfill/ie11

'use strict';

if (typeof Promise === 'undefined') {
  // Rejection tracking prevents a common issue where React gets into an
  // inconsistent state due to an error, but it gets swallowed by a Promise,
  // and the user has no idea what causes React's erratic future behavior.
  require('promise/lib/rejection-tracking').enable();
  self.Promise = require('promise/lib/es6-extensions.js');
}

// Make sure we're in a Browser-like environment before importing polyfills
// This prevents `fetch()` from being imported in a Node test environment
if (typeof window !== 'undefined') {
  // fetch() polyfill for making API calls.
  require('whatwg-fetch');
}

// Object.assign() is commonly used with React.
// It will use the native implementation if it's present and isn't buggy.
Object.assign = require('object-assign');

// Support for...of (a commonly used syntax feature that requires Symbols)
require('core-js/features/symbol');
// Support iterable spread (...Set, ...Map)
require('core-js/features/array/from');
```
åˆæ¯”å¦‚å½“ä½ æ²¡ç”¨ [CSS Modules](https://github.com/css-modules/css-modules) æ—¶, é€šå¸¸åªéœ€ `import 'antd/dist/reset.css';`, æ­¤æ—¶ä¹Ÿä¸ä¼šç”¨åˆ° *.css æ¨¡å—çš„å¯¼å‡º, è¯´æ˜ *.css æ¨¡å—ä¹Ÿæœ‰å‰¯ä½œç”¨ä¸èƒ½è½»æ˜“è¢«åˆ é™¤

å¯¹äºè¿™ç§æƒ…å†µ, æˆ‘ä»¬å¯ä»¥åœ¨é¡¹ç›®çš„ `package.json` ä¸­å¯ä»¥é€šè¿‡ [sideEffects](https://webpack.js.org/guides/tree-shaking/#mark-the-file-as-side-effect-free) å­—æ®µå£°æ˜å“ªäº›æ–‡ä»¶æ˜¯æœ‰å‰¯ä½œç”¨, å¦‚ä¸‹è¡¨ç¤ºä»… *.css æ¨¡å—æœ‰å‰¯ä½œç”¨
```json
"sideEffects": [
    "*.css"
 ]
```
å½“ç¡®è®¤äº† *.ts æ²¡æœ‰å‰¯ä½œç”¨å, å†çœ‹ä¸€ä¸‹ç»“æœå‘ç° `aaa.ts` ä¸ `ddd.ts` æœ€ç»ˆè¢«æˆåŠŸåˆ é™¤äº†
![image](https://user-images.githubusercontent.com/23253540/212686955-bd13041d-0618-4326-80b4-d238d7369455.png)
## å®ç°åŸç†
å½“æˆ‘ä»¬æ²¡æœ‰åœ¨ `package.json` ä¸­å£°æ˜ sideEffects å­—æ®µæ—¶, å¯ä»¥çœ‹åˆ°å¯¹äº aaa.ts æ¨¡å—çš„ hasSideEffects ä¸º true, å³æ˜¯æœ‰å‰¯ä½œç”¨çš„, é‚£ä¹ˆå¯¹äº *.ts æ¨¡å—çš„ `factoryMeta.sideEffectFree` çš„å€¼éƒ½å°†ä¸ºé»˜è®¤çš„ undefined
![image](https://user-images.githubusercontent.com/23253540/212687690-3cb6c09c-cc97-4b70-84ad-4fe51b142a4e.png)
å½“æˆ‘ä»¬å£°æ˜ sideEffects å­—æ®µå, é‚£ä¹ˆæŸä¸ªæ¨¡å—çš„æ–‡ä»¶åç¼€ä¼šä¸ sideEffects è¿›è¡Œç±»ä¼¼æ­£åˆ™åŒ¹é…, å¯¹äº *.ts æ¨¡å—æ²¡æœ‰è¢« *.css è¡¨è¾¾å¼åŒ¹é…ä¸Šåˆ™ hasSideEffects ä¸º false, `factoryMeta.sideEffectFree` è¢«èµ‹å€¼ä¸º true

å³ sideEffects å­—æ®µå†³å®š `factoryMeta.sideEffectFree` çš„å€¼, è€Œ `factoryMeta.sideEffectFree` çš„å€¼å°†å†³å®šè¯¥æ¨¡å—æ˜¯å¦è¢« Tree Shaking

> - å¯¹äº `ccc.ts` æ¨¡å—çš„å¯¼å‡ºä¸”æœ‰è¢«å®é™…ä½¿ç”¨åˆ°, `ccc.ts` æ¨¡å—å¯¹åº”çš„æ˜¯ HarmonyImportSpecifierDependency 
> - å¯¹äº `aaa.ts`ã€`ddd.ts` æ¨¡å—çš„å¯¼å‡ºæ²¡æœ‰è¢«ä½¿ç”¨åˆ°, æ•…è¢«åˆ†é…çš„æ˜¯ HarmonyImportSideEffectDependencyï¼ˆä»è¿™é‡Œå¤§æ¦‚å°±å¯ä»¥çŒœå‡º, è¯¥ç±»å‹æ¨¡å—å¦‚æœæ²¡æœ‰å‰¯ä½œç”¨åç»­ä¼šè¢«åˆ é™¤ï¼‰


![image](https://user-images.githubusercontent.com/23253540/212691704-da47092c-ede4-48de-8fc6-50a87a85dbab.png)

ä¸‹é¢è®²ä¸€ä¸‹ HarmonyImportSideEffectDependency, å¦‚ä¸Šå›¾ iteratorDependency å‡½æ•°ä¸­å½“ ref å­˜åœ¨ && ref.module ä¹Ÿå­˜åœ¨ç­‰æ¡ä»¶æˆç«‹æ—¶ä¹Ÿä¼šè¢«æ·»åŠ åˆ° blockInfoModules ä¸­ï¼ˆå¯ä»¥è®¤ä¸ºæ²¡æœ‰æ·»åŠ åˆ° blockInfoModules ä¸­çš„æ¨¡å—æ˜¯ä¸ä¼šç”Ÿæˆåˆ°æ‰“åŒ…åçš„ä»£ç ä¸­ï¼‰ã€‚

é‚£ä¹ˆæœ€å…³é”®çš„å› ç´ å°±æ˜¯ `this._module.factoryMeta.sideEffectFree` çš„å€¼, å¦‚æœå€¼ä¸º true, é‚£ä¹ˆ getDependencyReference å‡½æ•°è¿”å›å€¼ä¸º null, ref ä¸º null å°±ç»“æŸäº†
```js
// webpack/lib/Compilation.js

class Compilation {
  getDependencyReference(module, dependency) {
    // TODO remove dep.getReference existence check in webpack 5
    if (typeof dependency.getReference !== 'function') return null
    const ref = dependency.getReference()
    if (!ref) return null
    return this.hooks.dependencyReference.call(ref, dependency, module)
  }
}

// webpack/lib/dependencies/HarmonyImportSideEffectDependency.js

class HarmonyImportSideEffectDependency extends HarmonyImportDependency {
 getReference() {
  if (this._module && this._module.factoryMeta.sideEffectFree) return null;

  return super.getReference();
 }
}
```
`factoryMeta.sideEffectFree` çš„å€¼å…¶å®æˆ‘ä»¬ä¸Šé¢å·²ç»è®¨è®ºè¿‡äº†
- å½“æ²¡æœ‰å£°æ˜ sideEffects å­—æ®µæ—¶, `factoryMeta.sideEffectFree` çš„å€¼ä¸º undefined, ç»§ç»­è°ƒç”¨ super.getReference() å°†ä¼šè¿”å›ä¸€ä¸ªæœ‰å€¼çš„ ref
- å½“å£°æ˜ sideEffects å­—æ®µå, `factoryMeta.sideEffectFree` çš„å€¼ä¸º true, ref å³ä¸º null, è‡ªæ­¤è¢«å¼•ç”¨äº†ä½†æœªå®é™…ç”¨åˆ°å…¶å¯¼å‡ºçš„ `aaa.ts`ã€`ddd.ts`ã€`bbb.ts` ç­‰æ¨¡å—éƒ½ä¸ä¼šæ·»åŠ åˆ° blockInfoModules ä¸­ï¼Œå³ä¸ä¼šå‡ºç°åœ¨æ‰“åŒ…åçš„æ–‡ä»¶ä¸­

> å…³äº HarmonyImportSpecifierDependency åœ¨ [webpack Tree Shaking çš„å®ç°åŸç†](https://github.com/xiaoxiaojx/blog/issues/51) ä¸­è¯´è¿‡, æ¯”å¦‚æ¨¡å— `index.ts` å¼•ç”¨äº† `ccc.ts` çš„å¯¼å‡º, é‚£ä¹ˆ refModuleï¼ˆ`ccc.ts` æ¨¡å—ï¼‰æœ€åä¼šè¢«æ·»åŠ åˆ° blockInfoModules ä¸­ï¼ˆæ­¤æ—¶ currentModule ä¸º `index.ts`, d ä¸º HarmonyImportSpecifierDependency, refModule ä¸º `ccc.ts`ï¼‰


## å°ç»“
- å¯¹äºä¸€ä¸ªä¸šåŠ¡é¡¹ç›®: å¯ä»¥åœ¨ package.json ä¸­å£°æ˜å¥½ sideEffects å­—æ®µæ¥è¾…åŠ© webpack è¿›è¡Œ Tree Shaking
```json
"sideEffects": [
    "*.css",
    "*.scss"
 ]
```
- å¯¹äºä¸€ä¸ª npm åŒ…: åŒç†, è¯¦ç»†è§ [ant-design/package.json](https://github.com/ant-design/ant-design/blob/master/package.json)

![image](https://user-images.githubusercontent.com/23253540/212705883-50b5c432-9a66-4351-abf6-5a50effce478.png)

- å¯¹äºä¸€ä¸ªè„šæ‰‹æ¶: å¯ä»¥ç»™åŒä¸€ç±»æ–‡ä»¶ç»Ÿä¸€åŠ ä¸Š sideEffects, è¯¦ç»†è§ [Rule.sideEffects](https://webpack.js.org/configuration/module/#rulesideeffects)
![image](https://user-images.githubusercontent.com/23253540/212706133-1245e53c-d246-4257-b659-098aa4808610.png)