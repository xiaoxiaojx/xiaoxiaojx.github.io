---
title: Node.js è¿›ç¨‹å¶ç°çš„ CPU å ç”¨ 100% æ’æŸ¥
date: 2023/4/13
description: y åŒå­¦åæ˜ ç”µè„‘æ¢æˆ M2 åï¼Œä½¿ç”¨ nopack å¼€å‘æ—¶ç»å¸¸ä¼šå‡ºç° CPU å ç”¨ 100%
tag: Node.js
author: å¤šå°å‡¯
---

![image](https://user-images.githubusercontent.com/23253540/231503505-04568d41-a1bf-4984-8383-add6dba72e42.png)

## é—®é¢˜èƒŒæ™¯
y åŒå­¦åæ˜ ç”µè„‘æ¢æˆ M2 åï¼Œä½¿ç”¨ nopack å¼€å‘æ—¶ç»å¸¸ä¼šå‡ºç° CPU å ç”¨ 100% çš„æƒ…å†µï¼Œå·²ç»ä¸¥é‡å½±å“åˆ°äº†å¼€å‘æ•ˆç‡
> nopack: å…¬å¸å†…éƒ¨çš„ä¸€ä¸ª bundless å·¥å…·ï¼Œå·²æ”¯æŒ 100+ åº”ç”¨è¿‘ 2å¹´ï¼Œè¯¦ç»†è§: [2021-10-14 å‡¯å¤š å·¨çŸ³åº”ç”¨è§£å†³æ–¹æ¡ˆ nopack](https://github.com/xiaoxiaojx/blog/issues/20)

ç›¸æ¯”äº webpack è¿™æ ·çš„ bundler ğŸ“¦ æ‰“åŒ…åäº§ç‰©åªæœ‰å°‘é‡çš„æ–‡ä»¶ï¼ŒVite ä¸ nopack è¿™æ ·çš„ bundless âš¡ï¸ å·¥å…·ä¸ä¼šåœ¨å¼€å‘æ¨¡å¼ä¸‹æ‰“åŒ…é¡¹ç›®çš„æºä»£ç ï¼Œå› ä¸ºè¿™ä¸¤è€…æ˜¯åŸºäºæµè§ˆå™¨ native ES Modules

æ‰€ä»¥ bundless å·¥å…·å¼€å‘æ¨¡å¼ä¸‹å¾€å¾€ä¼šå‡ºç°å¤§é‡çš„å°æ–‡ä»¶è¯·æ±‚ï¼Œå¯¹äºæ€§èƒ½è¾ƒå·®çš„ç”µè„‘ Google Chrome è¿›ç¨‹å‡ºç°çŸ­æš‚çš„ CPU å ç”¨ 100% çš„æƒ…å†µè¿˜æ˜¯æ¯”è¾ƒå¸¸è§

è¯¥åŒå­¦ä½¿ç”¨çš„æ˜¯æœ€å¼º M2ï¼Œé—®é¢˜è¡¨ç°æ˜¯ nopack è¿›ç¨‹å¶ç° CPU å ç”¨ 100% ä¸”ä¸ä¼šä¸‹é™ï¼Œè¿™å±å®è®©äººä¸€ä¸‹éš¾ä»¥æ¥å—

## é—®é¢˜æ’æŸ¥

ä¸€å¼€å§‹åªèƒ½è¦ y åŒå­¦é€šè¿‡ node --cpu-prof é€‰é¡¹å»å¯åŠ¨ nopackï¼Œå½“ç¨‹åºé€€å‡ºæ—¶çœ‹èƒ½ä¸èƒ½å¤Ÿä»è‡ªåŠ¨ç”Ÿæˆçš„ .cpuprofile æ–‡ä»¶ä¸­æ‰¾åˆ°çªç ´å£
> [--cpu-prof](https://nodejs.org/dist/latest-v18.x/docs/api/cli.html#--cpu-prof): Starts the V8 CPU profiler on start up, and writes the CPU profile to disk before exit.

![image](https://user-images.githubusercontent.com/23253540/231513234-7fd6ef84-581c-485a-b741-59deb2021446.png)

é—æ†¾çš„æ˜¯å¦‚ä¸Šå›¾ .cpuprofile æ–‡ä»¶ä¸­æœªèƒ½å‘ç°æœ‰å ç”¨ CPU è¿‡é«˜çš„å‡½æ•°ï¼Œæ²¡æœ‰æ‰¾åˆ°è¾ƒå¤§ä»·å€¼çš„çº¿ç´¢ã€‚å¦ä¸€ä¸ªé—®é¢˜æ˜¯ 10æ¬¡é€€å‡ºç¨‹åºä¸­å¤§æ¦‚åªæœ‰ 1æ¬¡ä¼šç”Ÿæˆ .cpuprofile æ–‡ä»¶ ğŸ¥²

ä¸‹ä¸€æ­¥çš„æ’æŸ¥ä¸­æˆ‘åœ¨ nopack ä»£ç ä¸­åŠ å…¥äº†å¦‚ä¸‹çš„å¿ƒè·³æ£€æµ‹ä»£ç ï¼Œç¡®è®¤è¿›ç¨‹æ˜¯ä¸æ˜¯çœŸç˜«ç—ªäº†
```js
setInterval((){
    console.log('æˆ‘è¿˜æ´»ç€ ...')
}, 1000)
```
ç»“æœæ˜¯å½“ CPU å ç”¨åˆ°äº† 100% æ—¶ï¼ŒsetInterval é‡Œé¢çš„ console ä¹Ÿåœæ­¢äº†ï¼Œæ­¤æ—¶åŸºæœ¬ç¡®è®¤äº†è¿›ç¨‹å¯èƒ½é™·å…¥äº†æŸç§è‡´å‘½é”™è¯¯æˆ–è€…æ­»å¾ªç¯ä¸­ï¼Œè¿™å¤§æ¦‚ç‡æ˜¯ç¨‹åºçš„ bug äº† ğŸ›

æœ€ååªèƒ½å¯„å¸Œæœ›äºè°ƒè¯•åˆ©å™¨ lldb äº†ï¼Œæ¥çœ‹çœ‹è¿›ç¨‹å¡æ­»åï¼Œä»£ç å †æ ˆåœç•™åœ¨ä»€ä¹ˆåœ°æ–¹
> [lldb](https://lldb.llvm.org/use/map.html): æ˜¯ macOS å’Œ iOS å¹³å°ä¸‹çš„ä¸€æ¬¾å‘½ä»¤è¡Œè°ƒè¯•å·¥å…·ï¼Œå®ƒå…è®¸å¼€å‘è€…åœ¨æœ¬åœ°è°ƒè¯•è¿è¡Œä¸­çš„åº”ç”¨ç¨‹åºã€‚lldb ä½¿ç”¨äº† gdb çš„è¯­æ³•å’Œå‘½ä»¤ï¼Œä½†æ˜¯æä¾›äº†æ›´å¤šçš„åŠŸèƒ½å’Œæœ¬åœ°è°ƒè¯•å™¨çš„æ”¯æŒï¼Œæ¯”å¦‚å¯ä»¥è°ƒè¯•åŸç”Ÿæ¡†æ¶å’Œ C++ ä»£ç ã€‚

é€šè¿‡ lldb çš„çº¿ç¨‹å›æº¯ï¼Œå‘ç°äº†æœ€åè¿è¡Œçš„å¯è¯»ä»£ç åœç•™åœ¨äº† `node::http2::Http2Session::OnStreamClose` å‡½æ•°è°ƒç”¨
```bash
* thread #1, name = 'nopack', queue = 'com.apple.main-thread', stop reason = signal SIGSTOP
  * frame #0: 0x0000000181249024 libsystem_malloc.dylib`tiny_malloc_should_clear + 56
    frame #1: 0x0000000181247cac libsystem_malloc.dylib`szone_malloc_should_clear + 92
    frame #2: 0x00000001813b88b0 libc++abi.dylib`operator new(unsigned long) + 32
    frame #3: 0x0000000102b59968 node`node::http2::Http2Session::OnStreamClose(nghttp2_session*, int, unsigned int, void*) + 300
    frame #4: 0x0000000102ae3af8 node`node::Environment::RunAndClearNativeImmediates(bool)::$_8::operator()(node::CallbackQueue<void, node::Environment*>*) const + 100
    frame #5: 0x0000000102ae3094 node`node::Environment::RunAndClearNativeImmediates(bool) + 404
    frame #6: 0x0000000102ae2a6c node`node::Environment::CheckImmediate(uv_check_s*) + 308
    frame #7: 0x00000001033a5850 node`uv__run_check + 152
    frame #8: 0x000000010339f5ac node`uv_run + 396
    frame #9: 0x0000000102a896d4 node`node::SpinEventLoop(node::Environment*) + 244
    frame #10: 0x0000000102b75138 node`node::NodeMainInstance::Run(int*, node::Environment*) + 120
    frame #11: 0x0000000102b74e18 node`node::NodeMainInstance::Run() + 112
    frame #12: 0x0000000102b0c994 node`node::Start(int, char**) + 224
    frame #13: 0x00000001810d3e50 dyld`start + 2544
```
è¿™ç¡®å®æ˜¯ä¸€ä¸ªå€¼å¾—æ’æŸ¥çš„æ–¹å‘ï¼Œå‰é¢è¯´äº† bundless å·¥å…·å¼€å‘æ¨¡å¼ä¸‹å¾€å¾€ä¼šå‡ºç°å¤§é‡çš„å°æ–‡ä»¶è¯·æ±‚ï¼Œæ‰€ä»¥ nopack é»˜è®¤æ˜¯ http2 åè®®å¯åŠ¨ï¼Œç›¸æ¯”äº http1 åè®®èƒ½å¤Ÿå¤§å¹…æå‡å¹¶å‘è¯·æ±‚

è€Œè¿™é‡Œæ˜¾ç¤ºåœç•™åœ¨äº† Node.js http2 çš„ OnStreamClose æ–¹æ³•ï¼Œå¦‚æœå°è¯•ä½¿ç”¨ http1 åè®®æ¥å¯åŠ¨æ²¡æœ‰é—®é¢˜å°±è¯´æ˜äº† CPU å ç”¨ 100% æ˜¯ Node.js åœ¨ M2 ä¸­çš„ä¸€ä¸ª bug

```c
// src/node_http2.cc

int Http2Session::OnStreamClose(nghttp2_session* handle,
                                int32_t id,
                                uint32_t code,
                                void* user_data) {
  Http2Session* session = static_cast<Http2Session*>(user_data);
  Environment* env = session->env();
  Isolate* isolate = env->isolate();
  HandleScope scope(isolate);
  Local<Context> context = env->context();
  Context::Scope context_scope(context);
  Debug(session, "stream %d closed with code: %d", id, code);
  BaseObjectPtr<Http2Stream> stream = session->FindStream(id);
  // Intentionally ignore the callback if the stream does not exist or has
  // already been destroyed
  if (!stream || stream->is_destroyed())
    return 0;

  stream->Close(code);

  // It is possible for the stream close to occur before the stream is
  // ever passed on to the javascript side. If that happens, the callback
  // will return false.
  Local<Value> arg = Integer::NewFromUnsigned(isolate, code);
  MaybeLocal<Value> answer =
    stream->MakeCallback(env->http2session_on_stream_close_function(),
                          1, &arg);
  if (answer.IsEmpty() || answer.ToLocalChecked()->IsFalse()) {
    // Skip to destroy
    stream->Destroy();
  }
  return 0;
}
```

## é—®é¢˜å°ç»“

ä½¿ç”¨ http1 åè®®åæš‚æœªèƒ½å†å¤ç° CPU å ç”¨ 100% çš„é—®é¢˜ï¼Œè‡³äºæ˜¯ä¸æ˜¯ Node.js http2 çš„ bugï¼Œè¿˜éœ€æ‰“ä¸ª Node.js debug åŒ…æ¥è¿›è¡Œæ’æŸ¥ä¸ç¡®è®¤ï¼Œé‚£å°±åç»­æœ‰ç©ºå†è·Ÿè¿›å§

![image](https://user-images.githubusercontent.com/23253540/231523081-a75114b9-3344-4b50-938d-8c2832da89bd.png)
