---
title: n.e is not a function é—®é¢˜è®°å½•
date: 2022/9/29
description: a åŒå­¦è¯´æˆ‘å†™çš„ npm åŒ… @xxfe/pkg åœ¨ x é¡¹ç›®ä½¿ç”¨æ—¶å‘å¸ƒåˆ°æµ‹è¯•çŽ¯å¢ƒæŠ¥äº†å¦‚ä¸Šçš„é”™è¯¯
tag: webpack
author: You
---

![image](https://user-images.githubusercontent.com/23253540/192844916-1470a651-c3b1-473e-bbc1-aeafffe52415.png)

## é—®é¢˜ç®€è¿°
```js
TypeError: n.e is not a function 
```
 a åŒå­¦è¯´æˆ‘å†™çš„ npm åŒ… @xxfe/pkg åœ¨ x é¡¹ç›®ä½¿ç”¨æ—¶å‘å¸ƒåˆ°æµ‹è¯•çŽ¯å¢ƒæŠ¥äº†å¦‚ä¸Šçš„é”™è¯¯, ä½†æ˜¯å¼€å‘çŽ¯å¢ƒæ²¡æœ‰æŠ¥é”™ã€‚æŽ¥ç€æˆ‘çœ‹äº†ä¸€ä¸‹ node_modules ä¸­è¿™ä¸ªåŒ…çš„ä»£ç , è¿™ä¸ª Promise éƒ½æ²¡ await å’‹ä¼šè¢« catch ä¸”è¿˜çœŸçš„è¢«æ•èŽ·æ‰“å°äº†é”™è¯¯æ—¥å¿— ðŸ¤¯, è¿™æ˜¯ä»€ä¹ˆçžŽçŒ«ç¢°è§æ­»è€—å­çš„æ“ä½œ ...
 ```js
 // node_modules/@xxfe/pkg
 
 try {
 	this.aesUtilPromise = import('../aes-util')
 } catch (e) {
 	console.info('123  ========', e);
 }
 ```
 ä»…çœ‹ node_modules ä¸­çš„ä»£ç å¹¶æœªå‘çŽ°æ˜Žæ˜¾çš„é”™è¯¯, å…¶å®žæˆ‘ä»¬åº”è¯¥çœ‹çš„æ˜¯ @xxfe/pkg æ‰“åŒ…åŽçš„ä»£ç 
 ```js
 // dist/static/js/xxx.js
 
 try {
 	this.aesUtilPromise=n.e(3)
 } catch(r) {
 	console.info("123  ========",r)
 }
 ```
æ‰“åŒ…åŽçš„ä»£ç å°±å‘çŽ°äº†é”™è¯¯çš„æºå¤´ n.e
 
ç†Ÿæ‚‰ webpack çš„åŒå­¦å°±çŸ¥é“åŠ¨æ€ import å‡½æ•°æ‰“åŒ…åŽä¼šè¢« __webpack_require__.e å‡½æ•°ç»™æ›¿æ¢, å…¶åŽŸç†å°±æ˜¯é€šè¿‡åŠ¨æ€åˆ›å»ºä¸€ä¸ª script æ ‡ç­¾æ¥åŠ è½½ä¸€ä¸ª js, å¦‚ä¸‹å³å‡½æ•°çš„ä»£ç 
```js
/******/  __webpack_require__.e = function requireEnsure(chunkId) {
/******/   var promises = [];
/******/
/******/
/******/   // JSONP chunk loading for javascript
/******/
/******/   var installedChunkData = installedChunks[chunkId];
/******/   if(installedChunkData !== 0) { // 0 means "already installed".
/******/
/******/    // a Promise means "currently loading".
/******/    if(installedChunkData) {
/******/     promises.push(installedChunkData[2]);
/******/    } else {
/******/     // setup Promise in chunk cache
/******/     var promise = new Promise(function(resolve, reject) {
/******/      installedChunkData = installedChunks[chunkId] = [resolve, reject];
/******/     });
/******/     promises.push(installedChunkData[2] = promise);
/******/
/******/     // start chunk loading
/******/     var script = document.createElement('script');
/******/     var onScriptComplete;
/******/
/******/     script.charset = 'utf-8';
/******/     script.timeout = 120;
/******/     if (__webpack_require__.nc) {
/******/      script.setAttribute("nonce", __webpack_require__.nc);
/******/     }
/******/     script.src = jsonpScriptSrc(chunkId);
/******/     if (script.src.indexOf(window.location.origin + '/') !== 0) {
/******/      script.crossOrigin = "anonymous";
/******/     }
/******/     // create error before stack unwound to get useful stacktrace later
/******/     var error = new Error();
/******/     onScriptComplete = function (event) {
/******/     // ...
/******/     };
/******/     var timeout = setTimeout(function(){
/******/      onScriptComplete({ type: 'timeout', target: script });
/******/     }, 120000);
/******/     script.onerror = script.onload = onScriptComplete;
/******/     document.head.appendChild(script);
/******/    }
/******/   }
/******/   return Promise.all(promises);
/******/  };
```

## é—®é¢˜æŽ’æŸ¥
é‚£ä¹ˆä¸ºä»€ä¹ˆä»£ç ä¸­ç”¨åˆ°äº† import å‡½æ•°, webpack å´æ²¡æœ‰æ³¨å…¥ __webpack_require__.e å‡½æ•°çš„å®žçŽ°äº† ?

æ­¤æ—¶æˆ‘ä»¬åªèƒ½çœ‹ webpack çš„ä»£ç å®žçŽ°, å¯ä»¥å‘çŽ°å½“ Object.keys(chunkMaps.hash).length æ¡ä»¶ä¸º true æ—¶, æ‰ä¼šæ³¨å…¥ ${this.requireFn}.e å‡½æ•°
```js
// webpack/lib/MainTemplate.js

this.hooks.requireExtensions.tap("MainTemplate", (source, chunk, hash) => {
			const buf = [];
			const chunkMaps = chunk.getChunkMaps();
			// Check if there are non initial chunks which need to be imported using require-ensure
			if (Object.keys(chunkMaps.hash).length) {
				buf.push("// This file contains only the entry chunk.");
				buf.push("// The chunk loading function for additional chunks");
				buf.push(`${this.requireFn}.e = function requireEnsure(chunkId) {`);
				buf.push(Template.indent("var promises = [];"));
				buf.push(
					Template.indent(
						this.hooks.requireEnsure.call("", chunk, hash, "chunkId")
					)
				);
				buf.push(Template.indent("return Promise.all(promises);"));
				buf.push("};");
			}
            // ...
}
```
é¡ºç€å‡½æ•°è°ƒç”¨é¡ºåºå‘çŽ°å…³é”®æ˜¯ getAllAsyncChunks å‡½æ•°è¿”å›žå€¼ chunks é›†åˆä¸ä¸ºç©ºå³å¯
```js
// webpack/lib/Chunk.js

getAllAsyncChunks() {
		const queue = new Set();
		const chunks = new Set();

		const initialChunks = intersect(
			Array.from(this.groupsIterable, g => new Set(g.chunks))
		);

		for (const chunkGroup of this.groupsIterable) {
			for (const child of chunkGroup.childrenIterable) {
				queue.add(child);
			}
		}

		for (const chunkGroup of queue) {
			for (const chunk of chunkGroup.chunks) {
				if (!initialChunks.has(chunk)) {
					chunks.add(chunk);
				}
			}
			for (const child of chunkGroup.childrenIterable) {
				queue.add(child);
			}
		}

		return chunks;
}
```
chunks é›†åˆåªæœ‰ä¸€å¤„å¾€é›†åˆå¢žåŠ æ•°æ®çš„é€»è¾‘ã€‚initialChunks å¯ä»¥ç†è§£ä¸ºé¦–å± html ä¸­ script æ ‡ç­¾çš„ js, é€šå¸¸æ˜¯ main.js åŠå…¶è¿è¡Œå‰ä¾èµ–çš„ js, æ¯”å¦‚ main.js éœ€è¦ä¾èµ– react, react-dom ç­‰ js çš„å‰ç½®è¿è¡Œã€‚
```js
if (!initialChunks.has(chunk)) {
	chunks.add(chunk);
}
```

å› ä¸ºä¸šåŠ¡é¡¹ç›® webpackConfig.optimizationa.splitChunks çš„é…ç½®æŠŠ a åŒå­¦å†™çš„ @xxfe/pkg åŒ…éƒ½æ‰“å…¥åˆ°äº† xxfe_vendor æ–‡ä»¶ä¸­, è€Œ @xxfe/ scope ä¸‹çš„ä¾èµ–è¢«ä¸šåŠ¡é¡¹ç›®å¤§é‡ä½¿ç”¨, æ‰€ä»¥æ— ç–‘æ˜¯ä¸šåŠ¡é¡¹ç›® main.js å‰ç½®ä¾èµ–çš„ä¸€ä¸ª js, æ•… xxfe_vendor åœ¨é¦–å± html ä¸­ script æ ‡ç­¾çš„ js ä¸­

æ‰€ä»¥ xxfe_vendor æ˜¯ initialChunks ä¸­çš„å…¶ä¸­ä¸€ä¸ª, æ•…æ­¤å¤„ if ä¸º false
```js
xxfe_vendor: {
  name: 'xxfe_vendor',
  chunks: 'all',
  priority: 8,
  enforce: true,
  test: (module) => {
    const resource = getModulePath(module)
    if (/@xxfe(\\|\/)/.test(resource)) {
      return true
    }
    return false
  },
},
```
è‡³æ­¤æˆ‘ä»¬ç†æ¸…äº†å¯¼è‡´é—®é¢˜çš„åŽŸå› , @xxfe/pkg ä¸­çš„ import å‡½æ•°å¼•ç”¨çš„ js åŠå…¶è‡ªèº«ä»£ç ç”±äºŽåˆ†åŒ…çš„ splitChunks è®¾ç½®éƒ½è¢«æ‰“å…¥åˆ°äº† xxfe_vendor ä¸­, è€Œ xxfe_vendor åˆæ˜¯ä¸šåŠ¡é¡¹ç›® main.js å‰ç½®è¿è¡Œä¾èµ–çš„ js, æ•… webpack é”™è¯¯çš„è®¤ä¸ºä½ ä¸éœ€è¦ __webpack_require__.e å‡½æ•°

* webpack ç‰ˆæœ¬: 4.39.0 

> Q: è¿™ä¸ªç®—è°çš„ bug ?
> 
> A: webpack çš„ bugã€‚å› ä¸ºä¸èƒ½è¯´ç”¨æˆ·éœ€è¦åŠ è½½çš„ js å¦‚æžœåœ¨é¦–å±å…¶ä¸­ä¹‹ä¸€, å°±ä¸æ³¨å…¥ __webpack_require__.e å‡½æ•°çš„å®žçŽ°ã€‚ä¸šåŠ¡é¡¹ç›®é€šè¿‡ splitChunks è¿›è¡Œåˆ†åŒ…ä¸æ˜¯ npm åŒ…çš„ä½œè€…æ‰€èƒ½å†³å®š, æ˜¯å¦æ³¨å…¥ __webpack_require__.e å‡½æ•°çš„å®žçŽ°åº”è¯¥ç”±æ˜¯å¦æœ‰ import å‡½æ•°è¯­æ³•æ¥å†³å®šã€‚
> 
>
> Q: ä¸ºä»€ä¹ˆå¼€å‘çŽ¯å¢ƒæ²¡æœ‰æŠ¥é”™ ?
> 
> A: ä¸šåŠ¡é¡¹ç›®çš„ splitChunks è®¾ç½®äº†åªåœ¨ç”Ÿäº§æž„å»ºç”Ÿæ•ˆ

## é—®é¢˜è§£å†³
å°†å¦‚ä¸‹çš„ [chunks](https://webpack.js.org/plugins/split-chunks-plugin/#splitchunkschunks) å­—æ®µç”± all æ”¹ä¸ºäº† initial, è¡¨ç¤ºè¯¥åˆ†åŒ…è®¾ç½®å°†ä¸è¦å½±å“åˆ°åŠ¨æ€ import å‡½æ•°å¼‚æ­¥åŠ è½½çš„ js (è¯¥ç±»åž‹ä¸º async chunks), ä½¿å¾— @xxfe/pkg å°†ä¸ä¼šè¢«åˆå…¥ xxfe_vendor æ–‡ä»¶ä¸­, é‚£ä¹ˆå¦‚ä¸Šçš„ initialChunks ä¹Ÿå°†ä¸åŒ…å« @xxfe/pkg, ä»Žè€Œ webpack ä¹Ÿä¼šå¦‚çº¦æ³¨å…¥ __webpack_require__.e å‡½æ•°çš„å®žçŽ°
```js
xxfe_vendor: {
  name: 'xxfe_vendor',
  chunks: 'initial',
  priority: 8,
  enforce: true,
  test: (module) => {
    const resource = getModulePath(module)
    if (/@xxfe(\\|\/)/.test(resource)) {
      return true
    }
    return false
  },
},
```