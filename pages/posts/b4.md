---
title: ä»ä¸šåŠ¡çš„è§’åº¦æ¥çœ‹ React18 Suspense SSR æ¶æ„
date: 2022/12/04
description: ç°æœ‰çš„æœåŠ¡ç«¯æ¸²æŸ“ï¼ˆServer-side renderingï¼Œç®€ç§° SSRï¼‰çš„åŸç†æ˜¯
tag: SSR
author: You
---

![image](https://user-images.githubusercontent.com/23253540/205350835-ff3f8d06-fa63-4ea4-9138-41a6c4a5980f.png)

## ç›®å½•
<!-- vscode-markdown-toc -->
* 1. [å®é™…ä¸šåŠ¡çš„å›°å¢ƒ](#ssr_1)
* 2. [Suspense SSR æ¶æ„](#SuspenseSSR)
	* 2.1. [å¯èƒ½å­˜åœ¨çš„é—®é¢˜](#ssr_21)
* 3. [åº”ç”¨åˆ°ä¸šåŠ¡ä¸­çš„æ•ˆæœ](#ssr_30)
* 4. [å°ç»“](#ssr_40)
* 5. [æœ€åçš„è¯](#ssr_50)

<!-- vscode-markdown-toc-config
	numbering=true
	autoSave=true
	/vscode-markdown-toc-config -->
<!-- /vscode-markdown-toc -->

##  1. <a name='ssr_1'></a>å®é™…ä¸šåŠ¡çš„å›°å¢ƒ
ç°æœ‰çš„æœåŠ¡ç«¯æ¸²æŸ“ï¼ˆServer-side renderingï¼Œç®€ç§° SSRï¼‰çš„åŸç†æ˜¯å½“ HTML è¯·æ±‚åˆ°è¾¾ Node ç«¯æ—¶å…ˆç­‰å¾…åç«¯æ¥å£æ•°æ®è¯·æ±‚å®Œæˆï¼ˆ30ï½300msï¼‰ï¼Œç„¶åå†è¿›è¡Œæ¸²æŸ“ï¼ˆ2ï½5msï¼‰ï¼Œæœ€åå†å“åº”æ¸²æŸ“å®Œæˆçš„é¡µé¢ç»™æµè§ˆå™¨ã€‚
> å¤§è‡´æµç¨‹æ˜¯: fetch data (server) â†’ render to HTML (server) â†’ load code (client) â†’ hydrate (client)

å¦‚æœ¬æ–‡ç”¨ä½œç¤ºä¾‹çš„`å•†å“ç®¡ç†`é¡µé¢ï¼Œéœ€è¦å¹¶å‘8ä¸ªåç«¯æ¥å£è¯·æ±‚ï¼Œæœ€æ…¢çš„æ¥å£ `/api/xxx/goodsList` å»¶æ—¶ä¸º **246.6 ms**ï¼Œå¯¼è‡´`Step1é˜¶æ®µ`ç”¨æˆ·çœ‹åˆ°çš„é¡µé¢ç™½å±æ—¶é—´è‡³å°‘æ˜¯ **246.6ms + 5ms**ã€‚

![image](https://user-images.githubusercontent.com/23253540/205345878-4952929d-b3eb-46bd-8de3-12ccb70dc0e1.png)

> ğŸ’¡ Step2 æˆªå›¾ä¸ºç°è‰²ä»…ä¸ºäº†åŒºåˆ«äº Step3 å¯äº¤äº’çŠ¶æ€ï¼Œå®é™…ç”¨æˆ·çœ‹åˆ°çš„æ•ˆæœä¸ Step3 æ— å·®å¼‚


ä¸ºäº†è§£å†³**åç«¯æ¥å£å»¶æ—¶ä¸å¯æ§**é€ æˆçš„ Step1 é˜¶æ®µç™½å±æ—¶é—´è¿‡é•¿çš„é—®é¢˜ï¼Œäºæ˜¯æˆ‘ä»¬å¼€å‘äº†`æ¸è¿›å¼æ¸²æŸ“`åŠŸèƒ½ï¼Œä¼˜åŒ–åçš„æ¸²æŸ“é“¾è·¯å˜æˆäº†å¦‚ä¸‹

![image](https://user-images.githubusercontent.com/23253540/205346406-22140efc-5844-4e9f-848a-242ee102e170.png)


##  2. <a name='SuspenseSSR'></a>Suspense SSR æ¶æ„
React18 æ–°çš„ Suspense SSR æ¶æ„å…è®¸ä½ åœ¨æœåŠ¡ç«¯ä½¿ç”¨ `Suspense` ç»„ä»¶ï¼Œæ¯”å¦‚ä½ çš„ `Comments` ç»„ä»¶æ˜¯éœ€è¦åç«¯æ¥å£çš„æ•°æ®ï¼Œé‚£ä¹ˆå¯ä»¥åšåˆ°åç«¯æ¥å£æ•°æ®ä»…é˜»å¡ `Comments` ç»„ä»¶ï¼Œä¸ä¼šé˜»å¡æ•´ä¸ª `App` ç»„ä»¶çš„æ¸²æŸ“ä¸æå‰è¿”å›

```html
<Layout>
  <NavBar />
  <Sidebar />
  <RightPane>
    <Post />
    <Suspense fallback={<Spinner />}>
      <Comments />
    </Suspense>
  </RightPane>
</Layout>
```
æ–° Suspense SSR æ¶æ„ä¸‹çš„æ¸²æŸ“é“¾è·¯å˜æˆäº†å¦‚ä¸‹
![image](https://user-images.githubusercontent.com/23253540/205346837-8a77e5ad-92f2-4827-a218-7a28f42b396f.png)


###  2.1. <a name='ssr_21'></a>å¯èƒ½å­˜åœ¨çš„é—®é¢˜
ä½ å¯èƒ½æƒ³åˆ°éƒ¨åˆ†å¯äº¤äº’çŠ¶æ€æ—¶ï¼Œå¦‚æœå®¢æˆ·ç«¯å…¶ä»–ç»„ä»¶å“åº”äº†äº‹ä»¶å¯¼è‡´ `Comment` ç»„ä»¶çš„ props å˜åŒ–ï¼Œè€ŒæœåŠ¡ç«¯æ˜¯æ ¹æ® initProps å¯¹ `Comment` è¿›è¡Œçš„æ¸²æŸ“ï¼Œé‚£ä¹ˆ React ä¼šå¦‚ä½•å–èˆ

```js
function Content() {
  const [count, setCount] = useState(0);

  return (
    <Layout>
      <NavBar />
      <Sidebar />
      <RightPane>
        <Post />
        <h2
            onClick={() => {
              setCount(count + 1)
              console.log("setCount ç‚¹å‡»äº‹ä»¶æµ‹è¯•, count: ", count);
            }}
          >
            setCount ç‚¹å‡»äº‹ä»¶æµ‹è¯•
        </h2>
        <Suspense fallback={<Spinner />}>
          <Comments count={count}/>
        </Suspense>
      </RightPane>
    </Layout>
  );
}

function Comments({ count }) {
  const comments = useData();

  return (
    <>
    <span>count: {count}</span>
      {comments.map((comment, i) => (
        <p className="comment" key={i}>
          {comment}
        </p>
      ))}
    </>
  );
}
```
ä»æµ‹è¯•ç»“æœæ¥çœ‹ Props å‘ç”Ÿå˜åŒ–å React ä¼šä»¥å®¢æˆ·ç«¯æœ€æ–°æ¸²æŸ“çš„ç»“æœä¸ºå‡†, ä¸æ­¤åŒæ—¶æŠ›å‡º`Uncaught Error: This Suspense boundary received an update before it finished hydrating.`é”™è¯¯
![image](https://user-images.githubusercontent.com/23253540/205336013-af20351d-9719-48ac-ac05-469e51840fc9.png)

##  3. <a name='ssr_30'></a>åº”ç”¨åˆ°ä¸šåŠ¡ä¸­çš„æ•ˆæœ
å› ä¸º Suspense æ”¯æŒå¯¹äºå•ä¸ªç»„ä»¶è¿›è¡Œçš„å»¶è¿Ÿæ¸²æŸ“ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦å¯¹é¡µé¢ç»„ä»¶è¿›è¡Œæ‹†åˆ†ï¼ŒåŒæ—¶ä½¿ç”¨ Suspense è¿›è¡ŒåŒ…è£¹

![image](https://user-images.githubusercontent.com/23253540/205336541-f42ae8f7-7050-48e5-92c3-3533db33e853.png)

å¦‚æœå‡çº§åˆ°äº†æ–° Suspense SSR æ¶æ„ä¸‹çš„æ¸²æŸ“é“¾è·¯å˜æˆäº†å¦‚ä¸‹
![image](https://user-images.githubusercontent.com/23253540/205347267-453f4391-f7ed-4902-9438-b19e1b4c619b.png)


##  4. <a name='ssr_40'></a>å°ç»“
##### Suspense SSR æ¶æ„è§£å†³äº†æœåŠ¡ç«¯æ¸²æŸ“å„ä¸ªæµç¨‹ä¸²è¡Œç­‰å¾…é—®é¢˜ï¼Œå¼ºè°ƒä¸€åˆ‡æŒ‰éœ€ï¼ˆæ‡’åŠ è½½ï¼Œæ‡’ç¼–è¯‘ï¼Œç°åœ¨æ˜¯æ‡’æ¸²æŸ“ï¼Ÿï¼‰è¿›è¡Œ
- æ¸è¿›å¼æ¸²æŸ“åƒæ˜¯ React åŸç”Ÿä¸æ”¯æŒ Suspense SSR ä¸‹çš„æ¨¡æ‹Ÿå®ç°

##### æ¸è¿›å¼æ¸²æŸ“é¦–å±æ¯” Suspense SSR æ›´åŠ å®Œæ•´
- æ¸è¿›å¼æ¸²æŸ“: æœåŠ¡ç«¯æ¸²æŸ“æ—¶è™½ç„¶æ²¡æœ‰æ¥å£æ•°æ®ï¼Œä½†æ ¹æ® initState èƒ½å¤Ÿæ¸²æŸ“å‡ºè¾ƒå®Œæ•´çš„é¦–å±
- Suspense SSR: éœ€è¦æ¥å£æ•°æ®çš„ç»„ä»¶é¦–å±éƒ½æ˜¯æ¸²æŸ“çš„å ä½ç»„ä»¶ï¼Œå¦‚ Spinner

##### Suspense SSR ç±»ä¼¼äºæ‡’æ¸²æŸ“ï¼Œè®¾è®¡ç†å¿µæ›´åŠ ç¬¦åˆç°ä»£åŒ– Web å¼€å‘
- æ›´å¤šç‰¹æ€§è§: [New Suspense SSR Architecture in React 18](https://github.com/reactwg/react-18/discussions/37)

##  5. <a name='ssr_50'></a>æœ€åçš„è¯
å¦‚æœå‘ç°å‡çº§åé¡µé¢æ²¡æœ‰è¿›è¡Œåˆ†å—æ¸²æŸ“, æˆ–è®¸ä½ è¦ç»§ç»­é˜…è¯» ğŸ‘‰ [æœåŠ¡ç«¯æµå¼æ¸²æŸ“ iOS ä¸­è¸©å‘è®°](https://github.com/xiaoxiaojx/blog/issues/37)

