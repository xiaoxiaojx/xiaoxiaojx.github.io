---
title: æµ…æ Turbopack å‡½æ•°çº§åˆ«ç¼“å­˜çš„å®ç°
date: 2024/07/10
tag: Rust
author: å¤šå°å‡¯
---

![image](https://github.com/user-attachments/assets/57778064-24cd-4758-b989-73a15afc2700)

Turbopack ä¸ºä½•æ‰“åŒ…é€Ÿåº¦å¦‚æ­¤ä¹‹å¿«ï¼Ÿå®ƒçš„å®˜ç½‘ä¸­æåˆ°äº†ä¸¤ç‚¹
1. ***highly optimized machine code***ï¼Œç¬¬ä¸€ç‚¹å¾ˆå¥½ç†è§£ï¼Œè¿‘å¹´æ¥æ–°å‡ºæ¥çš„æ— è®ºæ˜¯åŸºäº Go çš„ esbuild è¿˜æ˜¯åŸºäº Rust çš„ Turbopack ç›¸æ¯”äºåŸºäº JavaScript çš„ webpack åœ¨è¯­è¨€å±‚é¢å°±å­˜åœ¨å¤©ç„¶çš„ä¼˜åŠ¿ã€‚å¯¹äº JIT ç¼–è¯‘è¯­è¨€ JavaScript æ¥è¯´ï¼Œå‘½ä»¤è¡Œåº”ç”¨ç¨‹åºæ˜¯æœ€ç³Ÿç³•çš„æ€§èƒ½æƒ…å†µã€‚æ¯æ¬¡è¿è¡Œæ‰“åŒ…æ—¶ï¼ŒJavaScript VM éƒ½ä¼šç¬¬ä¸€æ¬¡çœ‹åˆ°æ‰“åŒ…å·¥å…·çš„ä»£ç ï¼Œè€Œæ²¡æœ‰ä»»ä½•ä¼˜åŒ–æç¤ºã€‚å½“ esbuild / Turbopack å¿™äºè§£ææ‚¨çš„ JavaScript ä¸šåŠ¡ä»£ç æ—¶ï¼ŒJavaScript VM æ­£å¿™äºè§£ææ‚¨çš„æ‰“åŒ…å·¥å…·çš„ JavaScriptã€‚å½“ JavaScript VM å®Œæˆè§£ææ‚¨çš„æ‰“åŒ…å·¥å…·çš„ä»£ç æ—¶ï¼Œesbuild / Turbopack å¯èƒ½å·²ç»é€€å‡ºï¼Œå¹¶ä¸”æ‚¨çš„æ‰“åŒ…å·¥å…·ç”šè‡³è¿˜æ²¡æœ‰å¼€å§‹æ‰“åŒ…åˆ†æ JavaScript ä¸šåŠ¡ä»£ç 
2. ***a low-level incremental computation engine that enables caching down to the level of individual functions***ï¼Œç¬¬äºŒç‚¹æåˆ°èƒ½å¤Ÿå°†ç¼“å­˜çº§åˆ«ç»†åˆ†åˆ°å‡½æ•°çº§åˆ«ï¼Œä½¿å¾— Turbopack ä¸ä¼šè¿è¡ŒåŒæ ·çš„å·¥ä½œä¸¤æ¬¡?!

çœ‹å®Œç¬¬ 2 ç‚¹å…¶å®æ˜¯æ¯”è¾ƒç–‘æƒ‘çš„ï¼Œä½•ä¸ºå‡½æ•°çº§åˆ«ï¼Ÿåœ¨å¸¸è§„çš„æ‰“åŒ…å·¥å…·çš„ç¼“å­˜å®ç°ä¸­ï¼Œæ¯”å¦‚æ–‡ä»¶ ```src/index.js``` ç¬¬ä¸€æ¬¡æ‰“åŒ…å®Œæˆåï¼Œç¬¬äºŒæ¬¡ç”±äºè¯¥æ–‡ä»¶ contenthash æ²¡å˜å°±å¯ä»¥ç›´æ¥ç¼“å­˜ä¸Šä¸€æ¬¡æ‰“åŒ…çš„ç»“æœï¼Œéš¾é“ Turbopack çš„å‡½æ•°çº§åˆ«æŒ‡çš„æ˜¯æŸä¸ªæ–‡ä»¶å³ä½¿ contenthash å˜äº†ï¼Œå¦‚æœæ–‡ä»¶ä¸­çš„æŸå‡ ä¸ªå‡½æ•°æ²¡å˜ä¹Ÿèƒ½åˆ©ç”¨å¤§éƒ¨åˆ†ç¼“å­˜ç»“æœå¿«é€Ÿè¿”å›? ä¸‹é¢å¸¦ç€è¿™äº›ç–‘é—®è®©æˆ‘ä»¬å°è¯•ä» Turbopack æºç ä¸­æ‰¾åˆ°ç­”æ¡ˆ

å½“æˆ‘ç²—ç•¥é˜…è¯»äº†å‡ é Turbopack æºç åè²Œä¼¼å°±æ‰¾åˆ°äº†ä¸€äº›è››ä¸é©¬è¿¹ï¼Œæ¯”å¦‚å¦‚ä¸‹æœ‰å¤§é‡çš„å‡½æ•°è¢« ```#[turbo_tasks::function]``` å®å®šä¹‰ç»™ä¿®é¥°äº†

![image](https://github.com/user-attachments/assets/0b208765-9ebc-47a2-8b61-bb2ebac4958a)

æˆ‘ä»¬å…ˆä½¿ç”¨ ```cargo expand``` å‘½ä»¤æŠŠè¿™ä¸ªå®ä¿®è¾åçš„ä»£ç å±•å¼€å°±æ˜¯å¦‚ä¸‹çš„ä»£ç 

![image](https://github.com/user-attachments/assets/79c76ec4-fa81-4cfb-a3ed-4e35a2af4289)

çœ‹åˆ°å±•å¼€åçš„ä»£ç æˆ‘ä¼¼ä¹å·²ç»æ˜ç™½äº†ï¼Œä¸‹é¢æˆ‘æŠŠè¿™ä¸ªè¡Œä¸ºæ¢æˆ JavaScript ä»£ç ä¾¿äºå¤§å®¶ç†è§£ï¼Œæ¯”å¦‚ä½ çš„æ‰“åŒ…å·¥å…· my_turbopack æœ‰ä¸ª ```build_internal``` å‡½æ•°
```ts
async function build_internal(project_dir: string, root_dir: string) {
    console.log('å¼€å§‹æ‰“åŒ… ğŸ“¦ ...')
}
```
ç»è¿‡  ```#[turbo_tasks::function]``` å®ä¿®é¥°åä½ çš„ ```build_internal``` å‡½æ•°å°±å¤§è‡´å˜ä¸ºäº†å¦‚ä¸‹è¿™æ ·ï¼ˆå½“ç„¶å®é™… Turbopack çš„å®ç°ä¼šå¤æ‚å¾ˆå¤š!ï¼‰
```ts
const compiler_cache = {}

async function build_internal(project_dir: string, root_dir: string) {
    // æœ€ç®€æ¨¡å‹çš„è®¡ç®—
    const cache_key = project_dir + root_dir
    if (compiler_cache[cache_key]) {
        return compiler_cache[cache_key]
    }
    return compiler_cache[cache_key] = build_internal_inline_function(project_dir: string, root_dir: string)
}

async function build_internal_inline_function(project_dir: string, root_dir: string) {
    console.log('å¼€å§‹æ‰“åŒ… ğŸ“¦ ...')
}
```
çœ‹åˆ°è¿™é‡Œæ˜¯ä¸æ˜¯å°±è±ç„¶å¼€æœ—äº†ï¼Œæ‰€è°“å‡½æ•°çº§åˆ«ç¼“å­˜ Turbopack ä¸ä¼šè¿è¡ŒåŒæ ·çš„å·¥ä½œä¸¤æ¬¡çš„åº•å±‚åŸç†å…¶å®å°±æ˜¯æŸä¸€ä¸ªæ„å»ºä»»åŠ¡å‡½æ•°å¦‚æœå…¥å‚æ²¡å˜ï¼ˆç»è¿‡ä¸€å®šçš„è§„åˆ™è®¡ç®—åï¼‰ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç›´æ¥è¿”å›ä¸Šä¸€æ¬¡è¿è¡Œçš„ç»“æœ!

æ¥ä¸‹æ¥è®©æˆ‘ä»¬æ¥éªŒè¯ä¸‹ï¼Œäºæ˜¯å†™ä¸€ä¸ª  ```#[turbo_tasks::function]``` å®å®šä¹‰ä¿®è¾çš„ ```turbo_test_fn``` å‡½æ•°å’Œä¸€ä¸ªæ™®é€šçš„ ```normal_test_fn```ï¼Œæœ€åè¿è¡Œæ—¶å‘ç° ```turbo_test_fn``` åœ¨å‚æ•°æ²¡å˜çš„æƒ…å†µä¸‹åªä¼šè¿è¡Œä¸€æ¬¡è€Œ ```normal_test_fn``` ä¼šè°ƒç”¨ä¸€æ¬¡è¿è¡Œä¸€æ¬¡ï¼Œç¬¦åˆé¢„æœŸ!

![image](https://github.com/user-attachments/assets/8bcc4bcf-8338-4939-b5be-ff0cbe849ab7)
