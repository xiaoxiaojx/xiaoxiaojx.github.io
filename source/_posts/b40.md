---
title: åŒæ­¥æ—¥å¿—å†™å…¥å¯¼è‡´çš„ Node.js æ€§èƒ½ä¸Šæ¶¨
date: 2023/7/13
tag: Node.js
author: å¤šå°å‡¯
---

<img width="1439" alt="image" src="https://github.com/xiaoxiaojx/blog/assets/23253540/15bb6872-dbf9-40ce-9b75-9e2fac151412">

## èƒŒæ™¯
Q åŒå­¦åæ˜ è‡ªå·±è´Ÿè´£çš„ SSR é¡¹ç›®çº¿ä¸Šç¯å¢ƒ Node.js æ€§èƒ½æŒ‡æ ‡ [é¦–å­—èŠ‚ TTFB](https://web.dev/ttfb/) ä¸Šæ¶¨äº†çº¦ 30ms, è€Œå½“æ¬¡å‘å¸ƒæ²¡æœ‰æ¶‰åŠé…ç½®çš„å˜æ›´ã€åŸºç¡€åŒ…çš„å‡çº§ç­‰, ç”šè‡³åŒæ ·çš„ä»£ç é‡æ–°æ„å»ºå‘å¸ƒåˆæ¢å¤æ­£å¸¸äº†...

## é—®é¢˜æ’æŸ¥
### Cat ç›‘æ§
é¦–å…ˆæŸ¥çœ‹äº†ä¸€ä¸‹ç›‘æ§ç³»ç»Ÿ, å‘ç° SSR é¡¹ç›®æ¶‰åŠçš„æ¸²æŸ“æ—¶å»¶ Transaction , åç«¯æ¥å£æ—¶å»¶ Transaction ç­‰å…³é”®æŒ‡æ ‡å‡æ²¡æœ‰æ˜æ˜¾æ³¢åŠ¨
> è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çš„ [Cat](https://github.com/dianping/cat) è¿›è¡Œçš„æ•°æ®é‡‡é›†, ä¸‹å›¾ä¸º Cat ç›‘æ§ç¤ºä¾‹å›¾ä¸æœ¬æ¬¡æ— å…³

![](https://camo.githubusercontent.com/0f7b7432f8e51a53e0c996079567773974901440e8480f3751a5e4f7b2a58a66/68747470733a2f2f7261772e6769746875622e636f6d2f6469616e70696e672f6361742f6d61737465722f6361742d686f6d652f7372632f6d61696e2f7765626170702f696d616765732f6c6f6776696577416c6c30312e706e67)
äºæ˜¯åªèƒ½è¿½åŠ äº†æ›´å¤šçš„æ—¶å»¶ Transaction æ‰“ç‚¹, æœ€ç»ˆå‘ç°ç«Ÿç„¶æ˜¯ä¸€è¡Œæ—¥å¿—è¾“å‡ºæ—¶è€Œè¾¾åˆ°äº† 15ms æ—¶è€Œåˆå°äº 1ms åˆ°å¯ä»¥å¿½ç•¥, æ¯ä¸ªè¯·æ±‚å­˜åœ¨ä¸¤æ¡è¿™æ ·çš„æ—¥å¿—è¾“å‡ºæ•…å¯¼è‡´æ€§èƒ½ä¸Šæ¶¨äº† 30ms ğŸ¤¯

```js
// SSR

ctx.logger.info('[xxx] xxx success, ret: %o', ret)
```

### pino æ—¥å¿—
å¯¹äºä¸Šé¢ä¸€ä¸ªå°äº 200 å­—ç¬¦ä¸²çš„æ—¥å¿—è¾“å‡ºä¸ºä»€ä¹ˆä¼šæ¶ˆè€—äº† 15ms, ç»§ç»­æŸ¥çœ‹ä»£ç å‘ç°ä½¿ç”¨çš„ logger å…¶å®æ˜¯åŸºäº [pino](https://github.com/pinojs/pino) 6.11.3 ç‰ˆæœ¬
```js
// SSR

import pino from 'pino'

const logger = pino(opts, pino.destination())
```
![](https://github.com/pinojs/pino/raw/master/pino-banner.png)
ç„¶åå†æŸ¥çœ‹ pino.destination çš„å®ç°å‘ç°äº†æ¯”è¾ƒåˆºçœ¼çš„`sync: true`ä¼ å‚
```js
// https://github.com/pinojs/pino/blob/v6.11.3/pino.js

module.exports.destination = (dest = process.stdout.fd) => {
  if (typeof dest === 'object') {
    dest.dest = dest.dest || process.stdout.fd
    return buildSafeSonicBoom(dest)
  } else {
    return buildSafeSonicBoom({ dest, minLength: 0, sync: true })
  }
}
```
ç»§ç»­æ·±æŒ–å‘ç°å½“ä¼ å‚æ˜¯`sync: true`æ—¶ä¼šè°ƒç”¨`fs.writeSync(process.stdout.fd`å»å†™æ—¥å¿—, å¯ä»¥ç†è§£ä¸ºç­‰åŒäº`console.log`
```js
// https://github.com/pinojs/sonic-boom/blob/1.x/index.js

if (sonic.sync) {
    try {
        const written = fs.writeSync(sonic.fd, buf, 'utf8')
        release(null, written)
    } catch (err) {
        release(err)
    }
} else {
    fs.write(sonic.fd, buf, 'utf8', release)
}
```
### k8s æ”¯æŒ
æœ€åè¯¢é—®äº† k8s çš„åŒå­¦, ä¸ºä»€ä¹ˆä¸€è¡ŒåŒæ­¥è¾“å‡ºçš„æ—¥å¿—æ—¶å»¶æ³¢åŠ¨è¿™ä¹ˆå¤§ï¼Ÿ k8s åŒå­¦ç»™å‡ºçš„å›ç­”æ˜¯æˆ‘ä»¬çš„ Pod ä¸Šçš„æ ‡å‡†è¾“å‡ºä¼šè½åˆ°äº‘ç›˜ä¸­, ç½‘ç»œæŠ–åŠ¨å°±å¯èƒ½é€ æˆè¿™æ ·çš„æ³¢åŠ¨

### ChatGPT æ”¯æŒ

å½“ç„¶ k8s çš„åŒå­¦ä¸ä¼šå¿½æ‚ æˆ‘, ä½†æœ¬ç€å­¦ä¹ çš„å¿ƒç†è®©æˆ‘ä»¬ç»§ç»­å‘ ChatGPT ğŸ¤–ï¸ æ¥æ¢ç´¢ä¸€ä¸‹è¿™ä¸ªé—®é¢˜ã€‚å½“ k8s æ ‡å‡†è¾“å‡ºè½åˆ°äº‘ç›˜çš„åœºæ™¯ä¸­, åŒæ­¥æ—¥å¿—è¾“å‡ºæ˜¯å¦ä¼šé˜»å¡ç¨‹åºç›´åˆ°äº‘ç›˜å†™å…¥æˆåŠŸ? 
> ChatGPT ğŸ¤–ï¸: åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œç¨‹åºçš„æ ‡å‡†è¾“å‡ºæ—¥å¿—æ˜¯é€šè¿‡æ ‡å‡†è¾“å‡ºæµï¼ˆstdoutï¼‰è¾“å‡ºçš„ï¼Œè€Œæ ‡å‡†è¾“å‡ºæµé€šå¸¸æ˜¯å®æ—¶è¾“å‡ºçš„ï¼Œå³æ—¶å†™å…¥åˆ°æ—¥å¿—æ–‡ä»¶æˆ–äº‘ç›˜ä¸­ã€‚å› æ­¤ï¼Œå½“ä½ åœ¨ç¨‹åºä¸­æ‰“å°ä¸€æ¡æ—¥å¿—æ—¶ï¼Œå®ƒä¸ä¼šè¢«é˜»å¡åˆ°å†™å…¥äº‘ç›˜ç›´åˆ°æˆåŠŸã€‚ç›¸åï¼Œå®ƒä¼šå°½å¿«åœ°å†™å…¥åˆ°æ ‡å‡†è¾“å‡ºæµä¸­ã€‚
ç„¶è€Œï¼Œå…·ä½“çš„æ—¥å¿—å†™å…¥åˆ°äº‘ç›˜çš„é€Ÿåº¦å–å†³äºå¤šä¸ªå› ç´ ï¼Œå¦‚ç£ç›˜æ€§èƒ½ã€ç½‘ç»œå»¶è¿Ÿç­‰ã€‚å¦‚æœå†™å…¥åˆ°äº‘ç›˜çš„é€Ÿåº¦è¾ƒæ…¢ï¼Œå¯èƒ½ä¼šå¯¼è‡´ä¸€äº›æ—¥å¿—æ¶ˆæ¯åœ¨å†™å…¥è¿‡ç¨‹ä¸­è¢«å †ç§¯ã€‚è¿™å¯èƒ½ä¼šå¯¼è‡´ç¨‹åºçš„æ ‡å‡†è¾“å‡ºæµç¼“å†²åŒºå¡«æ»¡ï¼Œä»è€Œå¯¼è‡´ç¨‹åºé˜»å¡æˆ–å‡ºç°å…¶ä»–é—®é¢˜ã€‚

## é—®é¢˜è§£å†³
é€šè¿‡ä¼ å…¥`sync: false`æ¥è¿›è¡Œå¼‚æ­¥å†™å…¥æ—¥å¿—å³å¯è§£å†³æœ¬æ¬¡çš„é—®é¢˜
```js
import pino from 'pino'

const logger = pino(opts, pino.destination({ sync: false }))
```
## é—®é¢˜æ¢ç´¢
è¿™é‡Œä¸€ä¸ªç–‘é—®æ˜¯ ChatGPT æŒ‡å‡ºåŒæ­¥è¾“å…¥æ—¥å¿—ä¼šå…ˆå†™å…¥ç¼“å†²åŒº, æ‰€ä»¥ä¸ä¼šé˜»å¡, é‚£ä¹ˆå®é™…æƒ…å†µæˆ‘ä»¬è¿˜æ˜¯è¢«é˜»å¡äº† 15ms äº†?

å¯¹ Node.js æºç æ¯”è¾ƒäº†è§£çš„åŒå­¦åº”è¯¥çŸ¥é“ Node.js ç¨‹åºåˆšå¼€å§‹è¿è¡Œçš„ä»£ç ä¸­å°±é€šè¿‡ [setvbuf](https://en.cppreference.com/w/c/io/setvbuf) ç³»ç»Ÿè°ƒç”¨æŠŠç¼“å†²åŒºç»™ç¦æ­¢æ‰äº†...
```c
// https://github.com/nodejs/node/blob/main/src/node.cc#L486

int main(int argc, char* argv[]) {
  // ...

  // Disable stdio buffering, it interacts poorly with printf()
  // calls elsewhere in the program (e.g., any logging from V8.)
  setvbuf(stdout, nullptr, _IONBF, 0);
  setvbuf(stderr, nullptr, _IONBF, 0);
  return node::Start(argc, argv);
}
```
æ‰€ä»¥æˆ‘ä»¬æŠŠä¼ å‚æ”¹ä¸º`sync: false`æ—¶, çœ‹çœ‹ [sonic-boom](https://github.com/pinojs/sonic-boom) æ˜¯å¦‚ä½•å®ç°

è™½ç„¶ Node.js ç¦æ­¢äº†ç³»ç»Ÿè¾“å‡ºæµçš„ç¼“å†²è¡Œä¸º, ä¸ä»£è¡¨ JavaScript å±‚é¢ä¸å¯ä»¥é€šè¿‡æŠŠæ•°æ®ç¼“å­˜åœ¨å†…å­˜ä¸­è¿›è¡Œæ¨¡æ‹Ÿå®ç°, å®é™… sonic-boom å°±æ˜¯è¿™æ ·å»åšçš„

```js
// https://github.com/nodejs/node/blob/main/src/node.cc#L486

SonicBoom.prototype.write = function (data) {
  if (this.destroyed) {
    throw new Error('SonicBoom destroyed')
  }

  this._buf += data
  const len = this._buf.length
  if (!this._writing && len > this.minLength) {
    actualWrite(this)
  }
  return len < 16384
}
```

æœ€åè¦è¯´æ˜çš„ä¸€ç‚¹æ˜¯å½“ sonic-boom è®¾ç½®çš„ç¼“å­˜æ•°æ®ä¸Šé™å, å¼€å§‹è¿›è¡Œ i/o å†™å…¥æ“ä½œæ—¶ä¼šæœ‰ä¸€ä¸ªè¯·æ±‚ä¼šè¢«é˜»å¡ï¼Ÿ

![image](https://github.com/xiaoxiaojx/blog/assets/23253540/5c897579-6b05-4d16-be16-e200006736c7)

å…¶å®æ˜¯ä¸ä¼šçš„, å½“è¾¾åˆ°è®¾ç½®çš„ä¸Šé™å€¼ sonic-boom ä¼šè°ƒç”¨`fs.write`å»å¼‚æ­¥å†™å…¥æ—¥å¿—, è€Œå†™å…¥è¿™ä¸ªæ“ä½œæ˜¯åœ¨å­çº¿ç¨‹ä¸­è¿›è¡Œçš„, æ•…ä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹, è¿™éƒ¨åˆ†å†…å®¹è§æˆ‘ä¹‹å‰å†™çš„[ã€libuv æºç å­¦ä¹ ç¬”è®°ã€‘çº¿ç¨‹æ± ä¸i/o](https://github.com/xiaoxiaojx/blog/issues/2)
```js
fs.write(sonic.fd, buf, 'utf8', release)
```