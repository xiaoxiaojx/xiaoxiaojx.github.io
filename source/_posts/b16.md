---
title: MacBook M1 ç¼–è¯‘ v8 é—®é¢˜è®°å½•
date: 2022/5/29
description: M1 ç¼–è¯‘ v8 ä¸ºå•¥è¿™ä¹ˆå¤šå‘ ðŸ˜¢
tag: v8, C++
author: å¤šå°å‡¯
---

![image](https://user-images.githubusercontent.com/23253540/170865214-978cf78c-9e9b-498e-b1f9-eee04b862731.png)


> ä¸»è¦å‚è€ƒäº† [å•ç‹¬ç¼–è¯‘ V8 å¼•æ“Ž](https://zhuanlan.zhihu.com/p/102316528) ä¸Ž [Building V8 on an M1 MacBook](https://joyeecheung.github.io/blog/2021/08/27/binding-v8-on-an-m1-macbook/), ä¸‹é¢è®°å½•äº†ä¸€ä¸‹æž„å»ºè¿‡ç¨‹ä¸­é‡è§çš„å…¶ä»–å‘ç‚¹, M1 ç¼–è¯‘ v8 ä¸ºå•¥è¿™ä¹ˆå¤šå‘ ðŸ˜¢ã€‚

## Failed to fetch file gs://chromium-gn/xxx
* é—®é¢˜ç®€è¿°: è¿è¡Œ gclient sync å‘½ä»¤ä¸‹è½½æ›´æ–°æž„å»ºå·¥å…·é“¾æ—¶æŠ›çš„é”™è¯¯, è°·æ­Œäº†ä¸€ä¸‹ç›¸å…³çš„ Issue è¾ƒå°‘, æ²¡æœ‰æœ‰æ•ˆçš„è§£å†³åŠžæ³•ã€‚
```bash
0> Failed to fetch file gs://chromium-gn/f08024240631f4974bb924b2f05712df185263ea for /Users/xxx/v8/buildtools/mac/gn, skipping. [Err: Traceback (most recent call last):
  File "/Users/xxx/depot_tools/gsutil.py", line 182, in <module>
    sys.exit(main())
```

æŠ¥é”™å †æ ˆçš„ä»£ç åœ¨ depot_tools/gsutil.py æ–‡ä»¶ï¼Œä¹Ÿè®¸æ˜¯ä»£ç†çš„é—®é¢˜
![image](https://user-images.githubusercontent.com/23253540/170861915-094ca8f1-ceee-4ba1-bed4-c2d01b93db22.png)
æ‰€ä»¥è¿™é‡Œåº”è¯¥æ˜¯è¦ç»™ urllib åŠ ä¸Š http ä»£ç†, ç„¶åŽæŸ¥é˜…ä¸€ä¸‹ python å¦‚ä½•ç»™ urllib è®¾ç½®ä»£ç†
```python
// depot_tools/gsutil.py

try:
  import urllib2 as urllib
except ImportError:  # For Py3 compatibility
  import urllib.request as urllib
 
proxy_support = urllib.ProxyHandler({'http' : 'http://127.0.0.1:8118' })
opener = urllib.build_opener(proxy_support)
urllib.install_opener(opener)
```
* é—®é¢˜è§£å†³: æœ€åŽæ‰‹åŠ¨ä¿®æ”¹ gsutil.py ä»£ç ç»™ urllib è®¾ç½®äº† ProxyHandler åŽ, ä¸è¿‡ depot_tools ä¼šæ£€æµ‹æ–‡ä»¶çš„å®Œæ•´æ€§, å³å‘çŽ°å¦‚ä¸Šä¿®æ”¹äº†ä»£ç å°±ä¼šæŠ¥é”™, æ­¤æ—¶æˆ‘ä»¬è¿˜éœ€è¦æ³¨é‡ŠæŽ‰è¿™éƒ¨åˆ†æ£€æµ‹çš„ä»£ç , æœ€åŽå†æ¬¡è¿è¡Œ gclient sync å‘½ä»¤å°± ok äº†

```diff
// depot_tools/gclient_scm.py

- Make sure the tree is clean; see git-rebase.sh for reference
- try:
-   scm.GIT.Capture(['update-index', '--ignore-submodules', '--refresh'],
-                   cwd=self.checkout_path)
- except subprocess2.CalledProcessError:
-   raise gclient_utils.Error('\n____ %s at %s\n'
-                             '\tYou have unstaged changes.\n'
-                             '\tPlease commit, stash, or reset.\n'
-                              % (self.relpath, revision))
- try:
-   scm.GIT.Capture(['diff-index', '--cached', '--name-status', '-r',
-                    '--ignore-submodules', 'HEAD', '--'],
-                   cwd=self.checkout_path)
- except subprocess2.CalledProcessError:
-   raise gclient_utils.Error('\n____ %s at %s\n'
-                             '\tYour index contains uncommitted changes\n'
-                             '\tPlease commit, stash, or reset.\n'
-                               % (self.relpath, revision))
```

## NOTICE: You have PROXY values set in your environment
```bash
NOTICE: You have PROXY values set in your environment, but gsutilin depot_tools does not (yet) obey them.
Also, --no_auth prevents the normal BOTO_CONFIG environmentvariable from being used.
To use a proxy in this situation, please supply those settingsin a .boto file pointed to by the NO_AUTH_BOTO_CONFIG environmentvariable.
```
* é—®é¢˜è§£å†³: æ–°å¢ž .boto æ–‡ä»¶, ç„¶åŽè®¾ç½® NO_AUTH_BOTO_CONFIG çŽ¯å¢ƒå˜é‡å†æŽ¥ç€è¿è¡Œ
```
[Boto]
proxy = 127.0.0.1
proxy_port = 8118
proxy_type = http
```

```bash
export NO_AUTH_BOTO_CONFIG=/Users/xxx/.boto
```

## https://commondatastorage.googleapis.com/**
* é—®é¢˜ç®€è¿°: pythone è„šæœ¬çš„è¯·æ±‚çš„æµé‡ä¸ä¼šèµ°ç³»ç»Ÿä»£ç†, å¯¼è‡´è¿žæŽ¥ä¸åˆ° google æœåŠ¡, çµæœºä¸€åŠ¨å°±å…ˆè½¬å‘åˆ°æœ¬åœ°æœåŠ¡, æœ¬åœ°æœåŠ¡å†é€šè¿‡è®¾ç½® httpClientAent ä¸ºç³»ç»Ÿå…¨å±€ä»£ç†åœ°å€æ¥å®žçŽ°
* é—®é¢˜è§£å†³: å…¨å±€æ›¿æ¢ https://commondatastorage.googleapis.com ä¸º http://127.0.0.1:3000 , ç„¶åŽé€šè¿‡æœ¬åœ°æœåŠ¡è½¬å‘è¯·æ±‚
```js
const Koa = require("koa");
const proxy = require("koa-proxies");
const httpsProxyAgent = require('https-proxy-agent')

const app = new Koa();

app.use(
  proxy(/^\//, {
    target: "https://commondatastorage.googleapis.com",
    agent: new httpsProxyAgent('http://127.0.0.1:8118'),

    logs: false,
    changeOrigin: true,
    headers: {
      Origin: "https://commondatastorage.googleapis.com",
      Host: "commondatastorage.googleapis.com",
      Referer: "https://commondatastorage.googleapis.com",
    },
    secure: false,
    events: {
    //   proxyRes: (proxyRes, _req, res) => {
    //     let removeSecure = (str) => str.replace(/;Secure/i, "");
    //     let set = proxyRes.headers["set-cookie"];
    //     if (set) {
    //       let result = Array.isArray(set)
    //         ? set.map(removeSecure)
    //         : removeSecure(set);
    //       res.setHeader("set-cookie", result);
    //       proxyRes.headers["set-cookie"] = result;
    //     }
    //   },
    },
  })
);

app.listen(3000)
```



## clang++: error: argument unused during compilation
* é—®é¢˜è§£å†³: å¢žåŠ  -Qunused-arguments å‚æ•°ä½¿ç¼–è¯‘å™¨å¿½ç•¥è¿™ä¸ªé”™è¯¯
```diff
// v8/build/config/mac/BUILD.gn

if (host_os == "mac") {
  common_mac_flags += [
    "-arch",
    clang_arch,
+    "-Qunused-arguments"
  ]
} else {
  common_mac_flags += [ "--target=$clang_arch-apple-macos" ]
}
```

## Embedder-vs-V8 build configuration mismatch.
```
# Fatal error in , line 0
# Embedder-vs-V8 build configuration mismatch. On embedder side pointer compression is DISABLED while on V8 side it's ENABLED.
#
#
#
#FailureMessage Object: 0x16fc2a918
```
* é—®é¢˜è§£å†³: ç¼–è¯‘å‚æ•°åŠ ä¸Š -DV8_COMPRESS_POINTERS -DV8_ENABLE_SANDBOX
```bash
g++ src/pure.cc -g -I deps/v8/include/ -o pure -L lib/ -lv8_monolith -pthread -std=c++17 -DV8_COMPRESS_POINTERS -DV8_ENABLE_SANDBOX
```

## unknown current_cpu $current_cpu
* é—®é¢˜ç®€è¿°: è¿˜ä¸æ”¯æŒ arm64 å¹³å°ç¼–è¯‘ ?
* é—®é¢˜è§£å†³: ç¡®ä¿å¦‚ä¸‹å‡ æ­¥éƒ½åšåˆ°
```bash

# v8 ç›®å½•ä¸‹è¿è¡Œå¦‚ä¸‹å‘½ä»¤, æ”¯æŒ arm64
echo "mac-arm64" > .cipd_client_platform

# v8 ç›®å½•ä¸‹è¿è¡Œå¦‚ä¸‹å‘½ä»¤, æ”¯æŒ arm64
mkdir -p out.gn/arm64.release/
cat >> out.gn/arm64.release/args.gn <<EOF

dcheck_always_on = false
is_debug = false
target_cpu = "arm64"
v8_target_cpu = "arm64"

cc_wrapper="ccache"
EOF

# ä½¿ç”¨ v8gen ç”Ÿæˆ arm64 å¹³å°çš„ç¼–è¯‘é…ç½®
/Users/xxx/v8/tools/dev/v8gen.py arm64.release.sample

# ç¼–è¯‘ arm64 å¹³å°çš„ V8 çš„é™æ€åº“
ninja -C out.gn/arm64.release.sample v8_monolith
```