---
title: é€†å‘æŠ€æœ¯å­¦ä¹ 
date: 2023/8/4
tag: C++
author: å¤šå°å‡¯
---

```

â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—     â–ˆâ–ˆâ•—      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—     â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— 
â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘ â–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘
â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘
â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•    â•šâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â•      â•šâ•â•â•â•šâ•â•â•  â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â• 
                                                                
```

## èƒŒæ™¯

æœ€è¿‘å‡ºäºéœ€æ±‚éœ€è¦, å­¦ä¹ äº†ä¸€ä¸‹å¾®ä¿¡é€†å‘ [wxhelper](https://github.com/ttttupup/wxhelper) çš„å®ç°, wxhelper æš´éœ²äº†å¤§é‡çš„å¾®ä¿¡æ¥å£, ä½¿å¾—èƒ½å¤Ÿè½»æ˜“åŸºäºæ­¤å®ç°ä¸€ä¸ªå¾®ä¿¡æœºå™¨äºº ğŸ¤–ï¸ã€‚å› ä¸ºæ˜¯ç¬¬ä¸€æ¬¡æ¥è§¦é€†å‘ç›¸å…³æŠ€æœ¯, å‡ºäºå¥½å¥‡å°±è®°å½•ä¸€ä¸‹

## å®ç°åŸç†
```
                                      |----------------
--------------------------    æ³¨å…¥    |  WeChat.exe    |
| ConsoleApplication.exe  |â€”â€”â€”â€”â€”â€”â€”â€”>  |----------------           --------------    è®¿é—®      ---------
|                         |           | wxhelper.dll   |â€”â€”â€”â€”â€”â€”â€”â€”>| å¯åŠ¨httpæœåŠ¡  | <----------| clent |
|--------------------------           |-----------------          --------------              --------    

```
å¦‚ä¸Šçš„æµç¨‹å›¾
1. é¦–å…ˆéœ€è¦é€šè¿‡ä¸€äº›æ‰‹æ®µè·å–åˆ°å¾®ä¿¡ä¸­éœ€è¦è¢«æš´éœ²çš„å…³é”® Call, ä½œè€…æŠŠè‡ªå·±å¸¸ç”¨çš„æ–¹æ³•è®°å½•åœ¨ [wxhelper/wiki](https://github.com/ttttupup/wxhelper/wiki) æ–‡æ¡£, æ„Ÿå…´è¶£å¯ä»¥æŸ¥é˜…
2. ç¼–è¯‘ wxhelper dll ç¨‹åºæ³¨å…¥åˆ°å¾®ä¿¡è¿›ç¨‹
3. è¯¥ dll ä¼šåˆ›å»ºä¸€ä¸ªç«¯å£ä¸º 19088 çš„ http server å‘å¤–æä¾›æ¥å£æ¥å¼€æ”¾è°ƒç”¨å…³é”® Call çš„èƒ½åŠ›

ä¸‹é¢è®²ä¸€ä¸‹è¯¥ wxhelper dll å¦‚ä½•å®ç° hook å¾®ä¿¡çš„å…³é”® Call, å¦‚ä¸‹ dll å…¥å£å‡½æ•°ä¸»è¦æ˜¯è°ƒç”¨äº† initialize å‡½æ•°
```cpp
// src/dllMain.cc

BOOL APIENTRY DllMain(HMODULE hModule, DWORD ul_reason_for_call,
                      LPVOID lpReserved) {
  switch (ul_reason_for_call) {
    case DLL_PROCESS_ATTACH: {
      DisableThreadLibraryCalls(hModule);
      GlobalContext::GetInstance().initialize(hModule);
      break;
    }
    case DLL_THREAD_ATTACH: {
      break;
    }
    case DLL_THREAD_DETACH: {
      break;
    }
    case DLL_PROCESS_DETACH: {
      GlobalContext::GetInstance().finally();
      break;
    }
  }
  return TRUE;
}
```
initialize å‡½æ•°ä¸»è¦æ˜¯å¯åŠ¨äº†ä¸€ä¸ª http server
```cpp
// src/global_context.cc

void GlobalContext::initialize(HMODULE module) {
  state =GlobalContextState::INITIALIZING;
  module_ = module;
  #ifndef _DEBUG
  Utils::Hide(module);
  #endif
  UINT64 base = Utils::GetWeChatWinBase();
  config.emplace();
  config->Initialize();
  log.emplace();
  log->Initialize();
  http_server = std::unique_ptr<HttpServer>( new HttpServer(config->GetPort()));
  http_server->HttpStart();
  ThreadPool::GetInstance().Create(2, 8);
  mgr = std::unique_ptr<Manager>(new Manager(base));
  DB::GetInstance().init(base);
  state =GlobalContextState::INITIALIZED;
}
```
http server çš„è¯·æ±‚å¤„ç†å‡½æ•° HttpDispatch å³è¡¨ç¤ºäº†å‘å¤–æä¾›çš„ hook å¾®ä¿¡å…³é”® Call çš„å®ç°ã€‚ä»¥ /api/hookSyncMsg è·¯å¾„çš„è¯·æ±‚ä¸ºä¾‹, å¦‚æœå®¢æˆ·ç«¯æƒ³é€šè¿‡è°ƒç”¨è¯¥æ¥å£æ¥ç›‘å¬å¾®ä¿¡æ”¶åˆ°æ¶ˆæ¯çš„äº‹ä»¶
```cpp
// src/http_server_callback.cc

std::string HttpDispatch(struct mg_connection *c, struct mg_http_message *hm) {
  std::string ret;
   // ...
  if (mg_http_match_uri(hm, "/api/checkLogin")) {
    INT64 success = wxhelper::GlobalContext::GetInstance().mgr->CheckLogin();
    nlohmann::json ret_data = {
        {"code", success}, {"data", {}}, {"msg", "success"}};
    ret = ret_data.dump();
    return ret;
  } else if (mg_http_match_uri(hm, "/api/userInfo")) {
    common::SelfInfoInner self_info;
    INT64 success =
        wxhelper::GlobalContext::GetInstance().mgr->GetSelfInfo(self_info);
    nlohmann::json ret_data = {
        {"code", success}, {"data", {}}, {"msg", "success"}};
    if (success) {
      nlohmann::json j_info = {
          {"name", self_info.name},
          {"city", self_info.city},
          {"province", self_info.province},
          {"country", self_info.country},
          {"account", self_info.account},
          {"wxid", self_info.wxid},
          {"mobile", self_info.mobile},
          {"headImage", self_info.head_img},
          {"signature", self_info.signature},
          {"dataSavePath", self_info.data_save_path},
          {"currentDataPath", self_info.current_data_path},
          {"dbKey", self_info.db_key},
      };
      ret_data["data"] = j_info;
    }
    ret = ret_data.dump();
    return ret;
  } else if (mg_http_match_uri(hm, "/api/sendTextMsg")) {
    std::wstring wxid = GetWStringParam(j_param, "wxid");
    std::wstring msg = GetWStringParam(j_param, "msg");
    INT64 success =
        wxhelper::GlobalContext::GetInstance().mgr->SendTextMsg(wxid, msg);
    nlohmann::json ret_data = {
        {"code", success}, {"data", {}}, {"msg", "success"}};
    ret = ret_data.dump();
    return ret;
  } else if (mg_http_match_uri(hm, "/api/hookSyncMsg")) {
    int port = GetIntParam(j_param, "port");
    std::string ip = GetStringParam(j_param, "ip");
    int enable = GetIntParam(j_param, "enableHttp");
    std::string url = "";
    int timeout = 0;
    if (enable) {
      url = GetStringParam(j_param, "url");
      timeout = GetIntParam(j_param, "timeout");
    }
    INT64 success =
        wxhelper::hooks::HookSyncMsg(ip, port, url, timeout, enable);
    nlohmann::json ret_data = {
        {"code", success}, {"data", {}}, {"msg", "success"}};
    ret = ret_data.dump();
    return ret;
  }
  // ...
}
```
æ”¶åˆ°è¯¥è¯·æ±‚åæ ¸å¿ƒæ˜¯è°ƒç”¨äº† wxhelper::hooks::HookSyncMsg å‡½æ•°ã€‚å¯ä»¥å‘ç° HookSyncMsg å‡½æ•°ä¸­å‡ºç°äº†å…³é”®çš„DetourAttach ç³»ç»Ÿè°ƒç”¨
```cpp
// src/hooks.cc

int HookSyncMsg(std::string client_ip, int port, std::string url,
                uint64_t timeout, bool enable) {
  if (kMsgHookFlag) {
    SPDLOG_INFO("recv msg hook already called");
    return 2;
  }
  kEnableHttp = enable;
  if (kEnableHttp) {
    HttpClient::GetInstance().SetConfig(url, timeout);
  }
  if (client_ip.size() < 1) {
    return -2;
  }

  kServerPort = port;
  strcpy_s(kServerIp, client_ip.c_str());
  UINT64 base = Utils::GetWeChatWinBase();
  if (!base) {
    SPDLOG_INFO("base addr is null");
    return -1;
  }

  DetourRestoreAfterWith();
  DetourTransactionBegin();
  DetourUpdateThread(GetCurrentThread());
  UINT64 do_add_msg_addr = base + offset::kDoAddMsg;
  DetourAttach(&(PVOID&)R_DoAddMsg, &HandleSyncMsg);
  LONG ret = DetourTransactionCommit();
  if(ret == NO_ERROR){
    kMsgHookFlag = true;
  }
  return ret;
}
```
> DetourAttach æ˜¯ Windows å¹³å°ä¸Šçš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒæ˜¯å¾®è½¯ç ”ç©¶é™¢å¼€å‘çš„ Detours åº“ä¸­çš„ä¸€éƒ¨åˆ†ã€‚Detours åº“æä¾›äº†ä¸€ç§ç”¨äºä¿®æ”¹å’Œé‡å®šå‘å‡½æ•°è°ƒç”¨çš„æŠ€æœ¯ï¼Œå¸¸ç”¨äºå®ç°å‡½æ•°çš„é’©å­å’Œå‡½æ•°çš„åŠ¨æ€ä¿®æ”¹ã€‚
DetourAttach å‡½æ•°çš„ä½œç”¨æ˜¯å°†ä¸€ä¸ªç›®æ ‡å‡½æ•°çš„åœ°å€ä¸ä¸€ä¸ªè‡ªå®šä¹‰çš„å›è°ƒå‡½æ•°å…³è”èµ·æ¥ï¼Œä»è€Œåœ¨ç›®æ ‡å‡½æ•°è¢«è°ƒç”¨æ—¶æ‰§è¡Œå›è°ƒå‡½æ•°ã€‚å…·ä½“æ¥è¯´ï¼ŒDetourAttach å‡½æ•°ä¼šä¿®æ”¹ç›®æ ‡å‡½æ•°çš„ä»£ç ï¼Œä½¿å…¶åœ¨æ‰§è¡Œå‰è°ƒç”¨æŒ‡å®šçš„å›è°ƒå‡½æ•°ã€‚DetourAttach å‡½æ•°çš„åŸå‹å¦‚ä¸‹:
```c
LONG DetourAttach(PVOID *ppPointer, PVOID pDetour);
```
ç°åœ¨æ€»ç®—æ˜ç™½äº†, åŸæ¥æ˜¯é€šè¿‡ DetourAttach ç³»ç»Ÿè°ƒç”¨æŠŠå¾®ä¿¡æ”¶åˆ°æ¶ˆæ¯çš„å¤„ç†å‡½æ•° R_DoAddMsg ç»™ä»£ç†äº†, ä¹Ÿå°±æ˜¯æŠŠ R_DoAddMsg è°ƒç”¨é‡å®šå‘ä¸ºäº† HandleSyncMsg, è€Œ HandleSyncMsg å‡½æ•°é‡Œå°±å¯ä»¥å†™ä½ çš„ä¸šåŠ¡é€»è¾‘, æœ€å HandleSyncMsg çš„å°¾éƒ¨è°ƒç”¨ä¸€ä¸‹å¾®ä¿¡çš„åŸå§‹å¤„ç†å‡½æ•° R_DoAddMsg å³å¯

ç”¨ JavaScript è§£é‡Š DetourAttach çš„è¡Œä¸ºå°±æ˜¯
```js
const rawHandler = wx.R_DoAddMsg
const newHandler = (...args) => {
    // do something
    rawFuc()
}
wx.R_DoAddMsg = newHandler
```
æœ€åçš„ä¸€ä¸ªå…³é”®ç‚¹å°±æ˜¯å¦‚ä½•è·å–å¾®ä¿¡åŸæœ¬çš„å¤„ç†å‡½æ•° R_DoAddMsg çš„åœ°å€, å¯ä»¥çœ‹åˆ° R_DoAddMsg åœ°å€å…¶å®å°±æ˜¯è¯¥ dll çš„åœ°å€ GetWeChatWinBase() + ä¹‹å‰é€šè¿‡é€†å‘æ‰‹æ®µè·å–åˆ°çš„è¯¥å‡½æ•°çš„åç§»é‡ offset::kDoAddMsg
```cpp
// src/hooks.cc

static UINT64 (*R_DoAddMsg)(UINT64, UINT64, UINT64) = (UINT64(*)(
    UINT64, UINT64, UINT64))(Utils::GetWeChatWinBase() + offset::kDoAddMsg);
```
è·å–è¯¥ dll çš„åœ°å€æ ¸å¿ƒæ˜¯ GetModuleHandleA ç³»ç»Ÿè°ƒç”¨
```cpp
// src/utils.cc

UINT64 Utils::GetWeChatWinBase() {
  return (UINT64)GetModuleHandleA("WeChatWin.dll");
}
```
> GetModuleHandleA æ˜¯ Windows å¹³å°ä¸Šçš„ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºè·å–æŒ‡å®šæ¨¡å—çš„å¥æŸ„ï¼ˆhandleï¼‰ã€‚è·å–åˆ°çš„æ¨¡å—å¥æŸ„å¯ä»¥ç”¨äºåç»­çš„æ“ä½œï¼Œä¾‹å¦‚è·å–æ¨¡å—ä¸­çš„å‡½æ•°åœ°å€ã€ä¿®æ”¹æ¨¡å—ä¸­çš„æ•°æ®ç­‰ã€‚å‡½æ•°åŸå‹å¦‚ä¸‹:
```c
HMODULE GetModuleHandleA(LPCSTR lpModuleName);
```
è‡³äºå¦‚ä½•è·å–å…³é”® Call çš„åç§»é‡è§ä¸Šé¢æåˆ°çš„ [wxhelper/wiki](https://github.com/ttttupup/wxhelper/wiki) æ–‡æ¡£
