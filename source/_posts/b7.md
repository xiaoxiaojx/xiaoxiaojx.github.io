---
title: è®°ä¸€æ¬¡ Next.js æ ·å¼å¼‚å¸¸çš„æ’æŸ¥ä¸ pr ä¿®å¤
date: 2022/11/02
description: å¼€å‘åŒå­¦åé¦ˆ Next.js é¡¹ç›® next dev å‘½ä»¤å¯åŠ¨åæµè§ˆå™¨è®¿é—®é¡µé¢ css æ ·å¼æœ‰ä¸¢å¤±
tag: SSR
author: å¤šå°å‡¯
---

## é—®é¢˜ç®€è¿°
![](https://user-images.githubusercontent.com/23253540/199200650-85f5596d-66d8-45dd-8d4b-3c65071aaed6.png)
å¼€å‘åŒå­¦åé¦ˆ Next.js é¡¹ç›® next dev å‘½ä»¤å¯åŠ¨åæµè§ˆå™¨è®¿é—®é¡µé¢ css æ ·å¼æœ‰ä¸¢å¤±ï¼Œè¡¨ç°ä¸º style æ ‡ç­¾çš„å†…å®¹ä¸æ˜¯ css æ ·å¼è€Œæ˜¯ä¸€ä¸ª url ğŸ˜¨
```html
<style>/_next/static/media/globals.23a96686.css</style>
```
é¢å¯¹è¿™ä¸ªç•¥æ˜¾å¥‡è‘©çš„é—®é¢˜è¯¥å¦‚ä½•æ’æŸ¥äº† ?

## é—®é¢˜æ’æŸ¥
### Step1 ç¡®è®¤æ˜¯å¦é…ç½®äº†é”™è¯¯çš„ loader
* åˆ†æ: ç»™ css æ–‡ä»¶è®¾ç½®é”™äº† loader é€ æˆç»“æœä¸ç¬¦åˆé¢„æœŸä¹Ÿè¯´å¾—è¿‡å»
* ç»“è®º: âŒ æ²¡æœ‰å‘ç°å¯ç–‘çš„ loader, ç»è¿‡æŸ¥çœ‹ webpackConfig å‘ç°ä¼šå‘½ä¸­çº¢åœˆ oneOf æ•°ç»„ç´¢å¼•ä¸º 6 çš„è§„åˆ™, å³ css æ–‡ä»¶ä¼šä¾æ¬¡è¢« postcss-loader > css-loader > next-style-loader æ¥ä¾æ¬¡å¤„ç†, çœ‹ä¸Šå»æ²¡æœ‰ä»»ä½•é—®é¢˜

![image](https://user-images.githubusercontent.com/23253540/199277342-3d4c27bf-f3c8-4f57-a7dd-27f4e0d662fd.png)

> [Rule.oneOf](https://webpack.js.org/configuration/module/#ruleoneof) : An array of Rules from which only the first matching Rule is used when the Rule matches.

åŒæ—¶æ ¹æ® Rule.oneOf çš„å®šä¹‰ç¡®è®¤äº†åªä¼šä» oneOf æ•°ç»„ä¸­æ‰¾åˆ°ä¸€ä¸ªåŒ¹é…åˆ°çš„è§„åˆ™å°±ä¼šåœæ­¢, é‚£ä¹ˆ loader åº”è¯¥æ˜¯éƒ½è¢«æ­£ç¡®è®¾ç½®äº†

### Step2 å¤„ç† css æ–‡ä»¶çš„ loader æœ‰ bug ?
* åˆ†æ: ç¡®è®¤äº†æ²¡æœ‰å¥‡æ€ªçš„ loader æºæ‚è¿›æ¥, é‚£ä¹ˆæ˜¯ä¸æ˜¯å‘½ä¸­çš„ loader æœ‰ bug äº†
* ç»“è®º: âœ… æœç„¶æœ‰ bug

loader æ­£å¸¸æ˜¯æŒ‰ä»ä¸‹åˆ°ä¸Š, ä»å³åˆ°å·¦çš„é¡ºåºæ‰§è¡Œ, å³å¦‚ä¸Šé…ç½®ä¼šæŒ‰ä» postcss-loader > css-loader > next-style-loader æ¥ä¾æ¬¡å¤„ç†ã€‚

```js
// packages/next/build/webpack/loaders/next-style-loader/index.js

import path from 'path'
import isEqualLocals from './runtime/isEqualLocals'
import { stringifyRequest } from '../../stringify-request'

const loaderApi = () => {}

loaderApi.pitch = function loader(request) {
// ...
}

module.exports = loaderApi
```
ä½†æ˜¯ç”±äº next-style-loader å¯¼å‡ºäº† pitch å±æ€§, loader çš„é¡ºåºå°†ä¼šå˜æˆé¦–å…ˆè¿è¡Œ pitch å‡½æ•°, ç›¸å…³æ–‡æ¡£è§ [Pitching Loader](https://webpack.js.org/api/loaders/#pitching-loader)
```bash
|- next-style-loader `pitch`
      |- requested module is picked up as a dependency
    |- postcss-loader normal execution
  |- css-loader normal execution
|- next-style-loader normal execution
```
é‚£ä¹ˆæˆ‘ä»¬å…ˆä» next-style-loader çš„ pitch å‡½æ•°å¼€å§‹æ’æŸ¥, ç„¶åå‘ç°äº†å¦‚ä¸‹è¯­å¥
```js
// packages/next/build/webpack/loaders/next-style-loader/index.js

var content = require(${stringifyRequest(this, `!!${request}`)});
```
ä¸Šé¢è¯­å¥è¡¥å……ä¸Šå˜é‡çš„å€¼åç›¸å½“äºå¦‚ä¸‹
```js
var content = require('!!xxx/css-loader/src/index.js??xxx/postcss-loader/src/index.js??ruleSet[1].rules[3].oneOf[6].use[2]!./globals.css')
```
â™»ï¸ è¿™é‡Œçš„ä¾èµ–å…³ç³»å…ˆç®€å•ç†ä¸€ä¸‹, æ¯”å¦‚ _app.tsx å¼•ç”¨äº† globals.css
```js
// pages/_app.tsx

import '../styles/globals.css'
```
globals.css æ¨¡å—çš„å†…å®¹è¢« next-style-loader å¤„ç†åçš„å†…å®¹ç±»ä¼¼äºä¸‹é¢è¿™æ ·
```js
// styles/globals.css

var content = require('!!xxx/css-loader/src/index.js??xxx/postcss-loader/src/index.js??ruleSet[1].rules[3].oneOf[6].use[2]!./globals.css')

const style = document.createElement('style');
style.appendChild(document.createTextNode(content));
document.head.append(style)
```
æ‰€ä»¥ style æ ‡ç­¾é‡Œé¢çš„ content çš„æºå¤´å…¶å®æ˜¯ require çš„ !!xxx/css-loader/src/index.js??xxx/postcss-loader/src/index.js??ruleSet[1].rules[3].oneOf[6].use[2]!./globals.css æ¨¡å—æä¾›

```js
// !!xxx/css-loader/src/index.js??xxx/postcss-loader/src/index.js??ruleSet[1].rules[3].oneOf[6].use[2]!./globals.css

module.exports = ?
```

é‚£ä¹ˆå¯¹äº !!xxx/css-loader/src/index.js??xxx/postcss-loader/src/index.js??ruleSet[1].rules[3].oneOf[6].use[2]!./globals.css è¿™ä¸ªè·¯å¾„ä¸Šå¸¦æœ‰ loader çš„æ¨¡å—å…¶æ–‡ä»¶åç¼€ä¾ç„¶ä¸º .css, é‚£ä¹ˆä¸è¿˜å¾—å‘½ä¸­ oneOf æ•°ç»„ç´¢å¼•ä¸º 6 çš„è§„åˆ™ä¹ˆ ğŸ¤” ?

ç»è¿‡ debug webpack çš„ä»£ç å‘ç°ç»“æœæ˜¯æ„å¤–çš„ âŒ, å®ƒå‘½ä¸­çš„æ˜¯ oneOf æ•°ç»„ç´¢å¼•ä¸º 8 çš„è§„åˆ™
![image](https://user-images.githubusercontent.com/23253540/199278617-be6d6cfc-bde7-4035-b11f-1da0fb97e7a6.png)

> [Rule.issuer](https://webpack.js.org/configuration/module/#ruleissuer): A Condition to match against the module that issued the request. In the following example, the issuer for the a.js request would be the path to the index.js file.

> å…³äº Rule.issuer: æ¯”å¦‚ pages/_app.tsx æ–‡ä»¶é‡Œé¢ import æˆ–è€… require äº† globals.css, é‚£ä¹ˆå¯¹äº globals.css è€Œè¨€, å®ƒçš„ issuer ä¸º pages/_app.tsx
 
è®©æˆ‘ä»¬å›å¤´æŸ¥çœ‹ä¸€ä¸‹ä¸ºä»€ä¹ˆæ²¡æœ‰å‘½ä¸­ç´¢å¼•ä¸º 6 çš„è§„åˆ™, å‘ç°ç´¢å¼•ä¸º 6 è§„åˆ™éå¸¸é‡è¦çš„ä¸€ç‚¹æ˜¯è¦æ±‚å¼•ç”¨è¯¥æ–‡ä»¶çš„ issuer å¿…é¡»åªèƒ½æ˜¯ pages/_app.tsx, è§ä¸‹å›¾çº¢åœˆçš„ issuer.and å­—æ®µ

![image](https://user-images.githubusercontent.com/23253540/199280476-6e978a9b-26c8-4e9e-b86d-9bf34d01a3ad.png)

è€Œ !!xxx/css-loader/src/index.js??xxx/postcss-loader/src/index.js??ruleSet[1].rules[3].oneOf[6].use[2]!./globals.css æ¨¡å—å…¶å®æ˜¯è¢« next-style-loader ä»£ç†åçš„ globals.css æ‰€ require, æ‰€ä»¥å®ƒçš„ issuer ç«Ÿç„¶ä¸º styles/globals.css ğŸ¤¯

è‡³æ­¤ !!xxx/css-loader/src/index.js??xxx/postcss-loader/src/index.js??ruleSet[1].rules[3].oneOf[6].use[2]!./globals.css æ¨¡å—ç»è¿‡ postcss-loader > css-loader å¤„ç†å, æœ€åè¿˜è¦è¢« webpack å†…ç½®çš„æ–‡ä»¶ç±»å‹ asset/resource å¤„ç†ï¼ˆç›¸å½“äº file-loaderï¼‰, æœ€ç»ˆå¤„ç†å®Œæˆå®ƒçš„ module.exports å…¶å®ä¸ºå¦‚ä¸‹ğŸ‘‡
```js
// '!!xxx/css-loader/src/index.js??xxx/postcss-loader/src/index.js??ruleSet[1].rules[3].oneOf[6].use[2]!./globals.css'

module.exports = "/_next/static/media/globals.23a96686.css"
```
æ‰€ä»¥è¢« next-style-loader å¤„ç†åçš„ styles/globals.css æ¨¡å—æœ€å append äº†ä¸€ä¸ª url å­—ç¬¦ä¸²åˆ°äº† style æ ‡ç­¾ä¸­é€ æˆäº†æœ¬æ¬¡ css æ ·å¼çš„å¼‚å¸¸ !!!
```js
// styles/globals.css

var content = require('!!xxx/css-loader/src/index.js??xxx/postcss-loader/src/index.js??ruleSet[1].rules[3].oneOf[6].use[2]!./globals.css')

const style = document.createElement('style');
style.appendChild(document.createTextNode(content));
document.head.append(style)
```

## ç–‘æƒ‘è§£ç­”
### ä¸ºä»€ä¹ˆ Rule.oneOf è²Œä¼¼ pick äº†å¤šæ¬¡è§„åˆ™?
å¯¹äº styles/globals.css æ¨¡å—è€Œè¨€åªé€‰æ‹©äº†ä¸€æ¬¡å³ oneOf æ•°ç»„ç´¢å¼•ä¸º 6 çš„è§„åˆ™, è€Œç»è¿‡ next-style-loader çš„ä»£ç†ä¿®æ”¹åçš„ require è¯­å¥åˆäº§ç”Ÿäº†æ–°çš„æ¨¡å— !!xxx/css-loader/src/index.js??xxx/postcss-loader/src/index.js??ruleSet[1].rules[3].oneOf[6].use[2]!./globals.css, äºæ˜¯æ–°çš„æ¨¡å—åˆè¿›è¡Œäº†ä¸€æ¬¡è§„åˆ™ pick, æ‰€ä»¥å¹¶ä¸ç®—è¿èƒŒäº† Rule.oneOf çš„å®šä¹‰
![image](https://user-images.githubusercontent.com/23253540/199288932-e4aade71-1f44-45d3-b220-64a53e829df6.png)
> å³ä¾¿æ–°çš„æ¨¡å—åˆå‘½ä¸­äº† oneOf æ•°ç»„ç´¢å¼•ä¸º 6 çš„è§„åˆ™, ç”±äºæ–°çš„æ¨¡å—è·¯å¾„å‰ç¼€å·²ç»åŒ…å«äº† postcss-loader ä¸ css-loader ä¹Ÿä¼šå› ä¸ºå¦‚ä¸Šå›¾çº¢åœˆçš„ if æ¡ä»¶åˆ¤æ–­ä¸æ»¡è¶³è€Œä¸ä¼šè¢«æ·»åŠ é‡å¤çš„ loader

### Next.js çš„ oneOf æ•°ç»„ç´¢å¼•ä¸º 8 çš„è§„åˆ™çœŸå®æ„å›¾æ˜¯å¹²ä»€ä¹ˆçš„?
æ ¹æ®å¦‚ä¸‹ Next.js å¯¹åº”çš„ä»£ç å¯çŸ¥, Next.js çš„é¢„æœŸæ˜¯ issuer ä¸º *.css çš„æ¨¡å—å°†è¦è¢« asset/resourceï¼ˆç±»ä¼¼äº file-loader) ç»™å¤„ç†, æ¯”å¦‚ globals.css æœ‰ä¸€è¡Œä»£ç ä¸º background-image: url("./xxx.png"), é‚£ä¹ˆæ­¤æ—¶ xxx.png å°±è¦è¢« asset/resource ç»™å¤„ç†

```js
// next/dist/build/webpack/config/blocks/css/index.js

markRemovable({
    // This should only be applied to CSS files
    issuer: regexLikeCss,
    // Exclude extensions that webpack handles by default
    exclude: [
        /\.(js|mjs|jsx|ts|tsx)$/,
        /\.html$/,
        /\.json$/,
        /\.webpack\[[^\]]+\]$/, 
    ],
    // `asset/resource` always emits a URL reference, where `asset`
    // might inline the asset as a data URI
    type: 'asset/resource'
}), 
```
## é—®é¢˜è§£å†³
Next.js æ²¡æƒ³åˆ°è¢« next-style-loader ä¿®æ”¹åè¿˜å­˜åœ¨ .css æ–‡ä»¶ require .css æ–‡ä»¶çš„æƒ…å†µ, .css æ–‡ä»¶è¢« asset/resource å¤„ç†åè¿”å›ä¸€ä¸ª url å°±å¯¼è‡´äº†æœ¬æ¬¡çš„ bug ğŸ›

å…¶å® .css ä¸­ require çš„å›¾ç‰‡ã€å­—ä½“ç­‰æ–‡ä»¶è¢« asset/resource å¤„ç†æ˜¯ç¬¦åˆé¢„æœŸ, å¦‚æœè¢« require çš„æ˜¯ .css æ–‡ä»¶å°±å¾—æ’é™¤, æ›´å¤šè§[next.js/pull/42283](https://github.com/vercel/next.js/pull/42283) ä¸ [webpack/pull/16477](https://github.com/webpack/webpack/pull/16477)
```diff
            issuer: regexLikeCss,
            // Exclude extensions that webpack handles by default
            exclude: [
+              /\.(css|sass|scss)$/,
              /\.(js|mjs|jsx|ts|tsx)$/,
              /\.html$/,
              /\.json$/,
```