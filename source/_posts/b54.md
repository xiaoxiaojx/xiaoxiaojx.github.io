---
title: Chrome Renderer è¿›ç¨‹ CPU å ç”¨ 100% æ’æŸ¥ (ä¸Š)
date: 2024/11/16
tag: C++
author: å¤šå°å‡¯
---

![image](https://github.com/user-attachments/assets/c209f87d-6301-4d19-ba63-a4ade5a6aa91)

## èƒŒæ™¯
è¿™å‡ å¤©åœ¨è°ƒè¯•æŸä¸ªè¯¦æƒ…é¡µæ—¶, æ¯å½“æˆ‘æ‰“å¼€ Chrome Devtool æ—¶é¡µé¢å°±ç«‹é©¬ä¼šå¡æ­», å¤§çº¦è¿‡äº†3åˆ†é’Ÿååˆèƒ½æ¢å¤å“åº”ã€‚å¡æ­»çš„æ—¶å€™è¿è¡Œ`top`å‘½ä»¤æŸ¥çœ‹ CPU è´Ÿè½½æƒ…å†µå¦‚ä¸Šå›¾æ‰€ç¤º`Google Chrome Helper (Renderer)`è¿›ç¨‹è¾¾åˆ°äº† 100% âš ï¸

## é—®é¢˜æ’æŸ¥
å¦‚ä¸Šå›¾å¯ä»¥çœ‹åˆ°å†…å­˜å ç”¨æ­£å¸¸ä¸”æ²¡æœ‰ä¸€ç›´å¢åŠ æ’é™¤äº†å†…å­˜æ³„æ¼çš„å¯èƒ½, ç„¶åæ‰“å¼€ Mac æ´»åŠ¨ç›‘è§†å™¨æ‰¾åˆ°è¯¥è¿›ç¨‹çš„`æ‰“å¼€çš„æ–‡ä»¶å’Œç«¯å£`é¢æ¿å‘ç°ä¹Ÿå¹¶æ²¡æœ‰å ç”¨è¿‡å¤šçš„æ–‡ä»¶å¥æŸ„æ’æŸ¥äº†æ–‡ä»¶å¥æŸ„æ³„æ¼çš„å¯èƒ½æ€§

### ä½¿ç”¨ lldb

#### Chrome
ä¸€å¼€å§‹ç›´æ¥å‡†å¤‡ä½¿ç”¨ lldb è¿›å…¥è¯¥è¿›ç¨‹, ä¸å‡ºæ„å¤–å¤±è´¥äº†, æ­£å¼ç‰ˆæœ¬ Chrome å¯ä¸èƒ½è½»æ˜“è¢«è°ƒè¯•
```bash
âœ  sudo lldb -p 69951
(lldb) process attach --pid 69951
error: attach failed: attach failed (Not allowed to attach to process.  Look in the console messages (Console.app), near the debugserver entries, when the attach failed.  The subsystem that denied the attach permission will likely have logged an informative message about why it was denied.)
```

#### Chromium
å¥½åœ¨ Chromium ä¹Ÿèƒ½é¡ºåˆ©å¤ç°è¯¥é—®é¢˜, ç»§ç»­ä½¿ç”¨ lldb è¿›å…¥è¯¥è¿›ç¨‹ã€‚ç»“æœå¦‚ä¸‹å›¾è™½ç„¶èƒ½å¤Ÿè°ƒè¯•ä½†æ˜¾ç¤ºçš„éƒ½æ˜¯æ¯«æ— ä»·å€¼çš„æ‰§è¡Œå †æ ˆ...

![image](https://github.com/user-attachments/assets/4a3b5a85-3beb-4c3b-8b7d-156306d12a14)

æ¥ç€ lldb ä¸­è¿è¡Œ`process save-core ./g.core`å‘½ä»¤ç”Ÿæˆ coredump æ–‡ä»¶ä¹Ÿæ²¡æœ‰å‘ç°çº¿ç´¢ï¼ˆä¾ç¨€è®°å¾—ä¸Šä¸€æ¬¡ Chrome CPU å ç”¨ 100% æ—¶å°±æ˜¯åœ¨ coredump æ–‡ä»¶ä¸­å‘ç°äº† React æŸä¸ªä»£ç ç‰‡æ®µé‡å¤äº† 3000+æ¬¡, æœ€åå®šä½åˆ°äº†æ˜¯ä½ç‰ˆæœ¬ React å¼€å‘ç¯å¢ƒçš„ä¸€ä¸ª bugï¼‰



### ä½¿ç”¨ Instruments (Xcode)
åœ¨ lldb è°ƒè¯•ä¸ä¹è§‚çš„æƒ…å†µä¸‹, è¯¢é—®äº†ä¸€ä¸‹ ChatGPT è¯´å¯ä»¥ä½¿ç”¨ Xcode çš„ Instruments å·¥å…·è¿›è¡Œåˆ†æã€‚è¯¥å·¥å…·çš„ä½¿ç”¨ååˆ†åƒæˆ‘ä»¬ç†Ÿæ‚‰çš„ Chrome Devtool Performance é¢æ¿, é¦–å…ˆç‚¹å‡»å¼€å§‹è®°å½•ç„¶åå†åœæ­¢å°±èƒ½æ‹¿åˆ°ç«ç„°å›¾

ğŸ¤” å‘ç°äº†å¯ç–‘çº¿ç´¢ã€‚å¦‚ä¸‹å›¾ä¸­`Call Tree`å¯ä»¥çœ‹åˆ°æœ€ååœç•™åœ¨é‡å¤è¿è¡Œäº†è‹¥å¹²æ¬¡`0x10e0e4ea8`åœ°å€çš„å‡½æ•°, çŒœæƒ³è¿›ç¨‹å¯èƒ½é™·å…¥äº†æŸç§æ­»å¾ªç¯æˆ–è€…å› ä¸ºä»€ä¹ˆæ¡ä»¶é™·åœ¨äº†è¯¥å‡½æ•°æ²¡æœ‰èƒ½ç»§ç»­è¿è¡Œä¸‹å»
![image](https://github.com/user-attachments/assets/769beb94-c38e-47a1-b4d0-d4418bb95ebf)

### ç¼–è¯‘ Chromium
ç»å†äº†ä¸Šé¢ lldb ä¸ Instruments çš„å°è¯•å‘ç°è°ƒè¯•ç”Ÿäº§ç‰ˆæœ¬çš„ App æ€»ä¼šå› ä¸ºå®‰å…¨é—®é¢˜æˆ–è€…è°ƒè¯•ä¿¡æ¯çš„ç¼ºå¤±è€Œæ— æ³•å®šä½åˆ°æœ€ç»ˆçš„åŸå› , æ²¡åŠæ³•åªèƒ½å†³å®šå°è¯•æœ¬æœºç¼–è¯‘ä¸€ä¸ª debug ç‰ˆæœ¬çš„ Chromium

âš ï¸ ç¼–è¯‘ Chromium å‰ä½ éœ€è¦æ…é‡ç¡®å®šä¸¤ä»¶äº‹

1. ç”µè„‘å…·å¤‡è®¿é—®å¤–ç½‘çš„èƒ½åŠ›ï¼ˆä¸‹è½½ Google çš„å·¥å…·é“¾éƒ½éœ€è¦ç¿»å¢™ï¼‰
2. ç”µè„‘ç³»ç»Ÿè¾ƒæ–°ï¼ˆæˆ‘é¦–æ¬¡ç¼–è¯‘æ˜¯ MacOS 12.x ç¼–è¯‘å‡ºé”™æŸ¥äº†ä¸€ä¸‹æ˜¯ SDK ç¼ºå¤±ï¼Œæœ€åèŠ±äº† 2å°æ—¶å‡çº§åˆ°äº† 15.xï¼‰

æœ€åå°±å¯ä»¥æŒ‰ç…§ [Building Chromium for Mac](https://chromium.googlesource.com/chromium/src/+/main/docs/mac_build_instructions.md) æ–‡æ¡£è¿›è¡Œæ“ä½œäº†ã€‚å› ä¸ºä¹‹å‰ç¼–è¯‘è¿‡ v8, æœ¬æ¬¡å°±çœå»äº†é‡æ–°ä¸‹è½½ Google çš„å·¥å…·é“¾ä¸é…ç½®ç¯å¢ƒçš„æ—¶é—´, å³ä½¿è¿™æ ·ä»…ä¸‹è½½æœ€æ–°æ²¡æœ‰ git history çš„ Chromium ä¸ç¼–è¯‘ Chromium ä»ç„¶èŠ±äº†æ¥è¿‘ 5ä¸ªå°æ—¶...

#### ç¼–è¯‘ debug åŒ…
å¦‚ä¸‹å›¾å°±è¡¨ç¤ºç¼–è¯‘æˆåŠŸäº†
![image](https://github.com/user-attachments/assets/c69dc330-ef83-4608-8beb-1a57cb2e09f7)

#### è¿è¡Œ debug åŒ…
æ¥ç€å¯ä»¥è¿è¡Œåˆšæ‰ç¼–è¯‘æˆåŠŸçš„ debug åŒ…, å¦‚ä¸‹å›¾ä¸­å¯ä»¥çœ‹åˆ° Chromium è‡ªå·±çš„è¿è¡Œæ—¥å¿—ä¸åŠ è½½çš„ [taobao.com](https://www.taobao.com/) ç½‘é¡µä¸­ JS çš„ `console.log` ç­‰éƒ½ä¼šå‡ºç°åœ¨ç»ˆç«¯çš„æ—¥å¿—ä¸­

<img width="1309" alt="image" src="https://github.com/user-attachments/assets/379c0399-d1ec-4ec4-a02a-71e17601ec1e">

## é—®é¢˜æµ®ç°
å¥½åœ¨ debug ç‰ˆæœ¬çš„ Chromium ä¹Ÿèƒ½é¡ºåˆ©å¤ç°è¯¥é—®é¢˜, ä¾ç„¶è¿˜æ˜¯ä½¿ç”¨ lldb è¿›å…¥è¯¥è¿›ç¨‹, æ­¤æ—¶çš„æ‰§è¡Œå †æ ˆçš„ä¿¡æ¯ç»ˆäºæ˜¯å®Œæ•´çš„äº†

é€šè¿‡ä»”ç»†åˆ†æä¸‹å›¾çš„å †æ ˆå‡½æ•°è°ƒç”¨
- -> frame 10 setScriptSource çœ‹å˜é‡åå­—åº”è¯¥æ˜¯ç»™ JS Script æ ‡ç­¾ç»‘å®šæ–‡ä»¶å†…å®¹
- -> frame 9 PatchScript ç»™ JS Script å†…å®¹è¿›è¡ŒæŸç§æ›´æ–°ä¿®æ”¹æ“ä½œ?
- -> frame 7 CalculateDifference ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦ diff åä¿®æ”¹ JS Script å†…å®¹?
- -> frame 0 FindEditPath è¿™ä¸ªåº”è¯¥å°±å¯¹åº”äº†ä¹‹å‰å‘ç°çš„å¯ç–‘`0x10e0e4ea8`åœ°å€çš„å‡½æ•°


![image](https://github.com/user-attachments/assets/1a3b3d59-4692-4fe7-b7ae-3bca91959e7c)

## é—®é¢˜å®šä½
äºæ˜¯æˆ‘åœ¨æºç ä¸­å¢åŠ äº† 2 è¡Œä»£ç , çœ‹çœ‹å…·ä½“è¿™ä¸ª JS Script æœ‰ä½•ç‰¹æ®Šä¹‹å¤„?
![image](https://github.com/user-attachments/assets/bf8b5e2b-bdce-44cb-b7af-1eabf6902ab8)
ç„¶åå†ç¼–è¯‘ä¸è¿è¡Œ Chromium, å‘ç° JS Script å†…å®¹å·²ç»æ­£å¸¸è¢«æ‰“å°äº†å‡ºæ¥, å†…å®¹çš„æœ€åä¸€è¡Œæ˜¯ sourcemap çš„åœ°å€ä¹Ÿå°±çŸ¥é“äº†è¯¥ JS çš„æ–‡ä»¶åä¸º detail.js
![image](https://github.com/user-attachments/assets/0b04f9ee-be87-4bd8-944b-29e720b2c38c)

## é—®é¢˜ç»“è®º
å›æƒ³äº†ä¸€ä¸‹ detail.js çš„å”¯ä¸€ç‰¹æ®Šä¹‹å¤„å°±æ˜¯ä¹‹å‰å› ä¸ºè¦å¤ç°é—®é¢˜ Overrides äº†è¯¥æ–‡ä»¶çš„éƒ¨åˆ†ä»£ç ï¼Œè¿™ä¹Ÿè¯´æ˜äº†ä¸Šé¢çš„å †æ ˆ PatchScript ä¸ºä»€ä¹ˆåœ¨ç»™ JS Script å†…å®¹è¿›è¡ŒæŸç§æ›´æ–°ä¿®æ”¹æ“ä½œ

ä¸ºäº†è¯å®çŒœæƒ³äºæ˜¯å–æ¶ˆäº†å‹¾é€‰`Enable Local Overrides`, å‘ç°å¡æ­»é—®é¢˜ä¸å†å¤ç°, é—®é¢˜å¾—åˆ°è§£å†³ âœ… ã€‚è‡³äºä¸ºä»€ä¹ˆå‹¾é€‰äº†ä¼šé€ æˆé—®é¢˜å°±å¾—æ·±å…¥åˆ†æ FindEditPath å‡½æ•°çš„ä»£ç äº†, To be continued...

![image](https://github.com/user-attachments/assets/4189f967-43a9-47e6-922e-057ade10f7fa)
